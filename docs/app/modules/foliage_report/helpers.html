<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.1"/>
    <title>app.modules.foliage_report.helpers API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../foliage_report.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;app.modules.foliage_report</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#LeyLiebig">LeyLiebig</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LeyLiebig.__init__">LeyLiebig</a>
                        </li>
                        <li>
                                <a class="variable" href="#LeyLiebig.nutrientes">nutrientes</a>
                        </li>
                        <li>
                                <a class="variable" href="#LeyLiebig.demanda_planta">demanda_planta</a>
                        </li>
                        <li>
                                <a class="function" href="#LeyLiebig.calcular_p">calcular_p</a>
                        </li>
                        <li>
                                <a class="function" href="#LeyLiebig.calcular_i">calcular_i</a>
                        </li>
                        <li>
                                <a class="function" href="#LeyLiebig.calcular_r">calcular_r</a>
                        </li>
                        <li>
                                <a class="function" href="#LeyLiebig.calcular_nutriente_limite">calcular_nutriente_limite</a>
                        </li>
                        <li>
                                <a class="function" href="#LeyLiebig.calcular_nutrientes">calcular_nutrientes</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#NutrientOptimizer">NutrientOptimizer</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#NutrientOptimizer.__init__">NutrientOptimizer</a>
                        </li>
                        <li>
                                <a class="variable" href="#NutrientOptimizer.nutrientes_actuales">nutrientes_actuales</a>
                        </li>
                        <li>
                                <a class="variable" href="#NutrientOptimizer.demandas_ideales">demandas_ideales</a>
                        </li>
                        <li>
                                <a class="variable" href="#NutrientOptimizer.productos_contribuciones">productos_contribuciones</a>
                        </li>
                        <li>
                                <a class="variable" href="#NutrientOptimizer.coeficientes_variacion">coeficientes_variacion</a>
                        </li>
                        <li>
                                <a class="variable" href="#NutrientOptimizer.nutrientes">nutrientes</a>
                        </li>
                        <li>
                                <a class="variable" href="#NutrientOptimizer.productos">productos</a>
                        </li>
                        <li>
                                <a class="function" href="#NutrientOptimizer.calcular_ajustes">calcular_ajustes</a>
                        </li>
                        <li>
                                <a class="function" href="#NutrientOptimizer.identificar_limitante">identificar_limitante</a>
                        </li>
                        <li>
                                <a class="function" href="#NutrientOptimizer.optimizar_productos">optimizar_productos</a>
                        </li>
                        <li>
                                <a class="function" href="#NutrientOptimizer.generar_recomendacion">generar_recomendacion</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#calcular_cv_nutriente">calcular_cv_nutriente</a>
            </li>
            <li>
                    <a class="function" href="#determinar_coeficientes_variacion">determinar_coeficientes_variacion</a>
            </li>
            <li>
                    <a class="function" href="#contribuciones_de_producto">contribuciones_de_producto</a>
            </li>
            <li>
                    <a class="class" href="#ObjectiveResource">ObjectiveResource</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ObjectiveResource.get_objective_list">get_objective_list</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CropResponse">CropResponse</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CropResponse.__init__">CropResponse</a>
                        </li>
                        <li>
                                <a class="variable" href="#CropResponse.crop_data">crop_data</a>
                        </li>
                        <li>
                                <a class="function" href="#CropResponse.get_json">get_json</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CropObjectives">CropObjectives</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CropObjectives.__init__">CropObjectives</a>
                        </li>
                        <li>
                                <a class="variable" href="#CropObjectives.objectives">objectives</a>
                        </li>
                        <li>
                                <a class="function" href="#CropObjectives.get">get</a>
                        </li>
                        <li>
                                <a class="function" href="#CropObjectives.all">all</a>
                        </li>
                        <li>
                                <a class="function" href="#CropObjectives.get_json">get_json</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CropData">CropData</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CropData.__init__">CropData</a>
                        </li>
                        <li>
                                <a class="variable" href="#CropData.nutrient_data">nutrient_data</a>
                        </li>
                        <li>
                                <a class="function" href="#CropData.get_json">get_json</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#LeafAnalysisResource">LeafAnalysisResource</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LeafAnalysisResource.get_leaf_analysis_list">get_leaf_analysis_list</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#LeafAnalysisResponse">LeafAnalysisResponse</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LeafAnalysisResponse.__init__">LeafAnalysisResponse</a>
                        </li>
                        <li>
                                <a class="variable" href="#LeafAnalysisResponse.analysis_data">analysis_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#LeafAnalysisResponse.common_analysis_id">common_analysis_id</a>
                        </li>
                        <li>
                                <a class="function" href="#LeafAnalysisResponse.get_json">get_json</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CommonAnalysisContainer">CommonAnalysisContainer</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CommonAnalysisContainer.__init__">CommonAnalysisContainer</a>
                        </li>
                        <li>
                                <a class="variable" href="#CommonAnalysisContainer.analysis_data">analysis_data</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#LeafAnalyses">LeafAnalyses</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LeafAnalyses.__init__">LeafAnalyses</a>
                        </li>
                        <li>
                                <a class="variable" href="#LeafAnalyses.analyses">analyses</a>
                        </li>
                        <li>
                                <a class="function" href="#LeafAnalyses.get">get</a>
                        </li>
                        <li>
                                <a class="function" href="#LeafAnalyses.all">all</a>
                        </li>
                        <li>
                                <a class="function" href="#LeafAnalyses.get_json">get_json</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#LeafAnalysisData">LeafAnalysisData</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LeafAnalysisData.__init__">LeafAnalysisData</a>
                        </li>
                        <li>
                                <a class="variable" href="#LeafAnalysisData.nutrient_data">nutrient_data</a>
                        </li>
                        <li>
                                <a class="function" href="#LeafAnalysisData.get_json">get_json</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ReportView">ReportView</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#ReportView.decorators">decorators</a>
                        </li>
                        <li>
                                <a class="function" href="#ReportView.get">get</a>
                        </li>
                        <li>
                                <a class="variable" href="#ReportView.methods">methods</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="variable" href="#nutrient_names_map">nutrient_names_map</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../../app.html">app</a><wbr>.<a href="./../../modules.html">modules</a><wbr>.<a href="./../foliage_report.html">foliage_report</a><wbr>.helpers    </h1>

                
                        <input id="mod-helpers-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-helpers-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="c1"># Python standard library imports</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">ROUND_HALF_UP</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">statistics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stdev</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="c1"># Third party imports</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">linprog</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">current_app</span> 
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask.views</span><span class="w"> </span><span class="kn">import</span> <span class="n">MethodView</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">flask_jwt_extended</span><span class="w"> </span><span class="kn">import</span> <span class="n">jwt_required</span><span class="p">,</span> <span class="n">get_jwt</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Forbidden</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="c1"># Local application imports</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.modules.foliage.models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a>    <span class="n">CommonAnalysis</span><span class="p">,</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a>    <span class="n">LeafAnalysis</span><span class="p">,</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a>    <span class="n">Lot</span><span class="p">,</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a>    <span class="n">LotCrop</span><span class="p">,</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a>    <span class="n">Objective</span><span class="p">,</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a>    <span class="n">Nutrient</span><span class="p">,</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a>    <span class="n">ProductContribution</span><span class="p">,</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a>    <span class="n">leaf_analysis_nutrients</span><span class="p">,</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a>    <span class="n">product_contribution_nutrients</span><span class="p">,</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a>    <span class="n">objective_nutrients</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="p">)</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.modules.foliage.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Recommendation</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.modules.foliage.controller</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProductContributionView</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.modules.foliage.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">macronutrients</span><span class="p">,</span> <span class="n">micronutrients</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">db</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">app.core.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">RoleEnum</span><span class="p">,</span> <span class="n">ResellerPackage</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LeyLiebig</span><span class="p">:</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="sd">    Clase que implementa la Ley del Mínimo de Liebig para el cálculo de nutrientes en un cultivo.</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="sd">    </span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="sd">    La Ley del Mínimo establece que el crecimiento de una planta está limitado por el nutriente más escaso en relación</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="sd">    con sus necesidades, en lugar de depender de la cantidad total de nutrientes disponibles.</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="sd">    </span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="sd">    Esta clase permite evaluar el estado nutricional de un cultivo comparando los niveles actuales con la demanda ideal,</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="sd">    identificando el nutriente más limitante y proponiendo ajustes para optimizar su disponibilidad.</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nutrientes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">demanda_planta</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">):</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="sd">        Inicializa la clase con los nutrientes disponibles y la demanda ideal de la planta.</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="sd">        </span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="sd">        :param nutrientes: Diccionario con los nutrientes y sus valores actuales en el suelo.</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="sd">        :param demanda_planta: Valor total de la demanda nutricional ideal de la planta.</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes</span> <span class="o">=</span> <span class="n">nutrientes</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">demanda_planta</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">demanda_planta</span><span class="p">)</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calcular_p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valor_registro</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decimal</span><span class="p">:</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="sd">        Calcula el porcentaje de suficiencia de un nutriente con respecto a la demanda de la planta.</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="sd">        </span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="sd">        :param valor_registro: Valor actual del nutriente en el suelo.</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="sd">        :return: Porcentaje de suficiencia del nutriente con respecto a la demanda ideal.</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">demanda_planta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>            <span class="k">return</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.00&#39;</span><span class="p">)</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="n">valor_registro</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">demanda_planta</span><span class="p">)</span> <span class="o">*</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">)</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calcular_i</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mineral_p</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">mineral_cv</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decimal</span><span class="p">:</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="sd">        Calcula la cantidad de ajuste necesario para un nutriente limitante en función de su coeficiente de variación.</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="sd">        </span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a><span class="sd">        :param mineral_p: Porcentaje de suficiencia del nutriente.</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a><span class="sd">        :param mineral_cv: Coeficiente de variación del nutriente.</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a><span class="sd">        :return: Cantidad de ajuste necesaria para alcanzar el nivel óptimo.</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>        <span class="k">if</span> <span class="n">mineral_p</span> <span class="o">&gt;</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">):</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">mineral_p</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="n">mineral_cv</span> <span class="o">/</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">))</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">mineral_p</span><span class="p">)</span> <span class="o">*</span> <span class="n">mineral_cv</span> <span class="o">/</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">))</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.00&#39;</span><span class="p">),</span> <span class="n">rounding</span><span class="o">=</span><span class="n">ROUND_HALF_UP</span><span class="p">)</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calcular_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mineral_p</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">mineral_i</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decimal</span><span class="p">:</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a><span class="sd">        Determina el nivel corregido del nutriente después del ajuste.</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a><span class="sd">        </span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a><span class="sd">        :param mineral_p: Porcentaje de suficiencia del nutriente.</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a><span class="sd">        :param mineral_i: Cantidad de ajuste aplicada al nutriente.</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a><span class="sd">        :return: Nivel corregido del nutriente en el suelo.</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>        <span class="k">if</span> <span class="n">mineral_p</span> <span class="o">&gt;</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">):</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">mineral_p</span> <span class="o">-</span> <span class="n">mineral_i</span><span class="p">)</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.00&#39;</span><span class="p">),</span> <span class="n">rounding</span><span class="o">=</span><span class="n">ROUND_HALF_UP</span><span class="p">)</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">mineral_p</span> <span class="o">+</span> <span class="n">mineral_i</span><span class="p">)</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.00&#39;</span><span class="p">),</span> <span class="n">rounding</span><span class="o">=</span><span class="n">ROUND_HALF_UP</span><span class="p">)</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calcular_nutriente_limite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valores_registro</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="sd">        Identifica el nutriente más limitante según la Ley del Mínimo de Liebig.</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a><span class="sd">        </span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a><span class="sd">        El nutriente limitante es aquel que tiene el menor porcentaje de suficiencia.</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a><span class="sd">        </span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a><span class="sd">        :param valores_registro: Diccionario con los valores actuales de los nutrientes en el suelo.</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a><span class="sd">        :return: Nombre del nutriente más limitante.</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>        <span class="n">valores_p</span> <span class="o">=</span> <span class="p">{</span><span class="n">mineral</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcular_p</span><span class="p">(</span><span class="n">valor</span><span class="p">)</span> <span class="k">for</span> <span class="n">mineral</span><span class="p">,</span> <span class="n">valor</span> <span class="ow">in</span> <span class="n">valores_registro</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">valores_p</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">valores_p</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>  <span class="c1"># Devuelve el nutriente con el menor porcentaje de suficiencia</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calcular_nutrientes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valores_registro</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">valores_cv</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a><span class="sd">        Calcula los ajustes necesarios para los nutrientes del cultivo.</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a><span class="sd">        </span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a><span class="sd">        La corrección se aplica únicamente al nutriente más limitante para respetar la Ley del Mínimo de Liebig.</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a><span class="sd">        </span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a><span class="sd">        :param valores_registro: Diccionario con los valores actuales de los nutrientes en el suelo.</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a><span class="sd">        :param valores_cv: Diccionario con los coeficientes de variación de cada nutriente.</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a><span class="sd">        :return: Diccionario con los valores de suficiencia (p), ajuste necesario (i) y nivel corregido (r) de cada nutriente.</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>        <span class="n">nutriente_limitante</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcular_nutriente_limite</span><span class="p">(</span><span class="n">valores_registro</span><span class="p">)</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>        <span class="n">nutrientes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>        <span class="k">for</span> <span class="n">mineral</span><span class="p">,</span> <span class="n">valor_registro</span> <span class="ow">in</span> <span class="n">valores_registro</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcular_p</span><span class="p">(</span><span class="n">valor_registro</span><span class="p">)</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcular_i</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">valores_cv</span><span class="p">[</span><span class="n">mineral</span><span class="p">])</span> <span class="k">if</span> <span class="n">mineral</span> <span class="o">==</span> <span class="n">nutriente_limitante</span> <span class="k">else</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.00&#39;</span><span class="p">)</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcular_r</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>            <span class="n">nutrientes</span><span class="p">[</span><span class="n">mineral</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">}</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>        <span class="k">return</span> <span class="n">nutrientes</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">ROUND_HALF_UP</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">linprog</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a><span class="k">class</span><span class="w"> </span><span class="nc">NutrientOptimizer</span><span class="p">:</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a><span class="sd">    Clase que optimiza la aplicación de productos para satisfacer los requerimientos de nutrientes de un cultivo,</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="sd">    basada en la Ley del Mínimo de Liebig y programación lineal.</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nutrientes_actuales</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">],</span> <span class="n">demandas_ideales</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">],</span> 
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>                 <span class="n">productos_contribuciones</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]],</span> <span class="n">coeficientes_variacion</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]):</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a><span class="sd">        Inicializa el optimizador de nutrientes.</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a><span class="sd">        :param nutrientes_actuales: Diccionario con los niveles actuales de nutrientes (kg/ha o g/ha).</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a><span class="sd">        :param demandas_ideales: Diccionario con los niveles ideales de nutrientes (kg/ha o g/ha).</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a><span class="sd">        :param productos_contribuciones: Diccionario con los productos y sus contribuciones por nutriente.</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a><span class="sd">        :param coeficientes_variacion: Diccionario con los coeficientes de variación por nutriente.</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes_actuales</span> <span class="o">=</span> <span class="n">nutrientes_actuales</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">demandas_ideales</span> <span class="o">=</span> <span class="n">demandas_ideales</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">productos_contribuciones</span> <span class="o">=</span> <span class="n">productos_contribuciones</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeficientes_variacion</span> <span class="o">=</span> <span class="n">coeficientes_variacion</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">demandas_ideales</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">productos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">productos_contribuciones</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calcular_ajustes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]:</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a><span class="sd">        Calcula los ajustes necesarios para cada nutriente usando la Ley de Liebig adaptada.</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>        <span class="n">ajustes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>        <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes</span><span class="p">:</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>            <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes_actuales</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nutriente</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">))</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>            <span class="n">ideal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">demandas_ideales</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>            <span class="k">if</span> <span class="n">actual</span> <span class="o">&lt;</span> <span class="n">ideal</span><span class="p">:</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>                <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">actual</span> <span class="o">/</span> <span class="n">ideal</span><span class="p">)</span> <span class="o">*</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.0&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">ideal</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="p">((</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.0&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeficientes_variacion</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span> <span class="o">/</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.0&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.00&#39;</span><span class="p">),</span> <span class="n">rounding</span><span class="o">=</span><span class="n">ROUND_HALF_UP</span><span class="p">)</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>                <span class="n">ajustes</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ideal</span> <span class="o">-</span> <span class="n">actual</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span>  <span class="c1"># Cantidad absoluta a ajustar</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>                <span class="n">ajustes</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>        <span class="k">return</span> <span class="n">ajustes</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">identificar_limitante</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a><span class="sd">        Identifica el nutriente más limitante según la Ley de Liebig.</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>        <span class="n">porcentajes</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>            <span class="n">nutriente</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nutrientes_actuales</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nutriente</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">demandas_ideales</span><span class="p">[</span><span class="n">nutriente</span><span class="p">])</span> <span class="o">*</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.0&#39;</span><span class="p">)</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">demandas_ideales</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>            <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>        <span class="p">}</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">porcentajes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">porcentajes</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_solucion_heuristica</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ajustes_positivos</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]:</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Solución heurística cuando la optimización falla&quot;&quot;&quot;</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Aplicando solución heurística...&quot;</span><span class="p">)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>        <span class="n">cantidades</span> <span class="o">=</span> <span class="p">{</span><span class="n">prod</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">}</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>        
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>        <span class="k">for</span> <span class="n">nutriente</span><span class="p">,</span> <span class="n">requerido</span> <span class="ow">in</span> <span class="n">ajustes_positivos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>            <span class="c1"># Encontrar el producto más eficiente para este nutriente</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>            <span class="n">mejor_producto</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>            <span class="n">mejor_eficiencia</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>            
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>            <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">:</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>                <span class="n">contrib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos_contribuciones</span><span class="p">[</span><span class="n">prod</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nutriente</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">))</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>                <span class="k">if</span> <span class="n">contrib</span> <span class="o">&gt;</span> <span class="n">mejor_eficiencia</span><span class="p">:</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>                    <span class="n">mejor_eficiencia</span> <span class="o">=</span> <span class="n">contrib</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>                    <span class="n">mejor_producto</span> <span class="o">=</span> <span class="n">prod</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>            
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>            <span class="k">if</span> <span class="n">mejor_producto</span> <span class="ow">and</span> <span class="n">mejor_eficiencia</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>                <span class="n">cantidad_necesaria</span> <span class="o">=</span> <span class="n">requerido</span> <span class="o">/</span> <span class="n">mejor_eficiencia</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>                <span class="n">cantidades</span><span class="p">[</span><span class="n">mejor_producto</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cantidades</span><span class="p">[</span><span class="n">mejor_producto</span><span class="p">],</span> <span class="n">cantidad_necesaria</span><span class="p">)</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Heurística: </span><span class="si">{</span><span class="n">mejor_producto</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">cantidad_necesaria</span><span class="si">}</span><span class="s2"> para </span><span class="si">{</span><span class="n">nutriente</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>        
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>        <span class="k">return</span> <span class="n">cantidades</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">optimizar_productos</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]]:</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Iniciando optimización de productos...&quot;</span><span class="p">)</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">:</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No products available for optimization. Cannot generate recommendation.&quot;</span><span class="p">)</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>            
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>            <span class="n">ajustes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcular_ajustes</span><span class="p">()</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ajustes calculados:&quot;</span><span class="p">,</span> <span class="n">ajustes</span><span class="p">)</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>            
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>            <span class="c1"># Filtrar solo ajustes positivos (nutrientes que necesitan ser agregados)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>            <span class="n">ajustes_positivos</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ajustes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>            
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">ajustes_positivos</span><span class="p">:</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No hay nutrientes que necesiten ser agregados.&quot;</span><span class="p">)</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>                <span class="k">return</span> <span class="p">{</span><span class="n">prod</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">},</span> \
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>                       <span class="p">{</span><span class="n">nutriente</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes</span><span class="p">}</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>            
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nutrientes a optimizar: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">ajustes_positivos</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>            
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>            <span class="c1"># Verificar que hay productos que pueden aportar los nutrientes necesarios</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>            <span class="n">productos_utiles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>            <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="n">ajustes_positivos</span><span class="p">:</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>                <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">:</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos_contribuciones</span><span class="p">[</span><span class="n">prod</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nutriente</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>                        <span class="n">productos_utiles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">prod</span><span class="p">)</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>            
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">productos_utiles</span><span class="p">:</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No hay productos que puedan aportar los nutrientes necesarios.&quot;</span><span class="p">)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Los productos disponibles no pueden satisfacer los requerimientos nutricionales.&quot;</span><span class="p">)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>            
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Productos útiles: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">productos_utiles</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>            
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>            <span class="c1"># Coeficientes de la función objetivo (minimizar la suma de productos)</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Definiendo función objetivo...&quot;</span><span class="p">)</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>            <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">)</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Coeficientes de la función objetivo:&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>            
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>            <span class="c1"># Matriz de restricciones de desigualdad (A_ub * x &gt;= b_ub)</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>            <span class="c1"># Para linprog necesitamos A_ub * x &lt;= b_ub, así que usamos -A_ub * x &lt;= -b_ub</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Definiendo restricciones de desigualdad...&quot;</span><span class="p">)</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>            <span class="n">A_ub</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>            <span class="n">b_ub</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>            
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>            <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="n">ajustes_positivos</span><span class="p">:</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restricción para </span><span class="si">{</span><span class="n">nutriente</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>                <span class="n">fila</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>                <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">:</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>                    <span class="n">contrib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos_contribuciones</span><span class="p">[</span><span class="n">prod</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nutriente</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">))</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>                    <span class="n">fila</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">contrib</span><span class="p">))</span>  <span class="c1"># Negativo para convertir &gt;= en &lt;=</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>                
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>                <span class="c1"># Solo agregar restricción si al menos un producto puede aportar este nutriente</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">fila</span><span class="p">):</span>  <span class="c1"># Al menos una contribución positiva</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>                    <span class="n">A_ub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fila</span><span class="p">)</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>                    <span class="n">b_ub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">ajustes_positivos</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]))</span>  <span class="c1"># Negativo para convertir &gt;= en &lt;=</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coeficientes de la restricción: </span><span class="si">{</span><span class="n">fila</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valor de la restricción: </span><span class="si">{</span><span class="n">b_ub</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Advertencia: No hay productos que aporten </span><span class="si">{</span><span class="n">nutriente</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>            
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">A_ub</span><span class="p">:</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No se pudieron formar restricciones válidas&quot;</span><span class="p">)</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>                <span class="n">cantidades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solucion_heuristica</span><span class="p">(</span><span class="n">ajustes_positivos</span><span class="p">)</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz de restricciones:&quot;</span><span class="p">,</span> <span class="n">A_ub</span><span class="p">)</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Valores de las restricciones:&quot;</span><span class="p">,</span> <span class="n">b_ub</span><span class="p">)</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>                
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>                <span class="c1"># Límites (cantidades &gt;= 0)</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Definiendo límites...&quot;</span><span class="p">)</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">)</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Límites:&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>                
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>                <span class="c1"># Resolver optimización</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resolviendo problema de programación lineal...&quot;</span><span class="p">)</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>                <span class="n">res</span> <span class="o">=</span> <span class="n">linprog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">A_ub</span><span class="o">=</span><span class="n">A_ub</span><span class="p">,</span> <span class="n">b_ub</span><span class="o">=</span><span class="n">b_ub</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;highs&#39;</span><span class="p">)</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultado de la optimización:&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>                
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error en la optimización:&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intentando con método alternativo...&quot;</span><span class="p">)</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>                    
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>                    <span class="c1"># Intentar con método alternativo</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>                    <span class="n">res</span> <span class="o">=</span> <span class="n">linprog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">A_ub</span><span class="o">=</span><span class="n">A_ub</span><span class="p">,</span> <span class="n">b_ub</span><span class="o">=</span><span class="n">b_ub</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;interior-point&#39;</span><span class="p">)</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>                    
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error con método alternativo:&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>                        
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>                        <span class="c1"># Como último recurso, intentar relajar las restricciones</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intentando con restricciones relajadas...&quot;</span><span class="p">)</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>                        <span class="c1"># Reducir los requerimientos en un 20%</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>                        <span class="n">b_ub_relajado</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="o">*</span> <span class="mf">0.8</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">b_ub</span><span class="p">]</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>                        <span class="n">res</span> <span class="o">=</span> <span class="n">linprog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">A_ub</span><span class="o">=</span><span class="n">A_ub</span><span class="p">,</span> <span class="n">b_ub</span><span class="o">=</span><span class="n">b_ub_relajado</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;highs&#39;</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>                        
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización falló completamente: </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>                            <span class="n">cantidades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solucion_heuristica</span><span class="p">(</span><span class="n">ajustes_positivos</span><span class="p">)</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>                            <span class="n">cantidades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_procesar_resultado_optimizacion</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>                        <span class="n">cantidades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_procesar_resultado_optimizacion</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>                    <span class="n">cantidades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_procesar_resultado_optimizacion</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>            
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cantidades de productos:&quot;</span><span class="p">,</span> <span class="n">cantidades</span><span class="p">)</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>            
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>            <span class="c1"># Calcular nutrientes aportados</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculando nutrientes aportados...&quot;</span><span class="p">)</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>            <span class="n">nutrientes_aportados</span> <span class="o">=</span> <span class="p">{</span><span class="n">nutriente</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes</span><span class="p">}</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>            <span class="k">for</span> <span class="n">prod</span><span class="p">,</span> <span class="n">cantidad</span> <span class="ow">in</span> <span class="n">cantidades</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>                <span class="k">if</span> <span class="n">cantidad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>                    <span class="k">for</span> <span class="n">nutriente</span><span class="p">,</span> <span class="n">contrib</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos_contribuciones</span><span class="p">[</span><span class="n">prod</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>                        <span class="n">nutrientes_aportados</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span> <span class="o">+=</span> <span class="n">contrib</span> <span class="o">*</span> <span class="n">cantidad</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>            
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Nutrientes aportados:&quot;</span><span class="p">,</span> <span class="n">nutrientes_aportados</span><span class="p">)</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>            
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>            <span class="c1"># Verificar que se cumplan los requerimientos mínimos</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Verificando cumplimiento de requerimientos...&quot;</span><span class="p">)</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>            <span class="k">for</span> <span class="n">nutriente</span><span class="p">,</span> <span class="n">requerido</span> <span class="ow">in</span> <span class="n">ajustes_positivos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>                <span class="n">aportado</span> <span class="o">=</span> <span class="n">nutrientes_aportados</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nutriente</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">))</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>                <span class="n">cumplimiento</span> <span class="o">=</span> <span class="p">(</span><span class="n">aportado</span> <span class="o">/</span> <span class="n">requerido</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">requerido</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.0&#39;</span><span class="p">)</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nutriente</span><span class="si">}</span><span class="s2">: Requerido=</span><span class="si">{</span><span class="n">requerido</span><span class="si">}</span><span class="s2">, Aportado=</span><span class="si">{</span><span class="n">aportado</span><span class="si">}</span><span class="s2">, Cumplimiento=</span><span class="si">{</span><span class="n">cumplimiento</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>            
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>            <span class="k">return</span> <span class="n">cantidades</span><span class="p">,</span> <span class="n">nutrientes_aportados</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>            
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error en la optimización:&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>            <span class="k">raise</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_procesar_resultado_optimizacion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]:</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Procesa el resultado de la optimización lineal&quot;&quot;&quot;</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>        <span class="c1"># Verificar que la solución no sea trivial (todos ceros)</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">1e-6</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">):</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;La solución es trivial (todos los valores son cero)&quot;</span><span class="p">)</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>            <span class="k">return</span> <span class="p">{</span><span class="n">prod</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">}</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>        
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>        <span class="c1"># Resultados: cantidades de productos</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculando cantidades de productos...&quot;</span><span class="p">)</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>        <span class="n">cantidades</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">):</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>            <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>  <span class="c1"># Solo incluir cantidades significativas</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>                <span class="n">cantidades</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>                <span class="n">cantidades</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>        
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>        <span class="k">return</span> <span class="n">cantidades</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generar_recomendacion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lot_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a><span class="sd">        Genera una recomendación para aplicar en el lote.</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a><span class="sd">        </span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a><span class="sd">        :param lot_id: ID del lote donde se aplicará la recomendación.</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a><span class="sd">        :return: Texto de la recomendación.</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>            <span class="n">cantidades</span><span class="p">,</span> <span class="n">nutrientes_aportados</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizar_productos</span><span class="p">()</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>            
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>            <span class="n">lineas</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Aplicar en el lote </span><span class="si">{</span><span class="n">lot_id</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">]</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>            
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>            <span class="c1"># Solo mostrar productos con cantidades significativas</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>            <span class="n">productos_aplicar</span> <span class="o">=</span> <span class="p">{</span><span class="n">prod</span><span class="p">:</span> <span class="n">cant</span> <span class="k">for</span> <span class="n">prod</span><span class="p">,</span> <span class="n">cant</span> <span class="ow">in</span> <span class="n">cantidades</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">cant</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>            
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">productos_aplicar</span><span class="p">:</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>                <span class="n">lineas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;- No se requiere aplicación de productos adicionales&quot;</span><span class="p">)</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>                <span class="k">for</span> <span class="n">prod</span><span class="p">,</span> <span class="n">cantidad</span> <span class="ow">in</span> <span class="n">productos_aplicar</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>                    <span class="n">lineas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">cantidad</span><span class="si">}</span><span class="s2"> unidades de </span><span class="si">{</span><span class="n">prod</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>            
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>            <span class="n">lineas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Nutrientes aportados:&quot;</span><span class="p">)</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>            <span class="k">for</span> <span class="n">nutriente</span><span class="p">,</span> <span class="n">cantidad</span> <span class="ow">in</span> <span class="n">nutrientes_aportados</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>                <span class="k">if</span> <span class="n">cantidad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Solo mostrar nutrientes con aporte significativo</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>                    <span class="c1"># Asumiendo que tienes acceso a macronutrients, sino puedes ajustar esta lógica</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>                    <span class="n">unidad</span> <span class="o">=</span> <span class="s2">&quot;kg/ha&quot;</span>  <span class="c1"># Puedes ajustar esto según tu lógica de negocio</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>                    <span class="n">lineas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">nutriente</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cantidad</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unidad</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>            
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lineas</span><span class="p">)</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>            
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generando recomendación: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error al generar recomendación para el lote </span><span class="si">{</span><span class="n">lot_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a><span class="c1"># # # Datos de ejemplo basados en los nutrientes proporcionados</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a><span class="c1"># macronutrients = [</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a><span class="c1">#     {&quot;name&quot;: &quot;Nitrógeno&quot;, &quot;symbol&quot;: &quot;N&quot;, &quot;unit&quot;: &quot;kg/ha&quot;, &quot;category&quot;: &quot;MACRONUTRIENT&quot;},</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a><span class="c1">#     {&quot;name&quot;: &quot;Fósforo&quot;, &quot;symbol&quot;: &quot;P&quot;, &quot;unit&quot;: &quot;kg/ha&quot;, &quot;category&quot;: &quot;MACRONUTRIENT&quot;},</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a><span class="c1">#     {&quot;name&quot;: &quot;Potasio&quot;, &quot;symbol&quot;: &quot;K&quot;, &quot;unit&quot;: &quot;kg/ha&quot;, &quot;category&quot;: &quot;MACRONUTRIENT&quot;},</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a><span class="c1">#     {&quot;name&quot;: &quot;Calcio&quot;, &quot;symbol&quot;: &quot;Ca&quot;, &quot;unit&quot;: &quot;kg/ha&quot;, &quot;category&quot;: &quot;MACRONUTRIENT&quot;},</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a><span class="c1">#     {&quot;name&quot;: &quot;Magnesio&quot;, &quot;symbol&quot;: &quot;Mg&quot;, &quot;unit&quot;: &quot;kg/ha&quot;, &quot;category&quot;: &quot;MACRONUTRIENT&quot;},</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a><span class="c1">#     {&quot;name&quot;: &quot;Azufre&quot;, &quot;symbol&quot;: &quot;S&quot;, &quot;unit&quot;: &quot;kg/ha&quot;, &quot;category&quot;: &quot;MACRONUTRIENT&quot;},</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a><span class="c1"># ]</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a><span class="c1"># micronutrients = [</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a><span class="c1">#     {&quot;name&quot;: &quot;Cobre&quot;, &quot;symbol&quot;: &quot;Cu&quot;, &quot;unit&quot;: &quot;g/ha&quot;, &quot;category&quot;: &quot;MICRONUTRIENT&quot;},</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a><span class="c1">#     {&quot;name&quot;: &quot;Zinc&quot;, &quot;symbol&quot;: &quot;Zn&quot;, &quot;unit&quot;: &quot;g/ha&quot;, &quot;category&quot;: &quot;MICRONUTRIENT&quot;},</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a><span class="c1">#     {&quot;name&quot;: &quot;Manganeso&quot;, &quot;symbol&quot;: &quot;Mn&quot;, &quot;unit&quot;: &quot;g/ha&quot;, &quot;category&quot;: &quot;MICRONUTRIENT&quot;},</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a><span class="c1">#     {&quot;name&quot;: &quot;Boro&quot;, &quot;symbol&quot;: &quot;B&quot;, &quot;unit&quot;: &quot;g/ha&quot;, &quot;category&quot;: &quot;MICRONUTRIENT&quot;},</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a><span class="c1">#     {&quot;name&quot;: &quot;Molibdeno&quot;, &quot;symbol&quot;: &quot;Mo&quot;, &quot;unit&quot;: &quot;g/ha&quot;, &quot;category&quot;: &quot;MICRONUTRIENT&quot;},</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a><span class="c1">#     {&quot;name&quot;: &quot;Cloro&quot;, &quot;symbol&quot;: &quot;Cl&quot;, &quot;unit&quot;: &quot;g/ha&quot;, &quot;category&quot;: &quot;MICRONUTRIENT&quot;},</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a><span class="c1">#     {&quot;name&quot;: &quot;Hierro&quot;, &quot;symbol&quot;: &quot;Fe&quot;, &quot;unit&quot;: &quot;g/ha&quot;, &quot;category&quot;: &quot;MICRONUTRIENT&quot;},</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a><span class="c1">#     {&quot;name&quot;: &quot;Silicio&quot;, &quot;symbol&quot;: &quot;Si&quot;, &quot;unit&quot;: &quot;kg/ha&quot;, &quot;category&quot;: &quot;MICRONUTRIENT&quot;},</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a><span class="c1"># ]</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a><span class="c1"># # Ejemplo de uso</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a><span class="c1"># nutrientes_actuales = {</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a><span class="c1">#     &quot;Nitrógeno&quot;: Decimal(&quot;50.0&quot;),  # kg/ha</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="c1">#     &quot;Fósforo&quot;: Decimal(&quot;20.0&quot;),    # kg/ha</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a><span class="c1">#     &quot;Potasio&quot;: Decimal(&quot;80.0&quot;),    # kg/ha</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a><span class="c1">#     &quot;Cobre&quot;: Decimal(&quot;100.0&quot;),     # g/ha</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a><span class="c1">#     &quot;Zinc&quot;: Decimal(&quot;50.0&quot;)        # g/ha</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a><span class="c1"># }</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a><span class="c1"># demandas_ideales = {</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a><span class="c1">#     &quot;Nitrógeno&quot;: Decimal(&quot;100.0&quot;),  # kg/ha</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a><span class="c1">#     &quot;Fósforo&quot;: Decimal(&quot;50.0&quot;),     # kg/ha</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a><span class="c1">#     &quot;Potasio&quot;: Decimal(&quot;90.0&quot;),     # kg/ha</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a><span class="c1">#     &quot;Cobre&quot;: Decimal(&quot;150.0&quot;),      # g/ha</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a><span class="c1">#     &quot;Zinc&quot;: Decimal(&quot;80.0&quot;)         # g/ha</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a><span class="c1"># }</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a><span class="c1"># productos_contribuciones = {</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a><span class="c1">#     &quot;Fertilizante A&quot;: {&quot;Nitrógeno&quot;: Decimal(&quot;10.0&quot;), &quot;Fósforo&quot;: Decimal(&quot;5.0&quot;), &quot;Potasio&quot;: Decimal(&quot;2.0&quot;)},</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a><span class="c1">#     &quot;Fertilizante B&quot;: {&quot;Nitrógeno&quot;: Decimal(&quot;5.0&quot;), &quot;Fósforo&quot;: Decimal(&quot;15.0&quot;), &quot;Cobre&quot;: Decimal(&quot;20.0&quot;)},</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a><span class="c1">#     &quot;Fertilizante C&quot;: {&quot;Zinc&quot;: Decimal(&quot;30.0&quot;), &quot;Cobre&quot;: Decimal(&quot;10.0&quot;)}</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a><span class="c1"># }</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a><span class="c1"># coeficientes_variacion = {</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a><span class="c1">#     &quot;Nitrógeno&quot;: Decimal(&quot;0.5&quot;),</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a><span class="c1">#     &quot;Fósforo&quot;: Decimal(&quot;0.3&quot;),</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a><span class="c1">#     &quot;Potasio&quot;: Decimal(&quot;0.4&quot;),</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a><span class="c1">#     &quot;Cobre&quot;: Decimal(&quot;0.2&quot;),</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a><span class="c1">#     &quot;Zinc&quot;: Decimal(&quot;0.25&quot;)</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a><span class="c1"># }</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a><span class="c1"># # Instanciar y usar la clase</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a><span class="c1"># optimizador = NutrientOptimizer(nutrientes_actuales, demandas_ideales, productos_contribuciones, coeficientes_variacion)</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a><span class="c1"># limitante = optimizador.identificar_limitante()</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a><span class="c1"># print(f&quot;Nutriente limitante: {limitante}&quot;)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a><span class="c1"># recomendacion = optimizador.generar_recomendacion(lot_id=1)</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a><span class="c1"># print(recomendacion)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a><span class="k">def</span><span class="w"> </span><span class="nf">calcular_cv_nutriente</span><span class="p">(</span><span class="n">lot_id</span><span class="p">,</span> <span class="n">nutriente_name</span><span class="p">):</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Determinar los Coeficientes de Variación &quot;&quot;&quot;</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>    <span class="c1"># Obtener valores históricos de LeafAnalysis para el lote</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>    <span class="n">valores</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">leaf_analysis_nutrients</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LeafAnalysis</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CommonAnalysis</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>        <span class="n">CommonAnalysis</span><span class="o">.</span><span class="n">lot_id</span> <span class="o">==</span> <span class="n">lot_id</span><span class="p">,</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>        <span class="n">leaf_analysis_nutrients</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">nutrient_id</span> <span class="o">==</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">nutriente_name</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>    <span class="n">valores</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">valores</span><span class="p">]</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valores</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>        <span class="k">return</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.5&#39;</span><span class="p">)</span>  <span class="c1"># Valor por defecto si no hay suficientes datos</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>    <span class="n">mu</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">valores</span><span class="p">)</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>    <span class="n">sigma</span> <span class="o">=</span> <span class="n">stdev</span><span class="p">(</span><span class="n">valores</span><span class="p">)</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>    <span class="k">return</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sigma</span> <span class="o">/</span> <span class="n">mu</span><span class="p">))</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.01&#39;</span><span class="p">))</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a><span class="c1"># ejemplo. </span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a><span class="c1"># cv_nitrogeno = calcular_cv_nutriente(lot_id=1, nutriente_name=&quot;Nitrógeno&quot;)</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a><span class="c1"># print(f&quot;CV Nitrógeno: {cv_nitrogeno}&quot;)</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a><span class="c1"># Calculo por ajuste dinámico. </span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a><span class="c1"># Datos históricos: Calcula el CV estadístico si hay suficientes análisis previos.</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a><span class="c1"># Valores por defecto: Usa estándares agrícolas si no hay datos.</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a><span class="c1"># Ajuste dinámico: Permite que un usuario (ej., agrónomo) modifique los CV según observaciones locales.</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a><span class="k">def</span><span class="w"> </span><span class="nf">determinar_coeficientes_variacion</span><span class="p">(</span><span class="n">lot_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]:</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>    <span class="n">coeficientes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>    <span class="n">nutrientes</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">macronutrients</span> <span class="o">+</span> <span class="n">micronutrients</span><span class="p">]</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>    <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="n">nutrientes</span><span class="p">:</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>        <span class="n">cv</span> <span class="o">=</span> <span class="n">calcular_cv_nutriente</span><span class="p">(</span><span class="n">lot_id</span><span class="p">,</span> <span class="n">nutriente</span><span class="p">)</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>        <span class="k">if</span> <span class="n">cv</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.5&#39;</span><span class="p">):</span>  <span class="c1"># Valor por defecto si no hay datos</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>            <span class="c1"># Asignar valores basados en literatura</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>            <span class="k">if</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Nitrógeno&quot;</span><span class="p">]:</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>                <span class="n">cv</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.5&quot;</span><span class="p">)</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>            <span class="k">elif</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Fósforo&quot;</span><span class="p">]:</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>                <span class="n">cv</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.3&quot;</span><span class="p">)</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>            <span class="k">elif</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Potasio&quot;</span><span class="p">]:</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>                <span class="n">cv</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.4&quot;</span><span class="p">)</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>            <span class="k">elif</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Cobre&quot;</span><span class="p">,</span> <span class="s2">&quot;Zinc&quot;</span><span class="p">]:</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>                <span class="n">cv</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.25&quot;</span><span class="p">)</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>                <span class="n">cv</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.3&quot;</span><span class="p">)</span>  <span class="c1"># Default genérico</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>        <span class="n">coeficientes</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>    <span class="k">return</span> <span class="n">coeficientes</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a><span class="k">def</span><span class="w"> </span><span class="nf">contribuciones_de_producto</span><span class="p">():</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Contribuciones de producto &quot;&quot;&quot;</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>    <span class="n">product_contributions</span> <span class="o">=</span> <span class="n">ProductContribution</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>    
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>    
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>    <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">product_contributions</span><span class="p">:</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>        <span class="n">product_name</span> <span class="o">=</span> <span class="n">pc</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">name</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>        
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>        <span class="k">if</span> <span class="n">product_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>            <span class="n">result</span><span class="p">[</span><span class="n">product_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>        
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>        <span class="n">nutrient_contributions</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">product_contribution_nutrients</span><span class="p">)</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>            <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">product_contribution_id</span><span class="o">=</span><span class="n">pc</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>            <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>        <span class="p">)</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>        
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>        <span class="k">for</span> <span class="n">contribution</span> <span class="ow">in</span> <span class="n">nutrient_contributions</span><span class="p">:</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>            <span class="n">nutrient</span> <span class="o">=</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">contribution</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>            <span class="n">result</span><span class="p">[</span><span class="n">product_name</span><span class="p">][</span><span class="n">nutrient</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">contribution</span><span class="o">.</span><span class="n">contribution</span><span class="p">))</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>    
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>    <span class="k">return</span> <span class="n">result</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a><span class="c1">##################################################################</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ObjectiveResource</span><span class="p">:</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_objective_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>        <span class="n">objectives</span> <span class="o">=</span> <span class="n">Objective</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>        <span class="n">crop_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_objectives_by_crop</span><span class="p">(</span><span class="n">objectives</span><span class="p">)</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>        <span class="k">return</span> <span class="n">CropResponse</span><span class="p">(</span><span class="n">crop_data</span><span class="p">)</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_serialize_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objective</span><span class="p">):</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Serialize an Objective object to a dictionary (unchanged from your code)&quot;&quot;&quot;</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>        <span class="n">nutrient_targets</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">objective_nutrients</span><span class="p">)</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>            <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">objective_id</span><span class="o">=</span><span class="n">objective</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>            <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>        <span class="p">)</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>        <span class="n">nutrient_targets_dict</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>            <span class="p">{</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>                <span class="s2">&quot;nutrient_id&quot;</span><span class="p">:</span> <span class="n">target</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">,</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>                <span class="s2">&quot;target_value&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">target_value</span><span class="p">)),</span>  <span class="c1"># Convert to Decimal</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>                <span class="s2">&quot;nutrient_name&quot;</span><span class="p">:</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>                <span class="s2">&quot;nutrient_symbol&quot;</span><span class="p">:</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>                <span class="s2">&quot;nutrient_unit&quot;</span><span class="p">:</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>            <span class="p">}</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">nutrient_targets</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>        <span class="p">]</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">objective</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>            <span class="s2">&quot;crop_id&quot;</span><span class="p">:</span> <span class="n">objective</span><span class="o">.</span><span class="n">crop_id</span><span class="p">,</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>            <span class="s2">&quot;crop_name&quot;</span><span class="p">:</span> <span class="n">objective</span><span class="o">.</span><span class="n">crop</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>            <span class="s2">&quot;target_value&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">objective</span><span class="o">.</span><span class="n">target_value</span><span class="p">)),</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>            <span class="s2">&quot;protein&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">objective</span><span class="o">.</span><span class="n">protein</span><span class="p">)),</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>            <span class="s2">&quot;rest&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">objective</span><span class="o">.</span><span class="n">rest</span><span class="p">)),</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">objective</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>            <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">objective</span><span class="o">.</span><span class="n">updated_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>            <span class="s2">&quot;nutrient_targets&quot;</span><span class="p">:</span> <span class="n">nutrient_targets_dict</span><span class="p">,</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>        <span class="p">}</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_objectives_by_crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objectives</span><span class="p">):</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process objectives into a dictionary grouped by crop name with multiple objectives&quot;&quot;&quot;</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>        <span class="n">crop_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objectives</span><span class="p">:</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>            <span class="n">serialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_objective</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>            <span class="n">crop_name</span> <span class="o">=</span> <span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;crop_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>  <span class="c1"># e.g., &#39;arroz&#39;, &#39;papa&#39;</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>            
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>            <span class="c1"># Initialize crop entry as a list if not present</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>            <span class="k">if</span> <span class="n">crop_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">crop_dict</span><span class="p">:</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>                <span class="n">crop_dict</span><span class="p">[</span><span class="n">crop_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>            
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>            <span class="c1"># Simplify nutrient targets into a dict for easier access</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>            <span class="n">nutrient_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>                <span class="n">target</span><span class="p">[</span><span class="s2">&quot;nutrient_name&quot;</span><span class="p">]:</span> <span class="n">target</span><span class="p">[</span><span class="s2">&quot;target_value&quot;</span><span class="p">]</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>                <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;nutrient_targets&quot;</span><span class="p">]</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>            <span class="p">}</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>            <span class="c1"># Add objective data to the crop&#39;s list</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>            <span class="n">crop_dict</span><span class="p">[</span><span class="n">crop_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>                <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;created_at&quot;</span><span class="p">],</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>                <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">],</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>                <span class="s2">&quot;nutrients&quot;</span><span class="p">:</span> <span class="n">nutrient_dict</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>            <span class="p">})</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>        
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>        <span class="k">return</span> <span class="n">crop_dict</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a><span class="k">class</span><span class="w"> </span><span class="nc">CropResponse</span><span class="p">:</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom response class to allow accessing crop data like response.arroz&quot;&quot;&quot;</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crop_data</span><span class="p">):</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crop_data</span> <span class="o">=</span> <span class="n">crop_data</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>        <span class="c1"># Dynamically set attributes for each crop</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>        <span class="k">for</span> <span class="n">crop_name</span> <span class="ow">in</span> <span class="n">crop_data</span><span class="p">:</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crop_name</span><span class="p">,</span> <span class="n">CropObjectives</span><span class="p">(</span><span class="n">crop_data</span><span class="p">[</span><span class="n">crop_name</span><span class="p">]))</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the full crop data as JSON&quot;&quot;&quot;</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crop_data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a><span class="k">class</span><span class="w"> </span><span class="nc">CropObjectives</span><span class="p">:</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class to handle multiple objectives for a single crop&quot;&quot;&quot;</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objectives</span><span class="p">):</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span> <span class="o">=</span> <span class="n">objectives</span>  <span class="c1"># List of objectives for this crop</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Access a specific objective by index or id&quot;&quot;&quot;</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">:</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>                <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>                    <span class="k">return</span> <span class="n">CropData</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No objective found with id </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">):</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>                <span class="k">return</span> <span class="n">CropData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> out of range for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">)</span><span class="si">}</span><span class="s2"> objectives&quot;</span><span class="p">)</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>        <span class="c1"># Default: return the most recent objective (based on updated_at)</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>        <span class="n">sorted_objectives</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>        <span class="k">return</span> <span class="n">CropData</span><span class="p">(</span><span class="n">sorted_objectives</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all objectives as a list of CropData objects&quot;&quot;&quot;</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">CropData</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">]</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all objectives as JSON&quot;&quot;&quot;</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a><span class="k">class</span><span class="w"> </span><span class="nc">CropData</span><span class="p">:</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper class to represent nutrient data for a single objective&quot;&quot;&quot;</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nutrient_data</span><span class="p">):</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nutrient_data</span> <span class="o">=</span> <span class="n">nutrient_data</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return nutrient data as JSON&quot;&quot;&quot;</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nutrient_data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;String representation for printing&quot;&quot;&quot;</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>        <span class="k">return</span> <span class="nb">str</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutrient_data</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a><span class="c1">########################################################</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a><span class="c1"># leaf_analyses</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LeafAnalysisResource</span><span class="p">:</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_leaf_analysis_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>        <span class="n">leaf_analyses</span> <span class="o">=</span> <span class="n">LeafAnalysis</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>        
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>        <span class="c1"># Process leaf analyses into a structure grouped by common_analysis_id</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>        <span class="n">analysis_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_leaf_analyses_by_common_id</span><span class="p">(</span><span class="n">leaf_analyses</span><span class="p">)</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>        <span class="k">return</span> <span class="n">LeafAnalysisResponse</span><span class="p">(</span><span class="n">analysis_data</span><span class="p">)</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_serialize_leaf_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">leaf_analysis</span><span class="p">):</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Serializa un objeto LeafAnalysis a un diccionario.&quot;&quot;&quot;</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>        <span class="n">nutrient_values</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">leaf_analysis_nutrients</span><span class="p">)</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>            <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">leaf_analysis_id</span><span class="o">=</span><span class="n">leaf_analysis</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>            <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>        <span class="p">)</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>        <span class="n">nutrient_values_dict</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>            <span class="p">{</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>                <span class="s2">&quot;nutrient_id&quot;</span><span class="p">:</span> <span class="n">nv</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">,</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">nv</span><span class="o">.</span><span class="n">value</span><span class="p">)),</span>  <span class="c1"># Convert to Decimal</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>                <span class="s2">&quot;nutrient_name&quot;</span><span class="p">:</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nv</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>                <span class="s2">&quot;nutrient_symbol&quot;</span><span class="p">:</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nv</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>                <span class="s2">&quot;nutrient_unit&quot;</span><span class="p">:</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nv</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>            <span class="p">}</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>            <span class="k">for</span> <span class="n">nv</span> <span class="ow">in</span> <span class="n">nutrient_values</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>        <span class="p">]</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">leaf_analysis</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>            <span class="s2">&quot;common_analysis_id&quot;</span><span class="p">:</span> <span class="n">leaf_analysis</span><span class="o">.</span><span class="n">common_analysis_id</span><span class="p">,</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">leaf_analysis</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>            <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">leaf_analysis</span><span class="o">.</span><span class="n">updated_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>            <span class="s2">&quot;nutrient_values&quot;</span><span class="p">:</span> <span class="n">nutrient_values_dict</span><span class="p">,</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>        <span class="p">}</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_leaf_analyses_by_common_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">leaf_analyses</span><span class="p">):</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process leaf analyses into a dictionary grouped by common_analysis_id.&quot;&quot;&quot;</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>        <span class="n">analysis_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>        <span class="k">for</span> <span class="n">leaf_analysis</span> <span class="ow">in</span> <span class="n">leaf_analyses</span><span class="p">:</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>            <span class="n">serialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_leaf_analysis</span><span class="p">(</span><span class="n">leaf_analysis</span><span class="p">)</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>            <span class="n">common_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;common_analysis_id&quot;</span><span class="p">])</span>  <span class="c1"># Convert to string for attribute access</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>            
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>            <span class="c1"># Initialize entry as a list if not present</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>            <span class="k">if</span> <span class="n">common_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">analysis_dict</span><span class="p">:</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>                <span class="n">analysis_dict</span><span class="p">[</span><span class="n">common_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>            
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>            <span class="c1"># Simplify nutrient values into a dict</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>            <span class="n">nutrient_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>                <span class="n">nutrient</span><span class="p">[</span><span class="s2">&quot;nutrient_name&quot;</span><span class="p">]:</span> <span class="n">nutrient</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>                <span class="k">for</span> <span class="n">nutrient</span> <span class="ow">in</span> <span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;nutrient_values&quot;</span><span class="p">]</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>            <span class="p">}</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>            <span class="c1"># Add analysis data to the common_analysis_id&#39;s list</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>            <span class="n">analysis_dict</span><span class="p">[</span><span class="n">common_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>                <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;created_at&quot;</span><span class="p">],</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>                <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">],</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>                <span class="s2">&quot;nutrients&quot;</span><span class="p">:</span> <span class="n">nutrient_dict</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>            <span class="p">})</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>        
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>        <span class="k">return</span> <span class="n">analysis_dict</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LeafAnalysisResponse</span><span class="p">:</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom response class to allow accessing leaf analyses like response.common_analysis_id.&lt;id&gt;&quot;&quot;&quot;</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_data</span><span class="p">):</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_data</span> <span class="o">=</span> <span class="n">analysis_data</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>        <span class="c1"># Dynamically create a nested object for common_analysis_id</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">common_analysis_id</span> <span class="o">=</span> <span class="n">CommonAnalysisContainer</span><span class="p">(</span><span class="n">analysis_data</span><span class="p">)</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the full analysis data as JSON&quot;&quot;&quot;</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a><span class="k">class</span><span class="w"> </span><span class="nc">CommonAnalysisContainer</span><span class="p">:</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Container for accessing leaf analyses by common_analysis_id&quot;&quot;&quot;</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_data</span><span class="p">):</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_data</span> <span class="o">=</span> <span class="n">analysis_data</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>        <span class="c1"># Dynamically set attributes for each common_analysis_id</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>        <span class="k">for</span> <span class="n">common_id</span> <span class="ow">in</span> <span class="n">analysis_data</span><span class="p">:</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">common_id</span><span class="p">,</span> <span class="n">LeafAnalyses</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_data</span><span class="p">[</span><span class="n">common_id</span><span class="p">]))</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LeafAnalyses</span><span class="p">:</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class to handle multiple leaf analyses for a single common_analysis_id&quot;&quot;&quot;</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analyses</span><span class="p">):</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">analyses</span> <span class="o">=</span> <span class="n">analyses</span>  <span class="c1"># List of leaf analyses for this common_analysis_id</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Access a specific leaf analysis by index or id&quot;&quot;&quot;</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>            <span class="k">for</span> <span class="n">analysis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">:</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>                <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>                    <span class="k">return</span> <span class="n">LeafAnalysisData</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No leaf analysis found with id </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">):</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>                <span class="k">return</span> <span class="n">LeafAnalysisData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> out of range for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">)</span><span class="si">}</span><span class="s2"> analyses&quot;</span><span class="p">)</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>        <span class="c1"># Default: return the most recent analysis (based on updated_at)</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>        <span class="n">sorted_analyses</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>        <span class="k">return</span> <span class="n">LeafAnalysisData</span><span class="p">(</span><span class="n">sorted_analyses</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all analyses as a list of LeafAnalysisData objects&quot;&quot;&quot;</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">LeafAnalysisData</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">analysis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">]</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all analyses as JSON&quot;&quot;&quot;</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LeafAnalysisData</span><span class="p">:</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper class to represent nutrient data for a single leaf analysis&quot;&quot;&quot;</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nutrient_data</span><span class="p">):</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nutrient_data</span> <span class="o">=</span> <span class="n">nutrient_data</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return nutrient data as JSON&quot;&quot;&quot;</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nutrient_data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;String representation for printing&quot;&quot;&quot;</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>        <span class="k">return</span> <span class="nb">str</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutrient_data</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>    
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ReportView</span><span class="p">(</span><span class="n">MethodView</span><span class="p">):</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Clase para generar reportes integrados de análisis&quot;&quot;&quot;</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>    <span class="n">decorators</span> <span class="o">=</span> <span class="p">[</span><span class="n">jwt_required</span><span class="p">()]</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a><span class="sd">        Genera reporte completo de análisis con niveles óptimos</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a><span class="sd">        Args:</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a><span class="sd">            common_analysis_id (int): ID del análisis común a reportar</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a><span class="sd">            (NOTA: La ruta lo llama &#39;id&#39;, pero la lógica parece asumir que es un Recommendation ID)</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a><span class="sd">        Returns:</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a><span class="sd">            JSON: Estructura con datos de análisis y niveles óptimos</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>        <span class="n">recommendation_id</span> <span class="o">=</span> <span class="nb">id</span> <span class="c1"># Asumiendo que el ID es de Recommendation</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>        <span class="n">report</span> <span class="o">=</span> <span class="n">Recommendation</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="n">recommendation_id</span><span class="p">)</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_access</span><span class="p">(</span><span class="n">report</span><span class="p">)</span> <span class="c1"># Pasar el objeto &#39;report&#39; para verificar acceso</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>        <span class="c1"># --- Deserializar datos del reporte ---</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>            <span class="c1"># Usar .get(&#39;{}&#39;) para evitar errores si el campo es None</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>            <span class="n">foliar_details_str</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">foliar_analysis_details</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>            <span class="n">soil_details_str</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">soil_analysis_details</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>            <span class="n">optimal_levels_str</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">optimal_comparison</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>            <span class="n">recommendations_str</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">automatic_recommendations</span> <span class="ow">or</span> <span class="s1">&#39;[]&#39;</span> <span class="c1"># Asumir lista JSON</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>            <span class="n">foliar_details</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">foliar_details_str</span><span class="p">)</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>            <span class="n">soil_details</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">soil_details_str</span><span class="p">)</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>            <span class="n">optimal_levels</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">optimal_levels_str</span><span class="p">)</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>            <span class="n">recommendations_list</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">recommendations_str</span><span class="p">)</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>            <span class="c1"># Reconstruir analysisData (Necesita el CommonAnalysis)</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>            <span class="c1"># Tratar de obtener el common_analysis_id de los detalles deserializados</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>            <span class="n">common_analysis_id_foliar</span> <span class="o">=</span> <span class="n">foliar_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;common_analysis_id&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">foliar_details</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>            <span class="n">common_analysis_id_soil</span> <span class="o">=</span> <span class="n">soil_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;common_analysis_id&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">soil_details</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>            <span class="c1"># O obtenerlo desde el lote/fecha del reporte si no está en los detalles</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>            <span class="n">common_analysis</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>            <span class="k">if</span> <span class="n">common_analysis_id_foliar</span><span class="p">:</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>                 <span class="n">common_analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_common_analysis</span><span class="p">(</span><span class="n">common_analysis_id_foliar</span><span class="p">)</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>            <span class="k">elif</span> <span class="n">common_analysis_id_soil</span><span class="p">:</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>                 <span class="n">common_analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_common_analysis</span><span class="p">(</span><span class="n">common_analysis_id_soil</span><span class="p">)</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>            <span class="c1"># Fallback: buscar por lote y fecha si es necesario (puede ser impreciso)</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>            <span class="c1"># if not common_analysis and report.lot_id and report.date:</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>            <span class="c1">#      common_analysis = CommonAnalysis.query.filter_by(lot_id=report.lot_id, date=report.date).first()</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">common_analysis</span><span class="p">:</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>                 <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No se pudo determinar el CommonAnalysis asociado al reporte.&quot;</span><span class="p">)</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>            <span class="n">analysisData</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>                <span class="s2">&quot;common&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_common</span><span class="p">(</span><span class="n">common_analysis</span><span class="p">),</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>                <span class="s2">&quot;foliar&quot;</span><span class="p">:</span> <span class="n">foliar_details</span><span class="p">,</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>                <span class="s2">&quot;soil&quot;</span><span class="p">:</span> <span class="n">soil_details</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>            <span class="p">}</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>            <span class="c1"># Datos históricos (esto podría necesitar una consulta separada)</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>            <span class="n">historicalData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_historical_data</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">lot_id</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>            <span class="c1"># Nutriente limitante</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>            <span class="n">limitingNutrientData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_limiting_nutrient_data</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">limiting_nutrient_id</span><span class="p">,</span> <span class="n">analysisData</span><span class="p">,</span> <span class="n">optimal_levels</span><span class="p">)</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>        <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>             <span class="n">current_app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deserializando datos del reporte </span><span class="si">{</span><span class="n">recommendation_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>             <span class="c1"># Retornar un error o datos vacíos/predeterminados</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>             <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Error procesando datos del reporte&quot;</span><span class="p">}),</span> <span class="mi">500</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>        <span class="n">report_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>            <span class="s2">&quot;analysisData&quot;</span><span class="p">:</span> <span class="n">analysisData</span><span class="p">,</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>            <span class="s2">&quot;optimalLevels&quot;</span><span class="p">:</span> <span class="n">optimal_levels</span><span class="p">,</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>            <span class="s2">&quot;historicalData&quot;</span><span class="p">:</span> <span class="n">historicalData</span><span class="p">,</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>            <span class="s2">&quot;recommendations&quot;</span><span class="p">:</span> <span class="n">recommendations_list</span><span class="p">,</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>            <span class="s2">&quot;limitingNutrient&quot;</span><span class="p">:</span> <span class="n">limitingNutrientData</span><span class="p">,</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>            <span class="s2">&quot;nutrientNames&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nutrient_name_map</span><span class="p">()</span> <span class="c1"># Mapa de nombres para la plantilla</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>        <span class="p">}</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">report_data</span><span class="p">),</span> <span class="mi">200</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_common_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_id</span><span class="p">):</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtiene el análisis común con relaciones optimizadas&quot;&quot;&quot;</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>        <span class="k">return</span> <span class="n">CommonAnalysis</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="n">CommonAnalysis</span><span class="o">.</span><span class="n">lot</span><span class="p">)</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="n">Lot</span><span class="o">.</span><span class="n">farm</span><span class="p">),</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="n">CommonAnalysis</span><span class="o">.</span><span class="n">soil_analysis</span><span class="p">),</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="n">CommonAnalysis</span><span class="o">.</span><span class="n">leaf_analysis</span><span class="p">)</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="n">analysis_id</span><span class="p">)</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">common_analysis</span><span class="p">):</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Valida permisos de acceso a la organización&quot;&quot;&quot;</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>        <span class="n">claims</span> <span class="o">=</span> <span class="n">get_jwt</span><span class="p">()</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>        <span class="n">user_role</span> <span class="o">=</span> <span class="n">claims</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rol&quot;</span><span class="p">)</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>        
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>        <span class="k">if</span> <span class="n">user_role</span> <span class="o">==</span> <span class="n">RoleEnum</span><span class="o">.</span><span class="n">ADMINISTRATOR</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>            <span class="k">return</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>            
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>        <span class="k">if</span> <span class="n">user_role</span> <span class="o">==</span> <span class="n">RoleEnum</span><span class="o">.</span><span class="n">RESELLER</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>            <span class="n">org_id</span> <span class="o">=</span> <span class="n">common_analysis</span><span class="o">.</span><span class="n">organization</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">common_analysis</span><span class="o">.</span><span class="n">organization</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">org_id</span><span class="p">:</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>                <span class="k">raise</span> <span class="n">Forbidden</span><span class="p">(</span><span class="s2">&quot;No se pudo determinar la organización del análisis&quot;</span><span class="p">)</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>                
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>            <span class="n">reseller_package</span> <span class="o">=</span> <span class="n">ResellerPackage</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>                <span class="n">reseller_id</span><span class="o">=</span><span class="n">claims</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;org_id&quot;</span><span class="p">)</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>            
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">reseller_package</span> <span class="ow">or</span> <span class="n">org_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reseller_package</span><span class="o">.</span><span class="n">organization_ids</span><span class="p">:</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>                <span class="k">raise</span> <span class="n">Forbidden</span><span class="p">(</span><span class="s2">&quot;Acceso denegado al recurso&quot;</span><span class="p">)</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_analysis_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis</span><span class="p">):</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Construye la estructura principal del reporte&quot;&quot;&quot;</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>            <span class="s2">&quot;common&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_common</span><span class="p">(</span><span class="n">analysis</span><span class="p">),</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>            <span class="s2">&quot;foliar&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_foliar_data</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">leaf_analysis</span><span class="p">),</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>            <span class="s2">&quot;soil&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_soil_data</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">soil_analysis</span><span class="p">)</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>        <span class="p">}</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_serialize_common</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis</span><span class="p">):</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Serializa datos del análisis común&quot;&quot;&quot;</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>            <span class="s2">&quot;fechaAnalisis&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>            <span class="s2">&quot;finca&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">farm_name</span> <span class="k">if</span> <span class="n">analysis</span><span class="o">.</span><span class="n">lot</span> <span class="ow">and</span> <span class="n">analysis</span><span class="o">.</span><span class="n">lot</span><span class="o">.</span><span class="n">farm</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>            <span class="s2">&quot;lote&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">lot_name</span> <span class="k">if</span> <span class="n">analysis</span><span class="o">.</span><span class="n">lot</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>            <span class="s2">&quot;proteinas&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">protein</span><span class="p">,</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>            <span class="s2">&quot;descanso&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">rest</span><span class="p">,</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>            <span class="s2">&quot;diasDescanso&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">rest_days</span><span class="p">,</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>            <span class="s2">&quot;mes&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>            <span class="s2">&quot;aforo&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">yield_estimate</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>        <span class="p">}</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_foliar_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">leaf_analysis</span><span class="p">):</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtiene y formatea datos foliares&quot;&quot;&quot;</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">leaf_analysis</span><span class="p">:</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>        <span class="n">foliar_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">leaf_analysis</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>        <span class="n">nutrients</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">leaf_analysis_nutrients</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>            <span class="n">leaf_analysis_id</span><span class="o">=</span><span class="n">leaf_analysis</span><span class="o">.</span><span class="n">id</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>        <span class="k">for</span> <span class="n">nv</span> <span class="ow">in</span> <span class="n">nutrients</span><span class="p">:</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>            <span class="n">nutrient</span> <span class="o">=</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nv</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>            <span class="k">if</span> <span class="n">nutrient</span><span class="p">:</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>                <span class="n">key</span> <span class="o">=</span> <span class="n">nutrient</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>                <span class="n">foliar_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv</span><span class="o">.</span><span class="n">value</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>        <span class="k">return</span> <span class="n">foliar_data</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_soil_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soil_analysis</span><span class="p">):</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtiene y formatea datos de suelo&quot;&quot;&quot;</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">soil_analysis</span><span class="p">:</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">soil_analysis</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>            <span class="s2">&quot;energia&quot;</span><span class="p">:</span> <span class="n">soil_analysis</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>            <span class="s2">&quot;pastoreo&quot;</span><span class="p">:</span> <span class="n">soil_analysis</span><span class="o">.</span><span class="n">grazing</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>        <span class="p">}</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_lot_crop_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">common_analysis</span><span class="p">):</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtiene el cultivo activo del lote en la fecha del análisis&quot;&quot;&quot;</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">common_analysis</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">common_analysis</span><span class="o">.</span><span class="n">lot_id</span><span class="p">:</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="c1"># Buscar el cultivo activo en el rango de fechas</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="n">lot_crop</span> <span class="o">=</span> <span class="n">LotCrop</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>            <span class="n">LotCrop</span><span class="o">.</span><span class="n">lot_id</span> <span class="o">==</span> <span class="n">common_analysis</span><span class="o">.</span><span class="n">lot_id</span><span class="p">,</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>            <span class="n">LotCrop</span><span class="o">.</span><span class="n">start_date</span> <span class="o">&lt;=</span> <span class="n">common_analysis</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">or_</span><span class="p">(</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>                <span class="n">LotCrop</span><span class="o">.</span><span class="n">end_date</span> <span class="o">&gt;=</span> <span class="n">common_analysis</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>                <span class="n">LotCrop</span><span class="o">.</span><span class="n">end_date</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>            <span class="p">)</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="n">LotCrop</span><span class="o">.</span><span class="n">crop</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>        <span class="k">return</span> <span class="n">lot_crop</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_optimal_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">common_analysis</span><span class="p">):</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtiene niveles óptimos del cultivo actual&quot;&quot;&quot;</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>        <span class="n">lot_crop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lot_crop_data</span><span class="p">(</span><span class="n">common_analysis</span><span class="p">)</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">lot_crop</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">lot_crop</span><span class="o">.</span><span class="n">crop</span><span class="p">:</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>        <span class="n">objective</span> <span class="o">=</span> <span class="n">Objective</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">crop_id</span><span class="o">=</span><span class="n">lot_crop</span><span class="o">.</span><span class="n">crop</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">objective</span><span class="p">:</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>            <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>                <span class="s2">&quot;cultivo&quot;</span><span class="p">:</span> <span class="n">lot_crop</span><span class="o">.</span><span class="n">crop</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>                <span class="s2">&quot;valor_obj&quot;</span><span class="p">:</span> <span class="n">objective</span><span class="o">.</span><span class="n">target_value</span><span class="p">,</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>                <span class="s2">&quot;proteina&quot;</span><span class="p">:</span> <span class="n">objective</span><span class="o">.</span><span class="n">protein</span><span class="p">,</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>                <span class="s2">&quot;descanso&quot;</span><span class="p">:</span> <span class="n">objective</span><span class="o">.</span><span class="n">rest</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>            <span class="p">},</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>            <span class="s2">&quot;nutrientes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nutrient_targets</span><span class="p">(</span><span class="n">objective</span><span class="p">)</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>        <span class="p">}</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_nutrient_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objective</span><span class="p">):</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtiene y formatea los objetivos de nutrientes desde objective_nutrients&quot;&quot;&quot;</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>        <span class="n">targets</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>        <span class="n">obj_nutrients</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">objective_nutrients</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>            <span class="n">objective_id</span><span class="o">=</span><span class="n">objective</span><span class="o">.</span><span class="n">id</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>        <span class="k">for</span> <span class="n">on</span> <span class="ow">in</span> <span class="n">obj_nutrients</span><span class="p">:</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>            <span class="n">nutrient</span> <span class="o">=</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">on</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>            <span class="k">if</span> <span class="n">nutrient</span><span class="p">:</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>                <span class="n">key</span> <span class="o">=</span> <span class="n">nutrient</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>                <span class="n">targets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">on</span><span class="o">.</span><span class="n">target_value</span>  <span class="c1"># Usamos el target_value de objective_nutrients directamente</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>        <span class="k">return</span> <span class="n">targets</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_historical_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lot_id</span><span class="p">,</span> <span class="n">current_date</span><span class="p">):</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a><span class="w">         </span><span class="sd">&quot;&quot;&quot;Obtiene datos históricos de análisis foliares para el lote (simplificado).&quot;&quot;&quot;</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>         <span class="c1"># Consulta los últimos N análisis para el lote antes de la fecha actual</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>         <span class="n">historical_analyses</span> <span class="o">=</span> <span class="n">LeafAnalysis</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CommonAnalysis</span><span class="p">)</span>\
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>             <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">CommonAnalysis</span><span class="o">.</span><span class="n">lot_id</span> <span class="o">==</span> <span class="n">lot_id</span><span class="p">,</span> <span class="n">CommonAnalysis</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">current_date</span><span class="p">)</span>\
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>             <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">CommonAnalysis</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>\
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>             <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="c1"># Limita a 5 análisis históricos, por ejemplo</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>         <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>         <span class="k">for</span> <span class="n">analysis</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">historical_analyses</span><span class="p">):</span> <span class="c1"># Invertir para orden cronológico</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>             <span class="n">nutrients</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">leaf_analysis_nutrients</span><span class="p">)</span>\
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>                 <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">leaf_analysis_id</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>             <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fecha&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">common_analysis</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b %Y&#39;</span><span class="p">)}</span> <span class="c1"># Formato Mes Año</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>             <span class="k">for</span> <span class="n">nv</span> <span class="ow">in</span> <span class="n">nutrients</span><span class="p">:</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>                 <span class="n">nutrient</span> <span class="o">=</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nv</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>                 <span class="k">if</span> <span class="n">nutrient</span> <span class="ow">and</span> <span class="n">nutrient</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nitrogeno&#39;</span><span class="p">,</span> <span class="s1">&#39;fosforo&#39;</span><span class="p">,</span> <span class="s1">&#39;potasio&#39;</span><span class="p">]:</span> <span class="c1"># Solo algunos para el ejemplo</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>                      <span class="n">entry</span><span class="p">[</span><span class="n">nutrient</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">nv</span><span class="o">.</span><span class="n">value</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>             <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>         <span class="k">return</span> <span class="n">data</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_limiting_nutrient_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limiting_name</span><span class="p">,</span> <span class="n">analysisData</span><span class="p">,</span> <span class="n">optimalLevels</span><span class="p">):</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a><span class="w">         </span><span class="sd">&quot;&quot;&quot;Intenta reconstruir los datos del nutriente limitante.&quot;&quot;&quot;</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>         <span class="k">if</span> <span class="ow">not</span> <span class="n">limiting_name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">analysisData</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">optimalLevels</span><span class="p">:</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>             <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>         <span class="c1"># Buscar en foliar</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>         <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">analysisData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;foliar&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>             <span class="k">if</span> <span class="n">nutrient_names_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">limiting_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>                 <span class="n">levels</span> <span class="o">=</span> <span class="n">optimalLevels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nutrientes&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>                 <span class="k">if</span> <span class="n">levels</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;min&#39;</span> <span class="ow">in</span> <span class="n">levels</span> <span class="ow">and</span> <span class="s1">&#39;max&#39;</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">:</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>                      <span class="n">optimalMid</span> <span class="o">=</span> <span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">levels</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>                      <span class="n">percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="n">optimalMid</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">optimalMid</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>                      <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s2">&quot;percentage&quot;</span><span class="p">:</span> <span class="n">percentage</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;foliar&quot;</span><span class="p">}</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>         <span class="c1"># Buscar en suelo (excluyendo pH)</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>         <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">analysisData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;soil&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>              <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;ph&#39;</span> <span class="ow">and</span> <span class="n">nutrient_names_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">limiting_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>                   <span class="n">levels</span> <span class="o">=</span> <span class="n">optimalLevels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nutrientes&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>                   <span class="k">if</span> <span class="n">levels</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;min&#39;</span> <span class="ow">in</span> <span class="n">levels</span> <span class="ow">and</span> <span class="s1">&#39;max&#39;</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">:</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>                        <span class="n">optimalMid</span> <span class="o">=</span> <span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">levels</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>                        <span class="n">percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="n">optimalMid</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">optimalMid</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>                        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s2">&quot;percentage&quot;</span><span class="p">:</span> <span class="n">percentage</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;soil&quot;</span><span class="p">}</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>         <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">limiting_name</span><span class="p">,</span> <span class="s2">&quot;percentage&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">}</span> <span class="c1"># Si no se encuentran los detalles</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_nutrient_name_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a><span class="w">         </span><span class="sd">&quot;&quot;&quot;Genera un mapa de claves internas a nombres legibles.&quot;&quot;&quot;</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>         <span class="c1"># Este mapa debe ser consistente con cómo se generan las claves en analysisData</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>         <span class="k">return</span> <span class="p">{</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>             <span class="s2">&quot;nitrogeno&quot;</span><span class="p">:</span> <span class="s2">&quot;Nitrógeno&quot;</span><span class="p">,</span> <span class="s2">&quot;fosforo&quot;</span><span class="p">:</span> <span class="s2">&quot;Fósforo&quot;</span><span class="p">,</span> <span class="s2">&quot;potasio&quot;</span><span class="p">:</span> <span class="s2">&quot;Potasio&quot;</span><span class="p">,</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>             <span class="s2">&quot;calcio&quot;</span><span class="p">:</span> <span class="s2">&quot;Calcio&quot;</span><span class="p">,</span> <span class="s2">&quot;magnesio&quot;</span><span class="p">:</span> <span class="s2">&quot;Magnesio&quot;</span><span class="p">,</span> <span class="s2">&quot;azufre&quot;</span><span class="p">:</span> <span class="s2">&quot;Azufre&quot;</span><span class="p">,</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>             <span class="s2">&quot;hierro&quot;</span><span class="p">:</span> <span class="s2">&quot;Hierro&quot;</span><span class="p">,</span> <span class="s2">&quot;manganeso&quot;</span><span class="p">:</span> <span class="s2">&quot;Manganeso&quot;</span><span class="p">,</span> <span class="s2">&quot;zinc&quot;</span><span class="p">:</span> <span class="s2">&quot;Zinc&quot;</span><span class="p">,</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>             <span class="s2">&quot;cobre&quot;</span><span class="p">:</span> <span class="s2">&quot;Cobre&quot;</span><span class="p">,</span> <span class="s2">&quot;boro&quot;</span><span class="p">:</span> <span class="s2">&quot;Boro&quot;</span><span class="p">,</span> <span class="s2">&quot;ph&quot;</span><span class="p">:</span> <span class="s2">&quot;pH&quot;</span><span class="p">,</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>             <span class="s2">&quot;materiaOrganica&quot;</span><span class="p">:</span> <span class="s2">&quot;Materia Orgánica&quot;</span><span class="p">,</span> <span class="s2">&quot;cic&quot;</span><span class="p">:</span> <span class="s2">&quot;CIC&quot;</span><span class="p">,</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>             <span class="c1"># Añade mapeos para todas las claves que uses</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>         <span class="p">}</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>         
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a><span class="n">nutrient_names_map</span> <span class="o">=</span> <span class="n">ReportView</span><span class="p">()</span><span class="o">.</span><span class="n">_get_nutrient_name_map</span><span class="p">()</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a><span class="c1">#  Título	Finca / Lote	Cultivo	Fecha	Tipo	Autor</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a><span class="sd">Reportes, incluirán los datos completos de un análisis completo común (CommonAnalysis) </span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a><span class="sd">ahí se identificará el análisis de suelo (SoilAnalysis) y foliar (LeafAnalysis, debe incluir los nutrientes relacionados de la tabla leaf_analysis_nutrients ) relacionados con el ID del CommonAnalysis, esto deben presentarse así (Nota, los datos y listado de nutriente deben obtenerse de los registrados en el modelo Nutrient): </span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a><span class="sd">        </span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a><span class="sd">        </span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a><span class="sd">    analysisData = {</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a><span class="sd">        &quot;common&quot;: {</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a><span class="sd">            &quot;id&quot;: 3,</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a><span class="sd">            &quot;fechaAnalisis&quot;: &quot;2025-03-26&quot;,</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a><span class="sd">            &quot;finca&quot;: &quot;El nuevo rocío&quot;,</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a><span class="sd">            &quot;lote&quot;: &quot;Lote 1&quot;,</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a><span class="sd">            &quot;proteinas&quot;: 6.0,</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a><span class="sd">            &quot;descanso&quot;: 5.0,</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a><span class="sd">            &quot;diasDescanso&quot;: 5,</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a><span class="sd">            &quot;mes&quot;: 5,</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a><span class="sd">        },</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a><span class="sd">        &quot;foliar&quot;: {</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a><span class="sd">            &quot;id&quot;: 1,</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a><span class="sd">            &quot;nitrogeno&quot;: 2.5,</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a><span class="sd">            &quot;fosforo&quot;: 0.3,</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a><span class="sd">            &quot;potasio&quot;: 1.8,</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a><span class="sd">            &quot;calcio&quot;: 1.2,</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a><span class="sd">            &quot;magnesio&quot;: 0.4,</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a><span class="sd">            &quot;azufre&quot;: 0.2,</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a><span class="sd">            &quot;hierro&quot;: 85,</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a><span class="sd">            &quot;manganeso&quot;: 45,</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a><span class="sd">            &quot;zinc&quot;: 18,</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a><span class="sd">            &quot;cobre&quot;: 6,</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a><span class="sd">            &quot;boro&quot;: 25,</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a><span class="sd">        },</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a><span class="sd">        &quot;soil&quot;: {</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a><span class="sd">            &quot;id&quot;: 1,</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a><span class="sd">            &quot;ph&quot;: 6.5,</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a><span class="sd">            &quot;materiaOrganica&quot;: 3.2,</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a><span class="sd">            &quot;nitrogeno&quot;: 0.15,</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a><span class="sd">            &quot;fosforo&quot;: 12,</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a><span class="sd">            &quot;potasio&quot;: 180,</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a><span class="sd">            &quot;calcio&quot;: 1200,</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a><span class="sd">            &quot;magnesio&quot;: 180,</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a><span class="sd">            &quot;azufre&quot;: 15,</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a><span class="sd">            &quot;textura&quot;: &quot;Franco-arcillosa&quot;,</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a><span class="sd">            &quot;cic&quot;: 15.2,</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a><span class="sd">        },</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a><span class="sd">    }</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a><span class="sd">    </span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a><span class="sd">optimalLevels se obtendrá a partir del tipo de cultivo, este se comparará con los tipos de cultivo registrados en Crops y sus valores de nutrientes registrados en objective_nutrients (Nota, los datos y listado de nutriente deben obtenerse de los registrados en el modelo Nutrient)</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a><span class="sd">    optimalLevels = {</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a><span class="sd">        VALOR OBJETIVO	PROTEÍNA	DESCANSO</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a><span class="sd">        &quot;info&quot;: {</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a><span class="sd">            &quot;cultivo&quot;: &quot;papa&quot;, </span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a><span class="sd">            &quot;valor_obj&quot;: &quot;10&quot;,</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a><span class="sd">            &quot;proteina&quot;: &quot;8&quot;,</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a><span class="sd">            &quot;descanso&quot;: &quot;5&quot;,</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a><span class="sd">        </span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a><span class="sd">        }</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a><span class="sd">        &quot;nutrientes&quot;: {</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a><span class="sd">            &quot;nitrogeno&quot;: {&quot;min&quot;: 2.8, &quot;max&quot;: 3.5},</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a><span class="sd">            &quot;fosforo&quot;: {&quot;min&quot;: 0.2, &quot;max&quot;: 0.4},</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a><span class="sd">            &quot;potasio&quot;: {&quot;min&quot;: 2.0, &quot;max&quot;: 3.0},</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a><span class="sd">            &quot;calcio&quot;: {&quot;min&quot;: 1.0, &quot;max&quot;: 2.0},</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a><span class="sd">            &quot;magnesio&quot;: {&quot;min&quot;: 0.3, &quot;max&quot;: 0.6},</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a><span class="sd">            &quot;azufre&quot;: {&quot;min&quot;: 0.2, &quot;max&quot;: 0.4},</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a><span class="sd">            &quot;hierro&quot;: {&quot;min&quot;: 50, &quot;max&quot;: 150},</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a><span class="sd">            &quot;manganeso&quot;: {&quot;min&quot;: 25, &quot;max&quot;: 100},</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a><span class="sd">            &quot;zinc&quot;: {&quot;min&quot;: 20, &quot;max&quot;: 50},</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a><span class="sd">            &quot;cobre&quot;: {&quot;min&quot;: 5, &quot;max&quot;: 15},</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a><span class="sd">            &quot;boro&quot;: {&quot;min&quot;: 20, &quot;max&quot;: 50},</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a><span class="sd">        },</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a><span class="sd">    }</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a><span class="sd">    foliarChartData = [</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a><span class="sd">        {&quot;name&quot;: &quot;N&quot;, &quot;actual&quot;: analysisData[&quot;foliar&quot;][&quot;nitrogeno&quot;], &quot;min&quot;: optimalLevels[&quot;foliar&quot;][&quot;nitrogeno&quot;][&quot;min&quot;], &quot;max&quot;: optimalLevels[&quot;foliar&quot;][&quot;nitrogeno&quot;][&quot;max&quot;]},</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a><span class="sd">        {&quot;name&quot;: &quot;P&quot;, &quot;actual&quot;: analysisData[&quot;foliar&quot;][&quot;fosforo&quot;], &quot;min&quot;: optimalLevels[&quot;foliar&quot;][&quot;fosforo&quot;][&quot;min&quot;], &quot;max&quot;: optimalLevels[&quot;foliar&quot;][&quot;fosforo&quot;][&quot;max&quot;]},</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a><span class="sd">        {&quot;name&quot;: &quot;K&quot;, &quot;actual&quot;: analysisData[&quot;foliar&quot;][&quot;potasio&quot;], &quot;min&quot;: optimalLevels[&quot;foliar&quot;][&quot;potasio&quot;][&quot;min&quot;], &quot;max&quot;: optimalLevels[&quot;foliar&quot;][&quot;potasio&quot;][&quot;max&quot;]},</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a><span class="sd">        {&quot;name&quot;: &quot;Ca&quot;, &quot;actual&quot;: analysisData[&quot;foliar&quot;][&quot;calcio&quot;], &quot;min&quot;: optimalLevels[&quot;foliar&quot;][&quot;calcio&quot;][&quot;min&quot;], &quot;max&quot;: optimalLevels[&quot;foliar&quot;][&quot;calcio&quot;][&quot;max&quot;]},</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a><span class="sd">        {&quot;name&quot;: &quot;Mg&quot;, &quot;actual&quot;: analysisData[&quot;foliar&quot;][&quot;magnesio&quot;], &quot;min&quot;: optimalLevels[&quot;foliar&quot;][&quot;magnesio&quot;][&quot;min&quot;], &quot;max&quot;: optimalLevels[&quot;foliar&quot;][&quot;magnesio&quot;][&quot;max&quot;]},</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a><span class="sd">        {&quot;name&quot;: &quot;S&quot;, &quot;actual&quot;: analysisData[&quot;foliar&quot;][&quot;azufre&quot;], &quot;min&quot;: optimalLevels[&quot;foliar&quot;][&quot;azufre&quot;][&quot;min&quot;], &quot;max&quot;: optimalLevels[&quot;foliar&quot;][&quot;azufre&quot;][&quot;max&quot;]},</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a><span class="sd">    ]</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a><span class="sd">    soilChartData = [</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a><span class="sd">        {&quot;name&quot;: &quot;pH&quot;, &quot;actual&quot;: analysisData[&quot;soil&quot;][&quot;ph&quot;], &quot;min&quot;: optimalLevels[&quot;soil&quot;][&quot;ph&quot;][&quot;min&quot;], &quot;max&quot;: optimalLevels[&quot;soil&quot;][&quot;ph&quot;][&quot;max&quot;], &quot;unit&quot;: &quot;&quot;},</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a><span class="sd">        {&quot;name&quot;: &quot;M.O.&quot;, &quot;actual&quot;: analysisData[&quot;soil&quot;][&quot;materiaOrganica&quot;], &quot;min&quot;: optimalLevels[&quot;soil&quot;][&quot;materiaOrganica&quot;][&quot;min&quot;], &quot;max&quot;: optimalLevels[&quot;soil&quot;][&quot;materiaOrganica&quot;][&quot;max&quot;], &quot;unit&quot;: &quot;%&quot;},</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a><span class="sd">        {&quot;name&quot;: &quot;N&quot;, &quot;actual&quot;: analysisData[&quot;soil&quot;][&quot;nitrogeno&quot;], &quot;min&quot;: optimalLevels[&quot;soil&quot;][&quot;nitrogeno&quot;][&quot;min&quot;], &quot;max&quot;: optimalLevels[&quot;soil&quot;][&quot;nitrogeno&quot;][&quot;max&quot;], &quot;unit&quot;: &quot;%&quot;},</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a><span class="sd">        {&quot;name&quot;: &quot;P&quot;, &quot;actual&quot;: analysisData[&quot;soil&quot;][&quot;fosforo&quot;], &quot;min&quot;: optimalLevels[&quot;soil&quot;][&quot;fosforo&quot;][&quot;min&quot;], &quot;max&quot;: optimalLevels[&quot;soil&quot;][&quot;fosforo&quot;][&quot;max&quot;], &quot;unit&quot;: &quot;ppm&quot;},</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a><span class="sd">        {&quot;name&quot;: &quot;K&quot;, &quot;actual&quot;: analysisData[&quot;soil&quot;][&quot;potasio&quot;], &quot;min&quot;: optimalLevels[&quot;soil&quot;][&quot;potasio&quot;][&quot;min&quot;], &quot;max&quot;: optimalLevels[&quot;soil&quot;][&quot;potasio&quot;][&quot;max&quot;], &quot;unit&quot;: &quot;ppm&quot;},</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a><span class="sd">        {&quot;name&quot;: &quot;CIC&quot;, &quot;actual&quot;: analysisData[&quot;soil&quot;][&quot;cic&quot;], &quot;min&quot;: optimalLevels[&quot;soil&quot;][&quot;cic&quot;][&quot;min&quot;], &quot;max&quot;: optimalLevels[&quot;soil&quot;][&quot;cic&quot;][&quot;max&quot;], &quot;unit&quot;: &quot;meq/100g&quot;},</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a><span class="sd">    ]</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a><span class="sd">    historicalData = [</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a><span class="sd">        {&quot;fecha&quot;: &quot;Ene 2025&quot;, &quot;nitrogeno&quot;: 2.3, &quot;fosforo&quot;: 0.25, &quot;potasio&quot;: 1.5},</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a><span class="sd">        {&quot;fecha&quot;: &quot;Feb 2025&quot;, &quot;nitrogeno&quot;: 2.4, &quot;fosforo&quot;: 0.28, &quot;potasio&quot;: 1.6},</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a><span class="sd">        {&quot;fecha&quot;: &quot;Mar 2025&quot;, &quot;nitrogeno&quot;: 2.5, &quot;fosforo&quot;: 0.3, &quot;potasio&quot;: 1.8},</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a><span class="sd">    ]</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a><span class="sd">    nutrientNames = {</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a><span class="sd">        &quot;nitrogeno&quot;: &quot;Nitrógeno&quot;,</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a><span class="sd">        &quot;fosforo&quot;: &quot;Fósforo&quot;,</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a><span class="sd">        &quot;potasio&quot;: &quot;Potasio&quot;,</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a><span class="sd">        &quot;calcio&quot;: &quot;Calcio&quot;,</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a><span class="sd">        &quot;magnesio&quot;: &quot;Magnesio&quot;,</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a><span class="sd">        &quot;azufre&quot;: &quot;Azufre&quot;,</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a><span class="sd">        &quot;hierro&quot;: &quot;Hierro&quot;,</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a><span class="sd">        &quot;manganeso&quot;: &quot;Manganeso&quot;,</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a><span class="sd">        &quot;zinc&quot;: &quot;Zinc&quot;,</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a><span class="sd">        &quot;cobre&quot;: &quot;Cobre&quot;,</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a><span class="sd">        &quot;boro&quot;: &quot;Boro&quot;,</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a><span class="sd">        &quot;ph&quot;: &quot;pH&quot;,</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a><span class="sd">        &quot;materiaOrganica&quot;: &quot;Materia Orgánica&quot;,</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a><span class="sd">        &quot;cic&quot;: &quot;CIC&quot;,</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a><span class="sd">    }</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a><span class="sd">    def getNutrientStatus(actual, min, max):</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a><span class="sd">        if actual &lt; min:</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a><span class="sd">            return &quot;deficiente&quot;</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a><span class="sd">        if actual &gt; max:</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a><span class="sd">            return &quot;excesivo&quot;</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a><span class="sd">        return &quot;óptimo&quot;</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a><span class="sd">    def getStatusColor(status):</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a><span class="sd">        match status:</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a><span class="sd">            case &quot;deficiente&quot;:</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a><span class="sd">                return &quot;text-red-500&quot;</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a><span class="sd">            case &quot;excesivo&quot;:</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a><span class="sd">                return &quot;text-yellow-500&quot;</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a><span class="sd">            case &quot;óptimo&quot;:</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a><span class="sd">                return &quot;text-green-500&quot;</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a><span class="sd">            case _:</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a><span class="sd">                return &quot;&quot;</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a><span class="sd">    def getStatusIcon(status):</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a><span class="sd">        match status:</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a><span class="sd">            case &quot;deficiente&quot;:</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a><span class="sd">                return &#39;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;2&quot; stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; class=&quot;h-4 w-4 text-red-500&quot;&gt;&lt;polygon points=&quot;7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2&quot;&gt;&lt;/polygon&gt;&lt;line x1=&quot;12&quot; y1=&quot;8&quot; x2=&quot;12&quot; y2=&quot;12&quot;&gt;&lt;/line&gt;&lt;line x1=&quot;12&quot; y1=&quot;16&quot; x2=&quot;12.01&quot; y2=&quot;16&quot;&gt;&lt;/line&gt;&lt;/svg&gt;&#39;</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a><span class="sd">            case &quot;excesivo&quot;:</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a><span class="sd">                return &#39;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;2&quot; stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; class=&quot;h-4 w-4 text-yellow-500&quot;&gt;&lt;polygon points=&quot;7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2&quot;&gt;&lt;/polygon&gt;&lt;line x1=&quot;12&quot; y1=&quot;8&quot; x2=&quot;12&quot; y2=&quot;12&quot;&gt;&lt;/line&gt;&lt;line x1=&quot;12&quot; y1=&quot;16&quot; x2=&quot;12.01&quot; y2=&quot;16&quot;&gt;&lt;/line&gt;&lt;/svg&gt;&#39;</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a><span class="sd">            case &quot;óptimo&quot;:</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a><span class="sd">                return &#39;&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;2&quot; stroke-linecap=&quot;round&quot; stroke-linejoin=&quot;round&quot; class=&quot;h-4 w-4 text-green-500&quot;&gt;&lt;path d=&quot;M22 11.08V12a10 10 0 1 1-5.93-9.14&quot;&gt;&lt;/path&gt;&lt;polyline points=&quot;12 2 2 7.86 12 12&quot;&gt;&lt;/polyline&gt;&lt;line x1=&quot;12&quot; y1=&quot;16&quot; x2=&quot;12.01&quot; y2=&quot;16&quot;&gt;&lt;/line&gt;&lt;/svg&gt;&#39;</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a><span class="sd">            case _:</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a><span class="sd">                return &quot;&quot;</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a><span class="sd">    def findLimitingNutrient():</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a><span class="sd">        limitingNutrient = None</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a><span class="sd">        lowestPercentage = 100</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a><span class="sd">        for nutrient, value in analysisData[&quot;foliar&quot;].items():</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a><span class="sd">            if nutrient in optimalLevels[&quot;foliar&quot;]:</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a><span class="sd">                min_value = optimalLevels[&quot;foliar&quot;][nutrient][&quot;min&quot;]</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a><span class="sd">                max_value = optimalLevels[&quot;foliar&quot;][nutrient][&quot;max&quot;]</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a><span class="sd">                optimalMid = (min_value + max_value) / 2</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a><span class="sd">                percentage = (value / optimalMid) * 100</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a><span class="sd">                if percentage &lt; lowestPercentage and percentage &lt; 90:</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a><span class="sd">                    lowestPercentage = percentage</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a><span class="sd">                    limitingNutrient = {</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a><span class="sd">                        &quot;name&quot;: nutrient,</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a><span class="sd">                        &quot;value&quot;: value,</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a><span class="sd">                        &quot;optimal&quot;: optimalMid,</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a><span class="sd">                        &quot;percentage&quot;: percentage,</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a><span class="sd">                        &quot;type&quot;: &quot;foliar&quot;,</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a><span class="sd">                    }</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a><span class="sd">        for nutrient, value in analysisData[&quot;soil&quot;].items():</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a><span class="sd">            if nutrient in optimalLevels[&quot;soil&quot;] and nutrient != &quot;ph&quot;:</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a><span class="sd">                min_value = optimalLevels[&quot;soil&quot;][nutrient][&quot;min&quot;]</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a><span class="sd">                max_value = optimalLevels[&quot;soil&quot;][nutrient][&quot;max&quot;]</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a><span class="sd">                optimalMid = (min_value + max_value) / 2</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a><span class="sd">                percentage = (value / optimalMid) * 100</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a><span class="sd">                if percentage &lt; lowestPercentage and percentage &lt; 90:</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a><span class="sd">                    lowestPercentage = percentage</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a><span class="sd">                    limitingNutrient = {</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a><span class="sd">                        &quot;name&quot;: nutrient,</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a><span class="sd">                        &quot;value&quot;: value,</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a><span class="sd">                        &quot;optimal&quot;: optimalMid,</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a><span class="sd">                        &quot;percentage&quot;: percentage,</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a><span class="sd">                        &quot;type&quot;: &quot;soil&quot;,</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a><span class="sd">                    }</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a><span class="sd">        return limitingNutrient</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a><span class="sd">    def generateRecommendations():</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a><span class="sd">        recommendations = []</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a><span class="sd">        limitingNutrient = findLimitingNutrient()</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a><span class="sd">        if limitingNutrient:</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a><span class="sd">            nutrientName = nutrientNames[limitingNutrient[&quot;name&quot;]] or limitingNutrient[&quot;name&quot;]</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a><span class="sd">            recommendations.append({</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a><span class="sd">                &quot;title&quot;: f&quot;Corregir deficiencia de {nutrientName}&quot;,</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a><span class="sd">                &quot;description&quot;: f&quot;El {nutrientName} es el nutriente limitante según la Ley de Liebig. Está al limitingNutrient[&#39;percentage&#39;]% del nivel óptimo.&quot;,</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a><span class="sd">                &quot;priority&quot;: &quot;alta&quot;,</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a><span class="sd">                &quot;action&quot;: &quot;Aplicar fertilizante foliar rico en {nutrientName}&quot; if limitingNutrient[&quot;type&quot;] == &quot;foliar&quot; else f&quot;Incorporar {nutrientName} al suelo mediante fertilización&quot;,</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a><span class="sd">            })</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a><span class="sd">        phStatus = getNutrientStatus(analysisData[&quot;soil&quot;][&quot;ph&quot;], optimalLevels[&quot;soil&quot;][&quot;ph&quot;][&quot;min&quot;], optimalLevels[&quot;soil&quot;][&quot;ph&quot;][&quot;max&quot;])</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a><span class="sd">        if phStatus != &quot;óptimo&quot;:</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a><span class="sd">            recommendations.append({</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a><span class="sd">                &quot;title&quot;: &quot;Corregir acidez del suelo&quot; if phStatus == &quot;deficiente&quot; else &quot;Reducir alcalinidad del suelo&quot;,</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a><span class="sd">                &quot;description&quot;: f&quot;El pH actual ({analysisData[&#39;soil&#39;][&#39;ph&#39;]}) está {&#39;por debajo&#39; if phStatus == &#39;deficiente&#39; else &#39;por encima&#39;} del rango óptimo.&quot;,</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a><span class="sd">                &quot;priority&quot;: &quot;media&quot;,</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a><span class="sd">                &quot;action&quot;: &quot;Aplicar cal agrícola para elevar el pH&quot; if phStatus == &quot;deficiente&quot; else &quot;Aplicar azufre elemental o materia orgánica para reducir el pH&quot;,</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a><span class="sd">            })</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a><span class="sd">        moStatus = getNutrientStatus(analysisData[&quot;soil&quot;][&quot;materiaOrganica&quot;], optimalLevels[&quot;soil&quot;][&quot;materiaOrganica&quot;][&quot;min&quot;], optimalLevels[&quot;soil&quot;][&quot;materiaOrganica&quot;][&quot;max&quot;])</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a><span class="sd">        if moStatus == &quot;deficiente&quot;:</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a><span class="sd">            recommendations.append({</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a><span class="sd">                &quot;title&quot;: &quot;Aumentar materia orgánica&quot;,</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a><span class="sd">                &quot;description&quot;: f&quot;El nivel de materia orgánica ({analysisData[&#39;soil&#39;][&#39;materiaOrganica&#39;]}%) está por debajo del óptimo.&quot;,</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a><span class="sd">                &quot;priority&quot;: &quot;media&quot;,</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a><span class="sd">                &quot;action&quot;: &quot;Incorporar compost, estiércol bien descompuesto o abonos verdes&quot;,</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a><span class="sd">            })</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a><span class="sd">        return recommendations</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a><span class="sd">    limitingNutrient = findLimitingNutrient()</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a><span class="sd">    recommendations = generateRecommendations()</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a><span class="sd">&quot;&quot;&quot;</span>
</span></pre></div>


            </section>
                <section id="LeyLiebig">
                            <input id="LeyLiebig-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LeyLiebig</span>:

                <label class="view-source-button" for="LeyLiebig-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeyLiebig"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeyLiebig-36"><a href="#LeyLiebig-36"><span class="linenos"> 36</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LeyLiebig</span><span class="p">:</span>
</span><span id="LeyLiebig-37"><a href="#LeyLiebig-37"><span class="linenos"> 37</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LeyLiebig-38"><a href="#LeyLiebig-38"><span class="linenos"> 38</span></a><span class="sd">    Clase que implementa la Ley del Mínimo de Liebig para el cálculo de nutrientes en un cultivo.</span>
</span><span id="LeyLiebig-39"><a href="#LeyLiebig-39"><span class="linenos"> 39</span></a><span class="sd">    </span>
</span><span id="LeyLiebig-40"><a href="#LeyLiebig-40"><span class="linenos"> 40</span></a><span class="sd">    La Ley del Mínimo establece que el crecimiento de una planta está limitado por el nutriente más escaso en relación</span>
</span><span id="LeyLiebig-41"><a href="#LeyLiebig-41"><span class="linenos"> 41</span></a><span class="sd">    con sus necesidades, en lugar de depender de la cantidad total de nutrientes disponibles.</span>
</span><span id="LeyLiebig-42"><a href="#LeyLiebig-42"><span class="linenos"> 42</span></a><span class="sd">    </span>
</span><span id="LeyLiebig-43"><a href="#LeyLiebig-43"><span class="linenos"> 43</span></a><span class="sd">    Esta clase permite evaluar el estado nutricional de un cultivo comparando los niveles actuales con la demanda ideal,</span>
</span><span id="LeyLiebig-44"><a href="#LeyLiebig-44"><span class="linenos"> 44</span></a><span class="sd">    identificando el nutriente más limitante y proponiendo ajustes para optimizar su disponibilidad.</span>
</span><span id="LeyLiebig-45"><a href="#LeyLiebig-45"><span class="linenos"> 45</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="LeyLiebig-46"><a href="#LeyLiebig-46"><span class="linenos"> 46</span></a>
</span><span id="LeyLiebig-47"><a href="#LeyLiebig-47"><span class="linenos"> 47</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nutrientes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">demanda_planta</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">):</span>
</span><span id="LeyLiebig-48"><a href="#LeyLiebig-48"><span class="linenos"> 48</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LeyLiebig-49"><a href="#LeyLiebig-49"><span class="linenos"> 49</span></a><span class="sd">        Inicializa la clase con los nutrientes disponibles y la demanda ideal de la planta.</span>
</span><span id="LeyLiebig-50"><a href="#LeyLiebig-50"><span class="linenos"> 50</span></a><span class="sd">        </span>
</span><span id="LeyLiebig-51"><a href="#LeyLiebig-51"><span class="linenos"> 51</span></a><span class="sd">        :param nutrientes: Diccionario con los nutrientes y sus valores actuales en el suelo.</span>
</span><span id="LeyLiebig-52"><a href="#LeyLiebig-52"><span class="linenos"> 52</span></a><span class="sd">        :param demanda_planta: Valor total de la demanda nutricional ideal de la planta.</span>
</span><span id="LeyLiebig-53"><a href="#LeyLiebig-53"><span class="linenos"> 53</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LeyLiebig-54"><a href="#LeyLiebig-54"><span class="linenos"> 54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes</span> <span class="o">=</span> <span class="n">nutrientes</span>
</span><span id="LeyLiebig-55"><a href="#LeyLiebig-55"><span class="linenos"> 55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">demanda_planta</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">demanda_planta</span><span class="p">)</span>
</span><span id="LeyLiebig-56"><a href="#LeyLiebig-56"><span class="linenos"> 56</span></a>
</span><span id="LeyLiebig-57"><a href="#LeyLiebig-57"><span class="linenos"> 57</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calcular_p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valor_registro</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decimal</span><span class="p">:</span>
</span><span id="LeyLiebig-58"><a href="#LeyLiebig-58"><span class="linenos"> 58</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LeyLiebig-59"><a href="#LeyLiebig-59"><span class="linenos"> 59</span></a><span class="sd">        Calcula el porcentaje de suficiencia de un nutriente con respecto a la demanda de la planta.</span>
</span><span id="LeyLiebig-60"><a href="#LeyLiebig-60"><span class="linenos"> 60</span></a><span class="sd">        </span>
</span><span id="LeyLiebig-61"><a href="#LeyLiebig-61"><span class="linenos"> 61</span></a><span class="sd">        :param valor_registro: Valor actual del nutriente en el suelo.</span>
</span><span id="LeyLiebig-62"><a href="#LeyLiebig-62"><span class="linenos"> 62</span></a><span class="sd">        :return: Porcentaje de suficiencia del nutriente con respecto a la demanda ideal.</span>
</span><span id="LeyLiebig-63"><a href="#LeyLiebig-63"><span class="linenos"> 63</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LeyLiebig-64"><a href="#LeyLiebig-64"><span class="linenos"> 64</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">demanda_planta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LeyLiebig-65"><a href="#LeyLiebig-65"><span class="linenos"> 65</span></a>            <span class="k">return</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.00&#39;</span><span class="p">)</span>
</span><span id="LeyLiebig-66"><a href="#LeyLiebig-66"><span class="linenos"> 66</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="n">valor_registro</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">demanda_planta</span><span class="p">)</span> <span class="o">*</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">)</span>
</span><span id="LeyLiebig-67"><a href="#LeyLiebig-67"><span class="linenos"> 67</span></a>
</span><span id="LeyLiebig-68"><a href="#LeyLiebig-68"><span class="linenos"> 68</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calcular_i</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mineral_p</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">mineral_cv</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decimal</span><span class="p">:</span>
</span><span id="LeyLiebig-69"><a href="#LeyLiebig-69"><span class="linenos"> 69</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LeyLiebig-70"><a href="#LeyLiebig-70"><span class="linenos"> 70</span></a><span class="sd">        Calcula la cantidad de ajuste necesario para un nutriente limitante en función de su coeficiente de variación.</span>
</span><span id="LeyLiebig-71"><a href="#LeyLiebig-71"><span class="linenos"> 71</span></a><span class="sd">        </span>
</span><span id="LeyLiebig-72"><a href="#LeyLiebig-72"><span class="linenos"> 72</span></a><span class="sd">        :param mineral_p: Porcentaje de suficiencia del nutriente.</span>
</span><span id="LeyLiebig-73"><a href="#LeyLiebig-73"><span class="linenos"> 73</span></a><span class="sd">        :param mineral_cv: Coeficiente de variación del nutriente.</span>
</span><span id="LeyLiebig-74"><a href="#LeyLiebig-74"><span class="linenos"> 74</span></a><span class="sd">        :return: Cantidad de ajuste necesaria para alcanzar el nivel óptimo.</span>
</span><span id="LeyLiebig-75"><a href="#LeyLiebig-75"><span class="linenos"> 75</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LeyLiebig-76"><a href="#LeyLiebig-76"><span class="linenos"> 76</span></a>        <span class="k">if</span> <span class="n">mineral_p</span> <span class="o">&gt;</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">):</span>
</span><span id="LeyLiebig-77"><a href="#LeyLiebig-77"><span class="linenos"> 77</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">mineral_p</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="n">mineral_cv</span> <span class="o">/</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">))</span>
</span><span id="LeyLiebig-78"><a href="#LeyLiebig-78"><span class="linenos"> 78</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LeyLiebig-79"><a href="#LeyLiebig-79"><span class="linenos"> 79</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">mineral_p</span><span class="p">)</span> <span class="o">*</span> <span class="n">mineral_cv</span> <span class="o">/</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">))</span>
</span><span id="LeyLiebig-80"><a href="#LeyLiebig-80"><span class="linenos"> 80</span></a>        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.00&#39;</span><span class="p">),</span> <span class="n">rounding</span><span class="o">=</span><span class="n">ROUND_HALF_UP</span><span class="p">)</span>
</span><span id="LeyLiebig-81"><a href="#LeyLiebig-81"><span class="linenos"> 81</span></a>
</span><span id="LeyLiebig-82"><a href="#LeyLiebig-82"><span class="linenos"> 82</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calcular_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mineral_p</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">mineral_i</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decimal</span><span class="p">:</span>
</span><span id="LeyLiebig-83"><a href="#LeyLiebig-83"><span class="linenos"> 83</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LeyLiebig-84"><a href="#LeyLiebig-84"><span class="linenos"> 84</span></a><span class="sd">        Determina el nivel corregido del nutriente después del ajuste.</span>
</span><span id="LeyLiebig-85"><a href="#LeyLiebig-85"><span class="linenos"> 85</span></a><span class="sd">        </span>
</span><span id="LeyLiebig-86"><a href="#LeyLiebig-86"><span class="linenos"> 86</span></a><span class="sd">        :param mineral_p: Porcentaje de suficiencia del nutriente.</span>
</span><span id="LeyLiebig-87"><a href="#LeyLiebig-87"><span class="linenos"> 87</span></a><span class="sd">        :param mineral_i: Cantidad de ajuste aplicada al nutriente.</span>
</span><span id="LeyLiebig-88"><a href="#LeyLiebig-88"><span class="linenos"> 88</span></a><span class="sd">        :return: Nivel corregido del nutriente en el suelo.</span>
</span><span id="LeyLiebig-89"><a href="#LeyLiebig-89"><span class="linenos"> 89</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LeyLiebig-90"><a href="#LeyLiebig-90"><span class="linenos"> 90</span></a>        <span class="k">if</span> <span class="n">mineral_p</span> <span class="o">&gt;</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">):</span>
</span><span id="LeyLiebig-91"><a href="#LeyLiebig-91"><span class="linenos"> 91</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">mineral_p</span> <span class="o">-</span> <span class="n">mineral_i</span><span class="p">)</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.00&#39;</span><span class="p">),</span> <span class="n">rounding</span><span class="o">=</span><span class="n">ROUND_HALF_UP</span><span class="p">)</span>
</span><span id="LeyLiebig-92"><a href="#LeyLiebig-92"><span class="linenos"> 92</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">mineral_p</span> <span class="o">+</span> <span class="n">mineral_i</span><span class="p">)</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.00&#39;</span><span class="p">),</span> <span class="n">rounding</span><span class="o">=</span><span class="n">ROUND_HALF_UP</span><span class="p">)</span>
</span><span id="LeyLiebig-93"><a href="#LeyLiebig-93"><span class="linenos"> 93</span></a>
</span><span id="LeyLiebig-94"><a href="#LeyLiebig-94"><span class="linenos"> 94</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calcular_nutriente_limite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valores_registro</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="LeyLiebig-95"><a href="#LeyLiebig-95"><span class="linenos"> 95</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LeyLiebig-96"><a href="#LeyLiebig-96"><span class="linenos"> 96</span></a><span class="sd">        Identifica el nutriente más limitante según la Ley del Mínimo de Liebig.</span>
</span><span id="LeyLiebig-97"><a href="#LeyLiebig-97"><span class="linenos"> 97</span></a><span class="sd">        </span>
</span><span id="LeyLiebig-98"><a href="#LeyLiebig-98"><span class="linenos"> 98</span></a><span class="sd">        El nutriente limitante es aquel que tiene el menor porcentaje de suficiencia.</span>
</span><span id="LeyLiebig-99"><a href="#LeyLiebig-99"><span class="linenos"> 99</span></a><span class="sd">        </span>
</span><span id="LeyLiebig-100"><a href="#LeyLiebig-100"><span class="linenos">100</span></a><span class="sd">        :param valores_registro: Diccionario con los valores actuales de los nutrientes en el suelo.</span>
</span><span id="LeyLiebig-101"><a href="#LeyLiebig-101"><span class="linenos">101</span></a><span class="sd">        :return: Nombre del nutriente más limitante.</span>
</span><span id="LeyLiebig-102"><a href="#LeyLiebig-102"><span class="linenos">102</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LeyLiebig-103"><a href="#LeyLiebig-103"><span class="linenos">103</span></a>        <span class="n">valores_p</span> <span class="o">=</span> <span class="p">{</span><span class="n">mineral</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcular_p</span><span class="p">(</span><span class="n">valor</span><span class="p">)</span> <span class="k">for</span> <span class="n">mineral</span><span class="p">,</span> <span class="n">valor</span> <span class="ow">in</span> <span class="n">valores_registro</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="LeyLiebig-104"><a href="#LeyLiebig-104"><span class="linenos">104</span></a>        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">valores_p</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">valores_p</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>  <span class="c1"># Devuelve el nutriente con el menor porcentaje de suficiencia</span>
</span><span id="LeyLiebig-105"><a href="#LeyLiebig-105"><span class="linenos">105</span></a>
</span><span id="LeyLiebig-106"><a href="#LeyLiebig-106"><span class="linenos">106</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calcular_nutrientes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valores_registro</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">valores_cv</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="LeyLiebig-107"><a href="#LeyLiebig-107"><span class="linenos">107</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LeyLiebig-108"><a href="#LeyLiebig-108"><span class="linenos">108</span></a><span class="sd">        Calcula los ajustes necesarios para los nutrientes del cultivo.</span>
</span><span id="LeyLiebig-109"><a href="#LeyLiebig-109"><span class="linenos">109</span></a><span class="sd">        </span>
</span><span id="LeyLiebig-110"><a href="#LeyLiebig-110"><span class="linenos">110</span></a><span class="sd">        La corrección se aplica únicamente al nutriente más limitante para respetar la Ley del Mínimo de Liebig.</span>
</span><span id="LeyLiebig-111"><a href="#LeyLiebig-111"><span class="linenos">111</span></a><span class="sd">        </span>
</span><span id="LeyLiebig-112"><a href="#LeyLiebig-112"><span class="linenos">112</span></a><span class="sd">        :param valores_registro: Diccionario con los valores actuales de los nutrientes en el suelo.</span>
</span><span id="LeyLiebig-113"><a href="#LeyLiebig-113"><span class="linenos">113</span></a><span class="sd">        :param valores_cv: Diccionario con los coeficientes de variación de cada nutriente.</span>
</span><span id="LeyLiebig-114"><a href="#LeyLiebig-114"><span class="linenos">114</span></a><span class="sd">        :return: Diccionario con los valores de suficiencia (p), ajuste necesario (i) y nivel corregido (r) de cada nutriente.</span>
</span><span id="LeyLiebig-115"><a href="#LeyLiebig-115"><span class="linenos">115</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LeyLiebig-116"><a href="#LeyLiebig-116"><span class="linenos">116</span></a>        <span class="n">nutriente_limitante</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcular_nutriente_limite</span><span class="p">(</span><span class="n">valores_registro</span><span class="p">)</span>
</span><span id="LeyLiebig-117"><a href="#LeyLiebig-117"><span class="linenos">117</span></a>        <span class="n">nutrientes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LeyLiebig-118"><a href="#LeyLiebig-118"><span class="linenos">118</span></a>        <span class="k">for</span> <span class="n">mineral</span><span class="p">,</span> <span class="n">valor_registro</span> <span class="ow">in</span> <span class="n">valores_registro</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LeyLiebig-119"><a href="#LeyLiebig-119"><span class="linenos">119</span></a>            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcular_p</span><span class="p">(</span><span class="n">valor_registro</span><span class="p">)</span>
</span><span id="LeyLiebig-120"><a href="#LeyLiebig-120"><span class="linenos">120</span></a>            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcular_i</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">valores_cv</span><span class="p">[</span><span class="n">mineral</span><span class="p">])</span> <span class="k">if</span> <span class="n">mineral</span> <span class="o">==</span> <span class="n">nutriente_limitante</span> <span class="k">else</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.00&#39;</span><span class="p">)</span>
</span><span id="LeyLiebig-121"><a href="#LeyLiebig-121"><span class="linenos">121</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcular_r</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</span><span id="LeyLiebig-122"><a href="#LeyLiebig-122"><span class="linenos">122</span></a>            <span class="n">nutrientes</span><span class="p">[</span><span class="n">mineral</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">}</span>
</span><span id="LeyLiebig-123"><a href="#LeyLiebig-123"><span class="linenos">123</span></a>        <span class="k">return</span> <span class="n">nutrientes</span>
</span></pre></div>


            <div class="docstring"><p>Clase que implementa la Ley del Mínimo de Liebig para el cálculo de nutrientes en un cultivo.</p>

<p>La Ley del Mínimo establece que el crecimiento de una planta está limitado por el nutriente más escaso en relación
con sus necesidades, en lugar de depender de la cantidad total de nutrientes disponibles.</p>

<p>Esta clase permite evaluar el estado nutricional de un cultivo comparando los niveles actuales con la demanda ideal,
identificando el nutriente más limitante y proponiendo ajustes para optimizar su disponibilidad.</p>
</div>


                            <div id="LeyLiebig.__init__" class="classattr">
                                        <input id="LeyLiebig.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">LeyLiebig</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">nutrientes</span><span class="p">:</span> <span class="nb">dict</span>, </span><span class="param"><span class="n">demanda_planta</span><span class="p">:</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span></span>)</span>

                <label class="view-source-button" for="LeyLiebig.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeyLiebig.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeyLiebig.__init__-47"><a href="#LeyLiebig.__init__-47"><span class="linenos">47</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nutrientes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">demanda_planta</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">):</span>
</span><span id="LeyLiebig.__init__-48"><a href="#LeyLiebig.__init__-48"><span class="linenos">48</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LeyLiebig.__init__-49"><a href="#LeyLiebig.__init__-49"><span class="linenos">49</span></a><span class="sd">        Inicializa la clase con los nutrientes disponibles y la demanda ideal de la planta.</span>
</span><span id="LeyLiebig.__init__-50"><a href="#LeyLiebig.__init__-50"><span class="linenos">50</span></a><span class="sd">        </span>
</span><span id="LeyLiebig.__init__-51"><a href="#LeyLiebig.__init__-51"><span class="linenos">51</span></a><span class="sd">        :param nutrientes: Diccionario con los nutrientes y sus valores actuales en el suelo.</span>
</span><span id="LeyLiebig.__init__-52"><a href="#LeyLiebig.__init__-52"><span class="linenos">52</span></a><span class="sd">        :param demanda_planta: Valor total de la demanda nutricional ideal de la planta.</span>
</span><span id="LeyLiebig.__init__-53"><a href="#LeyLiebig.__init__-53"><span class="linenos">53</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LeyLiebig.__init__-54"><a href="#LeyLiebig.__init__-54"><span class="linenos">54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes</span> <span class="o">=</span> <span class="n">nutrientes</span>
</span><span id="LeyLiebig.__init__-55"><a href="#LeyLiebig.__init__-55"><span class="linenos">55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">demanda_planta</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="n">demanda_planta</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Inicializa la clase con los nutrientes disponibles y la demanda ideal de la planta.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>nutrientes</strong>:  Diccionario con los nutrientes y sus valores actuales en el suelo.</li>
<li><strong>demanda_planta</strong>:  Valor total de la demanda nutricional ideal de la planta.</li>
</ul>
</div>


                            </div>
                            <div id="LeyLiebig.nutrientes" class="classattr">
                                <div class="attr variable">
            <span class="name">nutrientes</span>

        
    </div>
    <a class="headerlink" href="#LeyLiebig.nutrientes"></a>
    
    

                            </div>
                            <div id="LeyLiebig.demanda_planta" class="classattr">
                                <div class="attr variable">
            <span class="name">demanda_planta</span>

        
    </div>
    <a class="headerlink" href="#LeyLiebig.demanda_planta"></a>
    
    

                            </div>
                            <div id="LeyLiebig.calcular_p" class="classattr">
                                        <input id="LeyLiebig.calcular_p-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calcular_p</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">valor_registro</span><span class="p">:</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span></span><span class="return-annotation">) -> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span>:</span></span>

                <label class="view-source-button" for="LeyLiebig.calcular_p-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeyLiebig.calcular_p"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeyLiebig.calcular_p-57"><a href="#LeyLiebig.calcular_p-57"><span class="linenos">57</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calcular_p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valor_registro</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decimal</span><span class="p">:</span>
</span><span id="LeyLiebig.calcular_p-58"><a href="#LeyLiebig.calcular_p-58"><span class="linenos">58</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LeyLiebig.calcular_p-59"><a href="#LeyLiebig.calcular_p-59"><span class="linenos">59</span></a><span class="sd">        Calcula el porcentaje de suficiencia de un nutriente con respecto a la demanda de la planta.</span>
</span><span id="LeyLiebig.calcular_p-60"><a href="#LeyLiebig.calcular_p-60"><span class="linenos">60</span></a><span class="sd">        </span>
</span><span id="LeyLiebig.calcular_p-61"><a href="#LeyLiebig.calcular_p-61"><span class="linenos">61</span></a><span class="sd">        :param valor_registro: Valor actual del nutriente en el suelo.</span>
</span><span id="LeyLiebig.calcular_p-62"><a href="#LeyLiebig.calcular_p-62"><span class="linenos">62</span></a><span class="sd">        :return: Porcentaje de suficiencia del nutriente con respecto a la demanda ideal.</span>
</span><span id="LeyLiebig.calcular_p-63"><a href="#LeyLiebig.calcular_p-63"><span class="linenos">63</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LeyLiebig.calcular_p-64"><a href="#LeyLiebig.calcular_p-64"><span class="linenos">64</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">demanda_planta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LeyLiebig.calcular_p-65"><a href="#LeyLiebig.calcular_p-65"><span class="linenos">65</span></a>            <span class="k">return</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.00&#39;</span><span class="p">)</span>
</span><span id="LeyLiebig.calcular_p-66"><a href="#LeyLiebig.calcular_p-66"><span class="linenos">66</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="n">valor_registro</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">demanda_planta</span><span class="p">)</span> <span class="o">*</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Calcula el porcentaje de suficiencia de un nutriente con respecto a la demanda de la planta.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>valor_registro</strong>:  Valor actual del nutriente en el suelo.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Porcentaje de suficiencia del nutriente con respecto a la demanda ideal.</p>
</blockquote>
</div>


                            </div>
                            <div id="LeyLiebig.calcular_i" class="classattr">
                                        <input id="LeyLiebig.calcular_i-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calcular_i</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">mineral_p</span><span class="p">:</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span>,</span><span class="param">	<span class="n">mineral_cv</span><span class="p">:</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span></span><span class="return-annotation">) -> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span>:</span></span>

                <label class="view-source-button" for="LeyLiebig.calcular_i-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeyLiebig.calcular_i"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeyLiebig.calcular_i-68"><a href="#LeyLiebig.calcular_i-68"><span class="linenos">68</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calcular_i</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mineral_p</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">mineral_cv</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decimal</span><span class="p">:</span>
</span><span id="LeyLiebig.calcular_i-69"><a href="#LeyLiebig.calcular_i-69"><span class="linenos">69</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LeyLiebig.calcular_i-70"><a href="#LeyLiebig.calcular_i-70"><span class="linenos">70</span></a><span class="sd">        Calcula la cantidad de ajuste necesario para un nutriente limitante en función de su coeficiente de variación.</span>
</span><span id="LeyLiebig.calcular_i-71"><a href="#LeyLiebig.calcular_i-71"><span class="linenos">71</span></a><span class="sd">        </span>
</span><span id="LeyLiebig.calcular_i-72"><a href="#LeyLiebig.calcular_i-72"><span class="linenos">72</span></a><span class="sd">        :param mineral_p: Porcentaje de suficiencia del nutriente.</span>
</span><span id="LeyLiebig.calcular_i-73"><a href="#LeyLiebig.calcular_i-73"><span class="linenos">73</span></a><span class="sd">        :param mineral_cv: Coeficiente de variación del nutriente.</span>
</span><span id="LeyLiebig.calcular_i-74"><a href="#LeyLiebig.calcular_i-74"><span class="linenos">74</span></a><span class="sd">        :return: Cantidad de ajuste necesaria para alcanzar el nivel óptimo.</span>
</span><span id="LeyLiebig.calcular_i-75"><a href="#LeyLiebig.calcular_i-75"><span class="linenos">75</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LeyLiebig.calcular_i-76"><a href="#LeyLiebig.calcular_i-76"><span class="linenos">76</span></a>        <span class="k">if</span> <span class="n">mineral_p</span> <span class="o">&gt;</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">):</span>
</span><span id="LeyLiebig.calcular_i-77"><a href="#LeyLiebig.calcular_i-77"><span class="linenos">77</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">mineral_p</span> <span class="o">-</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="n">mineral_cv</span> <span class="o">/</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">))</span>
</span><span id="LeyLiebig.calcular_i-78"><a href="#LeyLiebig.calcular_i-78"><span class="linenos">78</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LeyLiebig.calcular_i-79"><a href="#LeyLiebig.calcular_i-79"><span class="linenos">79</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">mineral_p</span><span class="p">)</span> <span class="o">*</span> <span class="n">mineral_cv</span> <span class="o">/</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">))</span>
</span><span id="LeyLiebig.calcular_i-80"><a href="#LeyLiebig.calcular_i-80"><span class="linenos">80</span></a>        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.00&#39;</span><span class="p">),</span> <span class="n">rounding</span><span class="o">=</span><span class="n">ROUND_HALF_UP</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Calcula la cantidad de ajuste necesario para un nutriente limitante en función de su coeficiente de variación.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>mineral_p</strong>:  Porcentaje de suficiencia del nutriente.</li>
<li><strong>mineral_cv</strong>:  Coeficiente de variación del nutriente.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Cantidad de ajuste necesaria para alcanzar el nivel óptimo.</p>
</blockquote>
</div>


                            </div>
                            <div id="LeyLiebig.calcular_r" class="classattr">
                                        <input id="LeyLiebig.calcular_r-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calcular_r</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">mineral_p</span><span class="p">:</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span>,</span><span class="param">	<span class="n">mineral_i</span><span class="p">:</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span></span><span class="return-annotation">) -> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span>:</span></span>

                <label class="view-source-button" for="LeyLiebig.calcular_r-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeyLiebig.calcular_r"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeyLiebig.calcular_r-82"><a href="#LeyLiebig.calcular_r-82"><span class="linenos">82</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calcular_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mineral_p</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">,</span> <span class="n">mineral_i</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decimal</span><span class="p">:</span>
</span><span id="LeyLiebig.calcular_r-83"><a href="#LeyLiebig.calcular_r-83"><span class="linenos">83</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LeyLiebig.calcular_r-84"><a href="#LeyLiebig.calcular_r-84"><span class="linenos">84</span></a><span class="sd">        Determina el nivel corregido del nutriente después del ajuste.</span>
</span><span id="LeyLiebig.calcular_r-85"><a href="#LeyLiebig.calcular_r-85"><span class="linenos">85</span></a><span class="sd">        </span>
</span><span id="LeyLiebig.calcular_r-86"><a href="#LeyLiebig.calcular_r-86"><span class="linenos">86</span></a><span class="sd">        :param mineral_p: Porcentaje de suficiencia del nutriente.</span>
</span><span id="LeyLiebig.calcular_r-87"><a href="#LeyLiebig.calcular_r-87"><span class="linenos">87</span></a><span class="sd">        :param mineral_i: Cantidad de ajuste aplicada al nutriente.</span>
</span><span id="LeyLiebig.calcular_r-88"><a href="#LeyLiebig.calcular_r-88"><span class="linenos">88</span></a><span class="sd">        :return: Nivel corregido del nutriente en el suelo.</span>
</span><span id="LeyLiebig.calcular_r-89"><a href="#LeyLiebig.calcular_r-89"><span class="linenos">89</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LeyLiebig.calcular_r-90"><a href="#LeyLiebig.calcular_r-90"><span class="linenos">90</span></a>        <span class="k">if</span> <span class="n">mineral_p</span> <span class="o">&gt;</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.00&#39;</span><span class="p">):</span>
</span><span id="LeyLiebig.calcular_r-91"><a href="#LeyLiebig.calcular_r-91"><span class="linenos">91</span></a>            <span class="k">return</span> <span class="p">(</span><span class="n">mineral_p</span> <span class="o">-</span> <span class="n">mineral_i</span><span class="p">)</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.00&#39;</span><span class="p">),</span> <span class="n">rounding</span><span class="o">=</span><span class="n">ROUND_HALF_UP</span><span class="p">)</span>
</span><span id="LeyLiebig.calcular_r-92"><a href="#LeyLiebig.calcular_r-92"><span class="linenos">92</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">mineral_p</span> <span class="o">+</span> <span class="n">mineral_i</span><span class="p">)</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.00&#39;</span><span class="p">),</span> <span class="n">rounding</span><span class="o">=</span><span class="n">ROUND_HALF_UP</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Determina el nivel corregido del nutriente después del ajuste.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>mineral_p</strong>:  Porcentaje de suficiencia del nutriente.</li>
<li><strong>mineral_i</strong>:  Cantidad de ajuste aplicada al nutriente.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Nivel corregido del nutriente en el suelo.</p>
</blockquote>
</div>


                            </div>
                            <div id="LeyLiebig.calcular_nutriente_limite" class="classattr">
                                        <input id="LeyLiebig.calcular_nutriente_limite-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calcular_nutriente_limite</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">valores_registro</span><span class="p">:</span> <span class="nb">dict</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="LeyLiebig.calcular_nutriente_limite-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeyLiebig.calcular_nutriente_limite"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeyLiebig.calcular_nutriente_limite-94"><a href="#LeyLiebig.calcular_nutriente_limite-94"><span class="linenos"> 94</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calcular_nutriente_limite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valores_registro</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="LeyLiebig.calcular_nutriente_limite-95"><a href="#LeyLiebig.calcular_nutriente_limite-95"><span class="linenos"> 95</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LeyLiebig.calcular_nutriente_limite-96"><a href="#LeyLiebig.calcular_nutriente_limite-96"><span class="linenos"> 96</span></a><span class="sd">        Identifica el nutriente más limitante según la Ley del Mínimo de Liebig.</span>
</span><span id="LeyLiebig.calcular_nutriente_limite-97"><a href="#LeyLiebig.calcular_nutriente_limite-97"><span class="linenos"> 97</span></a><span class="sd">        </span>
</span><span id="LeyLiebig.calcular_nutriente_limite-98"><a href="#LeyLiebig.calcular_nutriente_limite-98"><span class="linenos"> 98</span></a><span class="sd">        El nutriente limitante es aquel que tiene el menor porcentaje de suficiencia.</span>
</span><span id="LeyLiebig.calcular_nutriente_limite-99"><a href="#LeyLiebig.calcular_nutriente_limite-99"><span class="linenos"> 99</span></a><span class="sd">        </span>
</span><span id="LeyLiebig.calcular_nutriente_limite-100"><a href="#LeyLiebig.calcular_nutriente_limite-100"><span class="linenos">100</span></a><span class="sd">        :param valores_registro: Diccionario con los valores actuales de los nutrientes en el suelo.</span>
</span><span id="LeyLiebig.calcular_nutriente_limite-101"><a href="#LeyLiebig.calcular_nutriente_limite-101"><span class="linenos">101</span></a><span class="sd">        :return: Nombre del nutriente más limitante.</span>
</span><span id="LeyLiebig.calcular_nutriente_limite-102"><a href="#LeyLiebig.calcular_nutriente_limite-102"><span class="linenos">102</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LeyLiebig.calcular_nutriente_limite-103"><a href="#LeyLiebig.calcular_nutriente_limite-103"><span class="linenos">103</span></a>        <span class="n">valores_p</span> <span class="o">=</span> <span class="p">{</span><span class="n">mineral</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcular_p</span><span class="p">(</span><span class="n">valor</span><span class="p">)</span> <span class="k">for</span> <span class="n">mineral</span><span class="p">,</span> <span class="n">valor</span> <span class="ow">in</span> <span class="n">valores_registro</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="LeyLiebig.calcular_nutriente_limite-104"><a href="#LeyLiebig.calcular_nutriente_limite-104"><span class="linenos">104</span></a>        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">valores_p</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">valores_p</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>  <span class="c1"># Devuelve el nutriente con el menor porcentaje de suficiencia</span>
</span></pre></div>


            <div class="docstring"><p>Identifica el nutriente más limitante según la Ley del Mínimo de Liebig.</p>

<p>El nutriente limitante es aquel que tiene el menor porcentaje de suficiencia.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>valores_registro</strong>:  Diccionario con los valores actuales de los nutrientes en el suelo.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Nombre del nutriente más limitante.</p>
</blockquote>
</div>


                            </div>
                            <div id="LeyLiebig.calcular_nutrientes" class="classattr">
                                        <input id="LeyLiebig.calcular_nutrientes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calcular_nutrientes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">valores_registro</span><span class="p">:</span> <span class="nb">dict</span>, </span><span class="param"><span class="n">valores_cv</span><span class="p">:</span> <span class="nb">dict</span></span><span class="return-annotation">) -> <span class="nb">dict</span>:</span></span>

                <label class="view-source-button" for="LeyLiebig.calcular_nutrientes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeyLiebig.calcular_nutrientes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeyLiebig.calcular_nutrientes-106"><a href="#LeyLiebig.calcular_nutrientes-106"><span class="linenos">106</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calcular_nutrientes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valores_registro</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">valores_cv</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="LeyLiebig.calcular_nutrientes-107"><a href="#LeyLiebig.calcular_nutrientes-107"><span class="linenos">107</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LeyLiebig.calcular_nutrientes-108"><a href="#LeyLiebig.calcular_nutrientes-108"><span class="linenos">108</span></a><span class="sd">        Calcula los ajustes necesarios para los nutrientes del cultivo.</span>
</span><span id="LeyLiebig.calcular_nutrientes-109"><a href="#LeyLiebig.calcular_nutrientes-109"><span class="linenos">109</span></a><span class="sd">        </span>
</span><span id="LeyLiebig.calcular_nutrientes-110"><a href="#LeyLiebig.calcular_nutrientes-110"><span class="linenos">110</span></a><span class="sd">        La corrección se aplica únicamente al nutriente más limitante para respetar la Ley del Mínimo de Liebig.</span>
</span><span id="LeyLiebig.calcular_nutrientes-111"><a href="#LeyLiebig.calcular_nutrientes-111"><span class="linenos">111</span></a><span class="sd">        </span>
</span><span id="LeyLiebig.calcular_nutrientes-112"><a href="#LeyLiebig.calcular_nutrientes-112"><span class="linenos">112</span></a><span class="sd">        :param valores_registro: Diccionario con los valores actuales de los nutrientes en el suelo.</span>
</span><span id="LeyLiebig.calcular_nutrientes-113"><a href="#LeyLiebig.calcular_nutrientes-113"><span class="linenos">113</span></a><span class="sd">        :param valores_cv: Diccionario con los coeficientes de variación de cada nutriente.</span>
</span><span id="LeyLiebig.calcular_nutrientes-114"><a href="#LeyLiebig.calcular_nutrientes-114"><span class="linenos">114</span></a><span class="sd">        :return: Diccionario con los valores de suficiencia (p), ajuste necesario (i) y nivel corregido (r) de cada nutriente.</span>
</span><span id="LeyLiebig.calcular_nutrientes-115"><a href="#LeyLiebig.calcular_nutrientes-115"><span class="linenos">115</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LeyLiebig.calcular_nutrientes-116"><a href="#LeyLiebig.calcular_nutrientes-116"><span class="linenos">116</span></a>        <span class="n">nutriente_limitante</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcular_nutriente_limite</span><span class="p">(</span><span class="n">valores_registro</span><span class="p">)</span>
</span><span id="LeyLiebig.calcular_nutrientes-117"><a href="#LeyLiebig.calcular_nutrientes-117"><span class="linenos">117</span></a>        <span class="n">nutrientes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LeyLiebig.calcular_nutrientes-118"><a href="#LeyLiebig.calcular_nutrientes-118"><span class="linenos">118</span></a>        <span class="k">for</span> <span class="n">mineral</span><span class="p">,</span> <span class="n">valor_registro</span> <span class="ow">in</span> <span class="n">valores_registro</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LeyLiebig.calcular_nutrientes-119"><a href="#LeyLiebig.calcular_nutrientes-119"><span class="linenos">119</span></a>            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcular_p</span><span class="p">(</span><span class="n">valor_registro</span><span class="p">)</span>
</span><span id="LeyLiebig.calcular_nutrientes-120"><a href="#LeyLiebig.calcular_nutrientes-120"><span class="linenos">120</span></a>            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcular_i</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">valores_cv</span><span class="p">[</span><span class="n">mineral</span><span class="p">])</span> <span class="k">if</span> <span class="n">mineral</span> <span class="o">==</span> <span class="n">nutriente_limitante</span> <span class="k">else</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.00&#39;</span><span class="p">)</span>
</span><span id="LeyLiebig.calcular_nutrientes-121"><a href="#LeyLiebig.calcular_nutrientes-121"><span class="linenos">121</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcular_r</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
</span><span id="LeyLiebig.calcular_nutrientes-122"><a href="#LeyLiebig.calcular_nutrientes-122"><span class="linenos">122</span></a>            <span class="n">nutrientes</span><span class="p">[</span><span class="n">mineral</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">}</span>
</span><span id="LeyLiebig.calcular_nutrientes-123"><a href="#LeyLiebig.calcular_nutrientes-123"><span class="linenos">123</span></a>        <span class="k">return</span> <span class="n">nutrientes</span>
</span></pre></div>


            <div class="docstring"><p>Calcula los ajustes necesarios para los nutrientes del cultivo.</p>

<p>La corrección se aplica únicamente al nutriente más limitante para respetar la Ley del Mínimo de Liebig.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>valores_registro</strong>:  Diccionario con los valores actuales de los nutrientes en el suelo.</li>
<li><strong>valores_cv</strong>:  Diccionario con los coeficientes de variación de cada nutriente.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Diccionario con los valores de suficiencia (p), ajuste necesario (i) y nivel corregido (r) de cada nutriente.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="NutrientOptimizer">
                            <input id="NutrientOptimizer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">NutrientOptimizer</span>:

                <label class="view-source-button" for="NutrientOptimizer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NutrientOptimizer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NutrientOptimizer-129"><a href="#NutrientOptimizer-129"><span class="linenos">129</span></a><span class="k">class</span><span class="w"> </span><span class="nc">NutrientOptimizer</span><span class="p">:</span>
</span><span id="NutrientOptimizer-130"><a href="#NutrientOptimizer-130"><span class="linenos">130</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer-131"><a href="#NutrientOptimizer-131"><span class="linenos">131</span></a><span class="sd">    Clase que optimiza la aplicación de productos para satisfacer los requerimientos de nutrientes de un cultivo,</span>
</span><span id="NutrientOptimizer-132"><a href="#NutrientOptimizer-132"><span class="linenos">132</span></a><span class="sd">    basada en la Ley del Mínimo de Liebig y programación lineal.</span>
</span><span id="NutrientOptimizer-133"><a href="#NutrientOptimizer-133"><span class="linenos">133</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer-134"><a href="#NutrientOptimizer-134"><span class="linenos">134</span></a>
</span><span id="NutrientOptimizer-135"><a href="#NutrientOptimizer-135"><span class="linenos">135</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nutrientes_actuales</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">],</span> <span class="n">demandas_ideales</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">],</span> 
</span><span id="NutrientOptimizer-136"><a href="#NutrientOptimizer-136"><span class="linenos">136</span></a>                 <span class="n">productos_contribuciones</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]],</span> <span class="n">coeficientes_variacion</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]):</span>
</span><span id="NutrientOptimizer-137"><a href="#NutrientOptimizer-137"><span class="linenos">137</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer-138"><a href="#NutrientOptimizer-138"><span class="linenos">138</span></a><span class="sd">        Inicializa el optimizador de nutrientes.</span>
</span><span id="NutrientOptimizer-139"><a href="#NutrientOptimizer-139"><span class="linenos">139</span></a>
</span><span id="NutrientOptimizer-140"><a href="#NutrientOptimizer-140"><span class="linenos">140</span></a><span class="sd">        :param nutrientes_actuales: Diccionario con los niveles actuales de nutrientes (kg/ha o g/ha).</span>
</span><span id="NutrientOptimizer-141"><a href="#NutrientOptimizer-141"><span class="linenos">141</span></a><span class="sd">        :param demandas_ideales: Diccionario con los niveles ideales de nutrientes (kg/ha o g/ha).</span>
</span><span id="NutrientOptimizer-142"><a href="#NutrientOptimizer-142"><span class="linenos">142</span></a><span class="sd">        :param productos_contribuciones: Diccionario con los productos y sus contribuciones por nutriente.</span>
</span><span id="NutrientOptimizer-143"><a href="#NutrientOptimizer-143"><span class="linenos">143</span></a><span class="sd">        :param coeficientes_variacion: Diccionario con los coeficientes de variación por nutriente.</span>
</span><span id="NutrientOptimizer-144"><a href="#NutrientOptimizer-144"><span class="linenos">144</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer-145"><a href="#NutrientOptimizer-145"><span class="linenos">145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes_actuales</span> <span class="o">=</span> <span class="n">nutrientes_actuales</span>
</span><span id="NutrientOptimizer-146"><a href="#NutrientOptimizer-146"><span class="linenos">146</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">demandas_ideales</span> <span class="o">=</span> <span class="n">demandas_ideales</span>
</span><span id="NutrientOptimizer-147"><a href="#NutrientOptimizer-147"><span class="linenos">147</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">productos_contribuciones</span> <span class="o">=</span> <span class="n">productos_contribuciones</span>
</span><span id="NutrientOptimizer-148"><a href="#NutrientOptimizer-148"><span class="linenos">148</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeficientes_variacion</span> <span class="o">=</span> <span class="n">coeficientes_variacion</span>
</span><span id="NutrientOptimizer-149"><a href="#NutrientOptimizer-149"><span class="linenos">149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">demandas_ideales</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="NutrientOptimizer-150"><a href="#NutrientOptimizer-150"><span class="linenos">150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">productos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">productos_contribuciones</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="NutrientOptimizer-151"><a href="#NutrientOptimizer-151"><span class="linenos">151</span></a>
</span><span id="NutrientOptimizer-152"><a href="#NutrientOptimizer-152"><span class="linenos">152</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calcular_ajustes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]:</span>
</span><span id="NutrientOptimizer-153"><a href="#NutrientOptimizer-153"><span class="linenos">153</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer-154"><a href="#NutrientOptimizer-154"><span class="linenos">154</span></a><span class="sd">        Calcula los ajustes necesarios para cada nutriente usando la Ley de Liebig adaptada.</span>
</span><span id="NutrientOptimizer-155"><a href="#NutrientOptimizer-155"><span class="linenos">155</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer-156"><a href="#NutrientOptimizer-156"><span class="linenos">156</span></a>        <span class="n">ajustes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="NutrientOptimizer-157"><a href="#NutrientOptimizer-157"><span class="linenos">157</span></a>        <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes</span><span class="p">:</span>
</span><span id="NutrientOptimizer-158"><a href="#NutrientOptimizer-158"><span class="linenos">158</span></a>            <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes_actuales</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nutriente</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">))</span>
</span><span id="NutrientOptimizer-159"><a href="#NutrientOptimizer-159"><span class="linenos">159</span></a>            <span class="n">ideal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">demandas_ideales</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span>
</span><span id="NutrientOptimizer-160"><a href="#NutrientOptimizer-160"><span class="linenos">160</span></a>            <span class="k">if</span> <span class="n">actual</span> <span class="o">&lt;</span> <span class="n">ideal</span><span class="p">:</span>
</span><span id="NutrientOptimizer-161"><a href="#NutrientOptimizer-161"><span class="linenos">161</span></a>                <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">actual</span> <span class="o">/</span> <span class="n">ideal</span><span class="p">)</span> <span class="o">*</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.0&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">ideal</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-162"><a href="#NutrientOptimizer-162"><span class="linenos">162</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="p">((</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.0&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeficientes_variacion</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span> <span class="o">/</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.0&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.00&#39;</span><span class="p">),</span> <span class="n">rounding</span><span class="o">=</span><span class="n">ROUND_HALF_UP</span><span class="p">)</span>
</span><span id="NutrientOptimizer-163"><a href="#NutrientOptimizer-163"><span class="linenos">163</span></a>                <span class="n">ajustes</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ideal</span> <span class="o">-</span> <span class="n">actual</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span>  <span class="c1"># Cantidad absoluta a ajustar</span>
</span><span id="NutrientOptimizer-164"><a href="#NutrientOptimizer-164"><span class="linenos">164</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NutrientOptimizer-165"><a href="#NutrientOptimizer-165"><span class="linenos">165</span></a>                <span class="n">ajustes</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-166"><a href="#NutrientOptimizer-166"><span class="linenos">166</span></a>        <span class="k">return</span> <span class="n">ajustes</span>
</span><span id="NutrientOptimizer-167"><a href="#NutrientOptimizer-167"><span class="linenos">167</span></a>
</span><span id="NutrientOptimizer-168"><a href="#NutrientOptimizer-168"><span class="linenos">168</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">identificar_limitante</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="NutrientOptimizer-169"><a href="#NutrientOptimizer-169"><span class="linenos">169</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer-170"><a href="#NutrientOptimizer-170"><span class="linenos">170</span></a><span class="sd">        Identifica el nutriente más limitante según la Ley de Liebig.</span>
</span><span id="NutrientOptimizer-171"><a href="#NutrientOptimizer-171"><span class="linenos">171</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer-172"><a href="#NutrientOptimizer-172"><span class="linenos">172</span></a>        <span class="n">porcentajes</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="NutrientOptimizer-173"><a href="#NutrientOptimizer-173"><span class="linenos">173</span></a>            <span class="n">nutriente</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nutrientes_actuales</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nutriente</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">demandas_ideales</span><span class="p">[</span><span class="n">nutriente</span><span class="p">])</span> <span class="o">*</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.0&#39;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-174"><a href="#NutrientOptimizer-174"><span class="linenos">174</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">demandas_ideales</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-175"><a href="#NutrientOptimizer-175"><span class="linenos">175</span></a>            <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes</span>
</span><span id="NutrientOptimizer-176"><a href="#NutrientOptimizer-176"><span class="linenos">176</span></a>        <span class="p">}</span>
</span><span id="NutrientOptimizer-177"><a href="#NutrientOptimizer-177"><span class="linenos">177</span></a>        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">porcentajes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">porcentajes</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
</span><span id="NutrientOptimizer-178"><a href="#NutrientOptimizer-178"><span class="linenos">178</span></a>
</span><span id="NutrientOptimizer-179"><a href="#NutrientOptimizer-179"><span class="linenos">179</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_solucion_heuristica</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ajustes_positivos</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]:</span>
</span><span id="NutrientOptimizer-180"><a href="#NutrientOptimizer-180"><span class="linenos">180</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Solución heurística cuando la optimización falla&quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer-181"><a href="#NutrientOptimizer-181"><span class="linenos">181</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Aplicando solución heurística...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-182"><a href="#NutrientOptimizer-182"><span class="linenos">182</span></a>        <span class="n">cantidades</span> <span class="o">=</span> <span class="p">{</span><span class="n">prod</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">}</span>
</span><span id="NutrientOptimizer-183"><a href="#NutrientOptimizer-183"><span class="linenos">183</span></a>        
</span><span id="NutrientOptimizer-184"><a href="#NutrientOptimizer-184"><span class="linenos">184</span></a>        <span class="k">for</span> <span class="n">nutriente</span><span class="p">,</span> <span class="n">requerido</span> <span class="ow">in</span> <span class="n">ajustes_positivos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="NutrientOptimizer-185"><a href="#NutrientOptimizer-185"><span class="linenos">185</span></a>            <span class="c1"># Encontrar el producto más eficiente para este nutriente</span>
</span><span id="NutrientOptimizer-186"><a href="#NutrientOptimizer-186"><span class="linenos">186</span></a>            <span class="n">mejor_producto</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="NutrientOptimizer-187"><a href="#NutrientOptimizer-187"><span class="linenos">187</span></a>            <span class="n">mejor_eficiencia</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-188"><a href="#NutrientOptimizer-188"><span class="linenos">188</span></a>            
</span><span id="NutrientOptimizer-189"><a href="#NutrientOptimizer-189"><span class="linenos">189</span></a>            <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">:</span>
</span><span id="NutrientOptimizer-190"><a href="#NutrientOptimizer-190"><span class="linenos">190</span></a>                <span class="n">contrib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos_contribuciones</span><span class="p">[</span><span class="n">prod</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nutriente</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">))</span>
</span><span id="NutrientOptimizer-191"><a href="#NutrientOptimizer-191"><span class="linenos">191</span></a>                <span class="k">if</span> <span class="n">contrib</span> <span class="o">&gt;</span> <span class="n">mejor_eficiencia</span><span class="p">:</span>
</span><span id="NutrientOptimizer-192"><a href="#NutrientOptimizer-192"><span class="linenos">192</span></a>                    <span class="n">mejor_eficiencia</span> <span class="o">=</span> <span class="n">contrib</span>
</span><span id="NutrientOptimizer-193"><a href="#NutrientOptimizer-193"><span class="linenos">193</span></a>                    <span class="n">mejor_producto</span> <span class="o">=</span> <span class="n">prod</span>
</span><span id="NutrientOptimizer-194"><a href="#NutrientOptimizer-194"><span class="linenos">194</span></a>            
</span><span id="NutrientOptimizer-195"><a href="#NutrientOptimizer-195"><span class="linenos">195</span></a>            <span class="k">if</span> <span class="n">mejor_producto</span> <span class="ow">and</span> <span class="n">mejor_eficiencia</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="NutrientOptimizer-196"><a href="#NutrientOptimizer-196"><span class="linenos">196</span></a>                <span class="n">cantidad_necesaria</span> <span class="o">=</span> <span class="n">requerido</span> <span class="o">/</span> <span class="n">mejor_eficiencia</span>
</span><span id="NutrientOptimizer-197"><a href="#NutrientOptimizer-197"><span class="linenos">197</span></a>                <span class="n">cantidades</span><span class="p">[</span><span class="n">mejor_producto</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cantidades</span><span class="p">[</span><span class="n">mejor_producto</span><span class="p">],</span> <span class="n">cantidad_necesaria</span><span class="p">)</span>
</span><span id="NutrientOptimizer-198"><a href="#NutrientOptimizer-198"><span class="linenos">198</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Heurística: </span><span class="si">{</span><span class="n">mejor_producto</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">cantidad_necesaria</span><span class="si">}</span><span class="s2"> para </span><span class="si">{</span><span class="n">nutriente</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-199"><a href="#NutrientOptimizer-199"><span class="linenos">199</span></a>        
</span><span id="NutrientOptimizer-200"><a href="#NutrientOptimizer-200"><span class="linenos">200</span></a>        <span class="k">return</span> <span class="n">cantidades</span>
</span><span id="NutrientOptimizer-201"><a href="#NutrientOptimizer-201"><span class="linenos">201</span></a>
</span><span id="NutrientOptimizer-202"><a href="#NutrientOptimizer-202"><span class="linenos">202</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">optimizar_productos</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]]:</span>
</span><span id="NutrientOptimizer-203"><a href="#NutrientOptimizer-203"><span class="linenos">203</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NutrientOptimizer-204"><a href="#NutrientOptimizer-204"><span class="linenos">204</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Iniciando optimización de productos...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-205"><a href="#NutrientOptimizer-205"><span class="linenos">205</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">:</span>
</span><span id="NutrientOptimizer-206"><a href="#NutrientOptimizer-206"><span class="linenos">206</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No products available for optimization. Cannot generate recommendation.&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-207"><a href="#NutrientOptimizer-207"><span class="linenos">207</span></a>            
</span><span id="NutrientOptimizer-208"><a href="#NutrientOptimizer-208"><span class="linenos">208</span></a>            <span class="n">ajustes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcular_ajustes</span><span class="p">()</span>
</span><span id="NutrientOptimizer-209"><a href="#NutrientOptimizer-209"><span class="linenos">209</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ajustes calculados:&quot;</span><span class="p">,</span> <span class="n">ajustes</span><span class="p">)</span>
</span><span id="NutrientOptimizer-210"><a href="#NutrientOptimizer-210"><span class="linenos">210</span></a>            
</span><span id="NutrientOptimizer-211"><a href="#NutrientOptimizer-211"><span class="linenos">211</span></a>            <span class="c1"># Filtrar solo ajustes positivos (nutrientes que necesitan ser agregados)</span>
</span><span id="NutrientOptimizer-212"><a href="#NutrientOptimizer-212"><span class="linenos">212</span></a>            <span class="n">ajustes_positivos</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ajustes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="NutrientOptimizer-213"><a href="#NutrientOptimizer-213"><span class="linenos">213</span></a>            
</span><span id="NutrientOptimizer-214"><a href="#NutrientOptimizer-214"><span class="linenos">214</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">ajustes_positivos</span><span class="p">:</span>
</span><span id="NutrientOptimizer-215"><a href="#NutrientOptimizer-215"><span class="linenos">215</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No hay nutrientes que necesiten ser agregados.&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-216"><a href="#NutrientOptimizer-216"><span class="linenos">216</span></a>                <span class="k">return</span> <span class="p">{</span><span class="n">prod</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">},</span> \
</span><span id="NutrientOptimizer-217"><a href="#NutrientOptimizer-217"><span class="linenos">217</span></a>                       <span class="p">{</span><span class="n">nutriente</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes</span><span class="p">}</span>
</span><span id="NutrientOptimizer-218"><a href="#NutrientOptimizer-218"><span class="linenos">218</span></a>            
</span><span id="NutrientOptimizer-219"><a href="#NutrientOptimizer-219"><span class="linenos">219</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nutrientes a optimizar: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">ajustes_positivos</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-220"><a href="#NutrientOptimizer-220"><span class="linenos">220</span></a>            
</span><span id="NutrientOptimizer-221"><a href="#NutrientOptimizer-221"><span class="linenos">221</span></a>            <span class="c1"># Verificar que hay productos que pueden aportar los nutrientes necesarios</span>
</span><span id="NutrientOptimizer-222"><a href="#NutrientOptimizer-222"><span class="linenos">222</span></a>            <span class="n">productos_utiles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="NutrientOptimizer-223"><a href="#NutrientOptimizer-223"><span class="linenos">223</span></a>            <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="n">ajustes_positivos</span><span class="p">:</span>
</span><span id="NutrientOptimizer-224"><a href="#NutrientOptimizer-224"><span class="linenos">224</span></a>                <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">:</span>
</span><span id="NutrientOptimizer-225"><a href="#NutrientOptimizer-225"><span class="linenos">225</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos_contribuciones</span><span class="p">[</span><span class="n">prod</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nutriente</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="NutrientOptimizer-226"><a href="#NutrientOptimizer-226"><span class="linenos">226</span></a>                        <span class="n">productos_utiles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">prod</span><span class="p">)</span>
</span><span id="NutrientOptimizer-227"><a href="#NutrientOptimizer-227"><span class="linenos">227</span></a>            
</span><span id="NutrientOptimizer-228"><a href="#NutrientOptimizer-228"><span class="linenos">228</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">productos_utiles</span><span class="p">:</span>
</span><span id="NutrientOptimizer-229"><a href="#NutrientOptimizer-229"><span class="linenos">229</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No hay productos que puedan aportar los nutrientes necesarios.&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-230"><a href="#NutrientOptimizer-230"><span class="linenos">230</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Los productos disponibles no pueden satisfacer los requerimientos nutricionales.&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-231"><a href="#NutrientOptimizer-231"><span class="linenos">231</span></a>            
</span><span id="NutrientOptimizer-232"><a href="#NutrientOptimizer-232"><span class="linenos">232</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Productos útiles: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">productos_utiles</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-233"><a href="#NutrientOptimizer-233"><span class="linenos">233</span></a>            
</span><span id="NutrientOptimizer-234"><a href="#NutrientOptimizer-234"><span class="linenos">234</span></a>            <span class="c1"># Coeficientes de la función objetivo (minimizar la suma de productos)</span>
</span><span id="NutrientOptimizer-235"><a href="#NutrientOptimizer-235"><span class="linenos">235</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Definiendo función objetivo...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-236"><a href="#NutrientOptimizer-236"><span class="linenos">236</span></a>            <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">)</span>
</span><span id="NutrientOptimizer-237"><a href="#NutrientOptimizer-237"><span class="linenos">237</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Coeficientes de la función objetivo:&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span id="NutrientOptimizer-238"><a href="#NutrientOptimizer-238"><span class="linenos">238</span></a>            
</span><span id="NutrientOptimizer-239"><a href="#NutrientOptimizer-239"><span class="linenos">239</span></a>            <span class="c1"># Matriz de restricciones de desigualdad (A_ub * x &gt;= b_ub)</span>
</span><span id="NutrientOptimizer-240"><a href="#NutrientOptimizer-240"><span class="linenos">240</span></a>            <span class="c1"># Para linprog necesitamos A_ub * x &lt;= b_ub, así que usamos -A_ub * x &lt;= -b_ub</span>
</span><span id="NutrientOptimizer-241"><a href="#NutrientOptimizer-241"><span class="linenos">241</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Definiendo restricciones de desigualdad...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-242"><a href="#NutrientOptimizer-242"><span class="linenos">242</span></a>            <span class="n">A_ub</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NutrientOptimizer-243"><a href="#NutrientOptimizer-243"><span class="linenos">243</span></a>            <span class="n">b_ub</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NutrientOptimizer-244"><a href="#NutrientOptimizer-244"><span class="linenos">244</span></a>            
</span><span id="NutrientOptimizer-245"><a href="#NutrientOptimizer-245"><span class="linenos">245</span></a>            <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="n">ajustes_positivos</span><span class="p">:</span>
</span><span id="NutrientOptimizer-246"><a href="#NutrientOptimizer-246"><span class="linenos">246</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restricción para </span><span class="si">{</span><span class="n">nutriente</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-247"><a href="#NutrientOptimizer-247"><span class="linenos">247</span></a>                <span class="n">fila</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NutrientOptimizer-248"><a href="#NutrientOptimizer-248"><span class="linenos">248</span></a>                <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">:</span>
</span><span id="NutrientOptimizer-249"><a href="#NutrientOptimizer-249"><span class="linenos">249</span></a>                    <span class="n">contrib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos_contribuciones</span><span class="p">[</span><span class="n">prod</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nutriente</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">))</span>
</span><span id="NutrientOptimizer-250"><a href="#NutrientOptimizer-250"><span class="linenos">250</span></a>                    <span class="n">fila</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">contrib</span><span class="p">))</span>  <span class="c1"># Negativo para convertir &gt;= en &lt;=</span>
</span><span id="NutrientOptimizer-251"><a href="#NutrientOptimizer-251"><span class="linenos">251</span></a>                
</span><span id="NutrientOptimizer-252"><a href="#NutrientOptimizer-252"><span class="linenos">252</span></a>                <span class="c1"># Solo agregar restricción si al menos un producto puede aportar este nutriente</span>
</span><span id="NutrientOptimizer-253"><a href="#NutrientOptimizer-253"><span class="linenos">253</span></a>                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">fila</span><span class="p">):</span>  <span class="c1"># Al menos una contribución positiva</span>
</span><span id="NutrientOptimizer-254"><a href="#NutrientOptimizer-254"><span class="linenos">254</span></a>                    <span class="n">A_ub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fila</span><span class="p">)</span>
</span><span id="NutrientOptimizer-255"><a href="#NutrientOptimizer-255"><span class="linenos">255</span></a>                    <span class="n">b_ub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">ajustes_positivos</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]))</span>  <span class="c1"># Negativo para convertir &gt;= en &lt;=</span>
</span><span id="NutrientOptimizer-256"><a href="#NutrientOptimizer-256"><span class="linenos">256</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coeficientes de la restricción: </span><span class="si">{</span><span class="n">fila</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-257"><a href="#NutrientOptimizer-257"><span class="linenos">257</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valor de la restricción: </span><span class="si">{</span><span class="n">b_ub</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-258"><a href="#NutrientOptimizer-258"><span class="linenos">258</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="NutrientOptimizer-259"><a href="#NutrientOptimizer-259"><span class="linenos">259</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Advertencia: No hay productos que aporten </span><span class="si">{</span><span class="n">nutriente</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-260"><a href="#NutrientOptimizer-260"><span class="linenos">260</span></a>            
</span><span id="NutrientOptimizer-261"><a href="#NutrientOptimizer-261"><span class="linenos">261</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">A_ub</span><span class="p">:</span>
</span><span id="NutrientOptimizer-262"><a href="#NutrientOptimizer-262"><span class="linenos">262</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No se pudieron formar restricciones válidas&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-263"><a href="#NutrientOptimizer-263"><span class="linenos">263</span></a>                <span class="n">cantidades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solucion_heuristica</span><span class="p">(</span><span class="n">ajustes_positivos</span><span class="p">)</span>
</span><span id="NutrientOptimizer-264"><a href="#NutrientOptimizer-264"><span class="linenos">264</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NutrientOptimizer-265"><a href="#NutrientOptimizer-265"><span class="linenos">265</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz de restricciones:&quot;</span><span class="p">,</span> <span class="n">A_ub</span><span class="p">)</span>
</span><span id="NutrientOptimizer-266"><a href="#NutrientOptimizer-266"><span class="linenos">266</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Valores de las restricciones:&quot;</span><span class="p">,</span> <span class="n">b_ub</span><span class="p">)</span>
</span><span id="NutrientOptimizer-267"><a href="#NutrientOptimizer-267"><span class="linenos">267</span></a>                
</span><span id="NutrientOptimizer-268"><a href="#NutrientOptimizer-268"><span class="linenos">268</span></a>                <span class="c1"># Límites (cantidades &gt;= 0)</span>
</span><span id="NutrientOptimizer-269"><a href="#NutrientOptimizer-269"><span class="linenos">269</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Definiendo límites...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-270"><a href="#NutrientOptimizer-270"><span class="linenos">270</span></a>                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">)</span>
</span><span id="NutrientOptimizer-271"><a href="#NutrientOptimizer-271"><span class="linenos">271</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Límites:&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span>
</span><span id="NutrientOptimizer-272"><a href="#NutrientOptimizer-272"><span class="linenos">272</span></a>                
</span><span id="NutrientOptimizer-273"><a href="#NutrientOptimizer-273"><span class="linenos">273</span></a>                <span class="c1"># Resolver optimización</span>
</span><span id="NutrientOptimizer-274"><a href="#NutrientOptimizer-274"><span class="linenos">274</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resolviendo problema de programación lineal...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-275"><a href="#NutrientOptimizer-275"><span class="linenos">275</span></a>                <span class="n">res</span> <span class="o">=</span> <span class="n">linprog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">A_ub</span><span class="o">=</span><span class="n">A_ub</span><span class="p">,</span> <span class="n">b_ub</span><span class="o">=</span><span class="n">b_ub</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;highs&#39;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-276"><a href="#NutrientOptimizer-276"><span class="linenos">276</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultado de la optimización:&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
</span><span id="NutrientOptimizer-277"><a href="#NutrientOptimizer-277"><span class="linenos">277</span></a>                
</span><span id="NutrientOptimizer-278"><a href="#NutrientOptimizer-278"><span class="linenos">278</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
</span><span id="NutrientOptimizer-279"><a href="#NutrientOptimizer-279"><span class="linenos">279</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error en la optimización:&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</span><span id="NutrientOptimizer-280"><a href="#NutrientOptimizer-280"><span class="linenos">280</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intentando con método alternativo...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-281"><a href="#NutrientOptimizer-281"><span class="linenos">281</span></a>                    
</span><span id="NutrientOptimizer-282"><a href="#NutrientOptimizer-282"><span class="linenos">282</span></a>                    <span class="c1"># Intentar con método alternativo</span>
</span><span id="NutrientOptimizer-283"><a href="#NutrientOptimizer-283"><span class="linenos">283</span></a>                    <span class="n">res</span> <span class="o">=</span> <span class="n">linprog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">A_ub</span><span class="o">=</span><span class="n">A_ub</span><span class="p">,</span> <span class="n">b_ub</span><span class="o">=</span><span class="n">b_ub</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;interior-point&#39;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-284"><a href="#NutrientOptimizer-284"><span class="linenos">284</span></a>                    
</span><span id="NutrientOptimizer-285"><a href="#NutrientOptimizer-285"><span class="linenos">285</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
</span><span id="NutrientOptimizer-286"><a href="#NutrientOptimizer-286"><span class="linenos">286</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error con método alternativo:&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</span><span id="NutrientOptimizer-287"><a href="#NutrientOptimizer-287"><span class="linenos">287</span></a>                        
</span><span id="NutrientOptimizer-288"><a href="#NutrientOptimizer-288"><span class="linenos">288</span></a>                        <span class="c1"># Como último recurso, intentar relajar las restricciones</span>
</span><span id="NutrientOptimizer-289"><a href="#NutrientOptimizer-289"><span class="linenos">289</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intentando con restricciones relajadas...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-290"><a href="#NutrientOptimizer-290"><span class="linenos">290</span></a>                        <span class="c1"># Reducir los requerimientos en un 20%</span>
</span><span id="NutrientOptimizer-291"><a href="#NutrientOptimizer-291"><span class="linenos">291</span></a>                        <span class="n">b_ub_relajado</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="o">*</span> <span class="mf">0.8</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">b_ub</span><span class="p">]</span>
</span><span id="NutrientOptimizer-292"><a href="#NutrientOptimizer-292"><span class="linenos">292</span></a>                        <span class="n">res</span> <span class="o">=</span> <span class="n">linprog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">A_ub</span><span class="o">=</span><span class="n">A_ub</span><span class="p">,</span> <span class="n">b_ub</span><span class="o">=</span><span class="n">b_ub_relajado</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;highs&#39;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-293"><a href="#NutrientOptimizer-293"><span class="linenos">293</span></a>                        
</span><span id="NutrientOptimizer-294"><a href="#NutrientOptimizer-294"><span class="linenos">294</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
</span><span id="NutrientOptimizer-295"><a href="#NutrientOptimizer-295"><span class="linenos">295</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización falló completamente: </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-296"><a href="#NutrientOptimizer-296"><span class="linenos">296</span></a>                            <span class="n">cantidades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solucion_heuristica</span><span class="p">(</span><span class="n">ajustes_positivos</span><span class="p">)</span>
</span><span id="NutrientOptimizer-297"><a href="#NutrientOptimizer-297"><span class="linenos">297</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="NutrientOptimizer-298"><a href="#NutrientOptimizer-298"><span class="linenos">298</span></a>                            <span class="n">cantidades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_procesar_resultado_optimizacion</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span><span id="NutrientOptimizer-299"><a href="#NutrientOptimizer-299"><span class="linenos">299</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="NutrientOptimizer-300"><a href="#NutrientOptimizer-300"><span class="linenos">300</span></a>                        <span class="n">cantidades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_procesar_resultado_optimizacion</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span><span id="NutrientOptimizer-301"><a href="#NutrientOptimizer-301"><span class="linenos">301</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="NutrientOptimizer-302"><a href="#NutrientOptimizer-302"><span class="linenos">302</span></a>                    <span class="n">cantidades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_procesar_resultado_optimizacion</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span><span id="NutrientOptimizer-303"><a href="#NutrientOptimizer-303"><span class="linenos">303</span></a>            
</span><span id="NutrientOptimizer-304"><a href="#NutrientOptimizer-304"><span class="linenos">304</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cantidades de productos:&quot;</span><span class="p">,</span> <span class="n">cantidades</span><span class="p">)</span>
</span><span id="NutrientOptimizer-305"><a href="#NutrientOptimizer-305"><span class="linenos">305</span></a>            
</span><span id="NutrientOptimizer-306"><a href="#NutrientOptimizer-306"><span class="linenos">306</span></a>            <span class="c1"># Calcular nutrientes aportados</span>
</span><span id="NutrientOptimizer-307"><a href="#NutrientOptimizer-307"><span class="linenos">307</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculando nutrientes aportados...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-308"><a href="#NutrientOptimizer-308"><span class="linenos">308</span></a>            <span class="n">nutrientes_aportados</span> <span class="o">=</span> <span class="p">{</span><span class="n">nutriente</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes</span><span class="p">}</span>
</span><span id="NutrientOptimizer-309"><a href="#NutrientOptimizer-309"><span class="linenos">309</span></a>            <span class="k">for</span> <span class="n">prod</span><span class="p">,</span> <span class="n">cantidad</span> <span class="ow">in</span> <span class="n">cantidades</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="NutrientOptimizer-310"><a href="#NutrientOptimizer-310"><span class="linenos">310</span></a>                <span class="k">if</span> <span class="n">cantidad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="NutrientOptimizer-311"><a href="#NutrientOptimizer-311"><span class="linenos">311</span></a>                    <span class="k">for</span> <span class="n">nutriente</span><span class="p">,</span> <span class="n">contrib</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos_contribuciones</span><span class="p">[</span><span class="n">prod</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="NutrientOptimizer-312"><a href="#NutrientOptimizer-312"><span class="linenos">312</span></a>                        <span class="n">nutrientes_aportados</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span> <span class="o">+=</span> <span class="n">contrib</span> <span class="o">*</span> <span class="n">cantidad</span>
</span><span id="NutrientOptimizer-313"><a href="#NutrientOptimizer-313"><span class="linenos">313</span></a>            
</span><span id="NutrientOptimizer-314"><a href="#NutrientOptimizer-314"><span class="linenos">314</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Nutrientes aportados:&quot;</span><span class="p">,</span> <span class="n">nutrientes_aportados</span><span class="p">)</span>
</span><span id="NutrientOptimizer-315"><a href="#NutrientOptimizer-315"><span class="linenos">315</span></a>            
</span><span id="NutrientOptimizer-316"><a href="#NutrientOptimizer-316"><span class="linenos">316</span></a>            <span class="c1"># Verificar que se cumplan los requerimientos mínimos</span>
</span><span id="NutrientOptimizer-317"><a href="#NutrientOptimizer-317"><span class="linenos">317</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Verificando cumplimiento de requerimientos...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-318"><a href="#NutrientOptimizer-318"><span class="linenos">318</span></a>            <span class="k">for</span> <span class="n">nutriente</span><span class="p">,</span> <span class="n">requerido</span> <span class="ow">in</span> <span class="n">ajustes_positivos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="NutrientOptimizer-319"><a href="#NutrientOptimizer-319"><span class="linenos">319</span></a>                <span class="n">aportado</span> <span class="o">=</span> <span class="n">nutrientes_aportados</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nutriente</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">))</span>
</span><span id="NutrientOptimizer-320"><a href="#NutrientOptimizer-320"><span class="linenos">320</span></a>                <span class="n">cumplimiento</span> <span class="o">=</span> <span class="p">(</span><span class="n">aportado</span> <span class="o">/</span> <span class="n">requerido</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">requerido</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.0&#39;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-321"><a href="#NutrientOptimizer-321"><span class="linenos">321</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nutriente</span><span class="si">}</span><span class="s2">: Requerido=</span><span class="si">{</span><span class="n">requerido</span><span class="si">}</span><span class="s2">, Aportado=</span><span class="si">{</span><span class="n">aportado</span><span class="si">}</span><span class="s2">, Cumplimiento=</span><span class="si">{</span><span class="n">cumplimiento</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-322"><a href="#NutrientOptimizer-322"><span class="linenos">322</span></a>            
</span><span id="NutrientOptimizer-323"><a href="#NutrientOptimizer-323"><span class="linenos">323</span></a>            <span class="k">return</span> <span class="n">cantidades</span><span class="p">,</span> <span class="n">nutrientes_aportados</span>
</span><span id="NutrientOptimizer-324"><a href="#NutrientOptimizer-324"><span class="linenos">324</span></a>            
</span><span id="NutrientOptimizer-325"><a href="#NutrientOptimizer-325"><span class="linenos">325</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="NutrientOptimizer-326"><a href="#NutrientOptimizer-326"><span class="linenos">326</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error en la optimización:&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="NutrientOptimizer-327"><a href="#NutrientOptimizer-327"><span class="linenos">327</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
</span><span id="NutrientOptimizer-328"><a href="#NutrientOptimizer-328"><span class="linenos">328</span></a>            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</span><span id="NutrientOptimizer-329"><a href="#NutrientOptimizer-329"><span class="linenos">329</span></a>            <span class="k">raise</span>
</span><span id="NutrientOptimizer-330"><a href="#NutrientOptimizer-330"><span class="linenos">330</span></a>
</span><span id="NutrientOptimizer-331"><a href="#NutrientOptimizer-331"><span class="linenos">331</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_procesar_resultado_optimizacion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]:</span>
</span><span id="NutrientOptimizer-332"><a href="#NutrientOptimizer-332"><span class="linenos">332</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Procesa el resultado de la optimización lineal&quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer-333"><a href="#NutrientOptimizer-333"><span class="linenos">333</span></a>        <span class="c1"># Verificar que la solución no sea trivial (todos ceros)</span>
</span><span id="NutrientOptimizer-334"><a href="#NutrientOptimizer-334"><span class="linenos">334</span></a>        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mf">1e-6</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">):</span>
</span><span id="NutrientOptimizer-335"><a href="#NutrientOptimizer-335"><span class="linenos">335</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;La solución es trivial (todos los valores son cero)&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-336"><a href="#NutrientOptimizer-336"><span class="linenos">336</span></a>            <span class="k">return</span> <span class="p">{</span><span class="n">prod</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">}</span>
</span><span id="NutrientOptimizer-337"><a href="#NutrientOptimizer-337"><span class="linenos">337</span></a>        
</span><span id="NutrientOptimizer-338"><a href="#NutrientOptimizer-338"><span class="linenos">338</span></a>        <span class="c1"># Resultados: cantidades de productos</span>
</span><span id="NutrientOptimizer-339"><a href="#NutrientOptimizer-339"><span class="linenos">339</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculando cantidades de productos...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-340"><a href="#NutrientOptimizer-340"><span class="linenos">340</span></a>        <span class="n">cantidades</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="NutrientOptimizer-341"><a href="#NutrientOptimizer-341"><span class="linenos">341</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">):</span>
</span><span id="NutrientOptimizer-342"><a href="#NutrientOptimizer-342"><span class="linenos">342</span></a>            <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>  <span class="c1"># Solo incluir cantidades significativas</span>
</span><span id="NutrientOptimizer-343"><a href="#NutrientOptimizer-343"><span class="linenos">343</span></a>                <span class="n">cantidades</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
</span><span id="NutrientOptimizer-344"><a href="#NutrientOptimizer-344"><span class="linenos">344</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NutrientOptimizer-345"><a href="#NutrientOptimizer-345"><span class="linenos">345</span></a>                <span class="n">cantidades</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-346"><a href="#NutrientOptimizer-346"><span class="linenos">346</span></a>        
</span><span id="NutrientOptimizer-347"><a href="#NutrientOptimizer-347"><span class="linenos">347</span></a>        <span class="k">return</span> <span class="n">cantidades</span>
</span><span id="NutrientOptimizer-348"><a href="#NutrientOptimizer-348"><span class="linenos">348</span></a>
</span><span id="NutrientOptimizer-349"><a href="#NutrientOptimizer-349"><span class="linenos">349</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generar_recomendacion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lot_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="NutrientOptimizer-350"><a href="#NutrientOptimizer-350"><span class="linenos">350</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer-351"><a href="#NutrientOptimizer-351"><span class="linenos">351</span></a><span class="sd">        Genera una recomendación para aplicar en el lote.</span>
</span><span id="NutrientOptimizer-352"><a href="#NutrientOptimizer-352"><span class="linenos">352</span></a><span class="sd">        </span>
</span><span id="NutrientOptimizer-353"><a href="#NutrientOptimizer-353"><span class="linenos">353</span></a><span class="sd">        :param lot_id: ID del lote donde se aplicará la recomendación.</span>
</span><span id="NutrientOptimizer-354"><a href="#NutrientOptimizer-354"><span class="linenos">354</span></a><span class="sd">        :return: Texto de la recomendación.</span>
</span><span id="NutrientOptimizer-355"><a href="#NutrientOptimizer-355"><span class="linenos">355</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer-356"><a href="#NutrientOptimizer-356"><span class="linenos">356</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NutrientOptimizer-357"><a href="#NutrientOptimizer-357"><span class="linenos">357</span></a>            <span class="n">cantidades</span><span class="p">,</span> <span class="n">nutrientes_aportados</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizar_productos</span><span class="p">()</span>
</span><span id="NutrientOptimizer-358"><a href="#NutrientOptimizer-358"><span class="linenos">358</span></a>            
</span><span id="NutrientOptimizer-359"><a href="#NutrientOptimizer-359"><span class="linenos">359</span></a>            <span class="n">lineas</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Aplicar en el lote </span><span class="si">{</span><span class="n">lot_id</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">]</span>
</span><span id="NutrientOptimizer-360"><a href="#NutrientOptimizer-360"><span class="linenos">360</span></a>            
</span><span id="NutrientOptimizer-361"><a href="#NutrientOptimizer-361"><span class="linenos">361</span></a>            <span class="c1"># Solo mostrar productos con cantidades significativas</span>
</span><span id="NutrientOptimizer-362"><a href="#NutrientOptimizer-362"><span class="linenos">362</span></a>            <span class="n">productos_aplicar</span> <span class="o">=</span> <span class="p">{</span><span class="n">prod</span><span class="p">:</span> <span class="n">cant</span> <span class="k">for</span> <span class="n">prod</span><span class="p">,</span> <span class="n">cant</span> <span class="ow">in</span> <span class="n">cantidades</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">cant</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="NutrientOptimizer-363"><a href="#NutrientOptimizer-363"><span class="linenos">363</span></a>            
</span><span id="NutrientOptimizer-364"><a href="#NutrientOptimizer-364"><span class="linenos">364</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">productos_aplicar</span><span class="p">:</span>
</span><span id="NutrientOptimizer-365"><a href="#NutrientOptimizer-365"><span class="linenos">365</span></a>                <span class="n">lineas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;- No se requiere aplicación de productos adicionales&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-366"><a href="#NutrientOptimizer-366"><span class="linenos">366</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NutrientOptimizer-367"><a href="#NutrientOptimizer-367"><span class="linenos">367</span></a>                <span class="k">for</span> <span class="n">prod</span><span class="p">,</span> <span class="n">cantidad</span> <span class="ow">in</span> <span class="n">productos_aplicar</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="NutrientOptimizer-368"><a href="#NutrientOptimizer-368"><span class="linenos">368</span></a>                    <span class="n">lineas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">cantidad</span><span class="si">}</span><span class="s2"> unidades de </span><span class="si">{</span><span class="n">prod</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-369"><a href="#NutrientOptimizer-369"><span class="linenos">369</span></a>            
</span><span id="NutrientOptimizer-370"><a href="#NutrientOptimizer-370"><span class="linenos">370</span></a>            <span class="n">lineas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Nutrientes aportados:&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-371"><a href="#NutrientOptimizer-371"><span class="linenos">371</span></a>            <span class="k">for</span> <span class="n">nutriente</span><span class="p">,</span> <span class="n">cantidad</span> <span class="ow">in</span> <span class="n">nutrientes_aportados</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="NutrientOptimizer-372"><a href="#NutrientOptimizer-372"><span class="linenos">372</span></a>                <span class="k">if</span> <span class="n">cantidad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Solo mostrar nutrientes con aporte significativo</span>
</span><span id="NutrientOptimizer-373"><a href="#NutrientOptimizer-373"><span class="linenos">373</span></a>                    <span class="c1"># Asumiendo que tienes acceso a macronutrients, sino puedes ajustar esta lógica</span>
</span><span id="NutrientOptimizer-374"><a href="#NutrientOptimizer-374"><span class="linenos">374</span></a>                    <span class="n">unidad</span> <span class="o">=</span> <span class="s2">&quot;kg/ha&quot;</span>  <span class="c1"># Puedes ajustar esto según tu lógica de negocio</span>
</span><span id="NutrientOptimizer-375"><a href="#NutrientOptimizer-375"><span class="linenos">375</span></a>                    <span class="n">lineas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">nutriente</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cantidad</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unidad</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-376"><a href="#NutrientOptimizer-376"><span class="linenos">376</span></a>            
</span><span id="NutrientOptimizer-377"><a href="#NutrientOptimizer-377"><span class="linenos">377</span></a>            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lineas</span><span class="p">)</span>
</span><span id="NutrientOptimizer-378"><a href="#NutrientOptimizer-378"><span class="linenos">378</span></a>            
</span><span id="NutrientOptimizer-379"><a href="#NutrientOptimizer-379"><span class="linenos">379</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="NutrientOptimizer-380"><a href="#NutrientOptimizer-380"><span class="linenos">380</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generando recomendación: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer-381"><a href="#NutrientOptimizer-381"><span class="linenos">381</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error al generar recomendación para el lote </span><span class="si">{</span><span class="n">lot_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Clase que optimiza la aplicación de productos para satisfacer los requerimientos de nutrientes de un cultivo,
basada en la Ley del Mínimo de Liebig y programación lineal.</p>
</div>


                            <div id="NutrientOptimizer.__init__" class="classattr">
                                        <input id="NutrientOptimizer.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">NutrientOptimizer</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">nutrientes_actuales</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">]</span>,</span><span class="param">	<span class="n">demandas_ideales</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">]</span>,</span><span class="param">	<span class="n">productos_contribuciones</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">]]</span>,</span><span class="param">	<span class="n">coeficientes_variacion</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">]</span></span>)</span>

                <label class="view-source-button" for="NutrientOptimizer.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NutrientOptimizer.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NutrientOptimizer.__init__-135"><a href="#NutrientOptimizer.__init__-135"><span class="linenos">135</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nutrientes_actuales</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">],</span> <span class="n">demandas_ideales</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">],</span> 
</span><span id="NutrientOptimizer.__init__-136"><a href="#NutrientOptimizer.__init__-136"><span class="linenos">136</span></a>                 <span class="n">productos_contribuciones</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]],</span> <span class="n">coeficientes_variacion</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]):</span>
</span><span id="NutrientOptimizer.__init__-137"><a href="#NutrientOptimizer.__init__-137"><span class="linenos">137</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer.__init__-138"><a href="#NutrientOptimizer.__init__-138"><span class="linenos">138</span></a><span class="sd">        Inicializa el optimizador de nutrientes.</span>
</span><span id="NutrientOptimizer.__init__-139"><a href="#NutrientOptimizer.__init__-139"><span class="linenos">139</span></a>
</span><span id="NutrientOptimizer.__init__-140"><a href="#NutrientOptimizer.__init__-140"><span class="linenos">140</span></a><span class="sd">        :param nutrientes_actuales: Diccionario con los niveles actuales de nutrientes (kg/ha o g/ha).</span>
</span><span id="NutrientOptimizer.__init__-141"><a href="#NutrientOptimizer.__init__-141"><span class="linenos">141</span></a><span class="sd">        :param demandas_ideales: Diccionario con los niveles ideales de nutrientes (kg/ha o g/ha).</span>
</span><span id="NutrientOptimizer.__init__-142"><a href="#NutrientOptimizer.__init__-142"><span class="linenos">142</span></a><span class="sd">        :param productos_contribuciones: Diccionario con los productos y sus contribuciones por nutriente.</span>
</span><span id="NutrientOptimizer.__init__-143"><a href="#NutrientOptimizer.__init__-143"><span class="linenos">143</span></a><span class="sd">        :param coeficientes_variacion: Diccionario con los coeficientes de variación por nutriente.</span>
</span><span id="NutrientOptimizer.__init__-144"><a href="#NutrientOptimizer.__init__-144"><span class="linenos">144</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer.__init__-145"><a href="#NutrientOptimizer.__init__-145"><span class="linenos">145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes_actuales</span> <span class="o">=</span> <span class="n">nutrientes_actuales</span>
</span><span id="NutrientOptimizer.__init__-146"><a href="#NutrientOptimizer.__init__-146"><span class="linenos">146</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">demandas_ideales</span> <span class="o">=</span> <span class="n">demandas_ideales</span>
</span><span id="NutrientOptimizer.__init__-147"><a href="#NutrientOptimizer.__init__-147"><span class="linenos">147</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">productos_contribuciones</span> <span class="o">=</span> <span class="n">productos_contribuciones</span>
</span><span id="NutrientOptimizer.__init__-148"><a href="#NutrientOptimizer.__init__-148"><span class="linenos">148</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coeficientes_variacion</span> <span class="o">=</span> <span class="n">coeficientes_variacion</span>
</span><span id="NutrientOptimizer.__init__-149"><a href="#NutrientOptimizer.__init__-149"><span class="linenos">149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">demandas_ideales</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="NutrientOptimizer.__init__-150"><a href="#NutrientOptimizer.__init__-150"><span class="linenos">150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">productos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">productos_contribuciones</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span></pre></div>


            <div class="docstring"><p>Inicializa el optimizador de nutrientes.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>nutrientes_actuales</strong>:  Diccionario con los niveles actuales de nutrientes (kg/ha o g/ha).</li>
<li><strong>demandas_ideales</strong>:  Diccionario con los niveles ideales de nutrientes (kg/ha o g/ha).</li>
<li><strong>productos_contribuciones</strong>:  Diccionario con los productos y sus contribuciones por nutriente.</li>
<li><strong>coeficientes_variacion</strong>:  Diccionario con los coeficientes de variación por nutriente.</li>
</ul>
</div>


                            </div>
                            <div id="NutrientOptimizer.nutrientes_actuales" class="classattr">
                                <div class="attr variable">
            <span class="name">nutrientes_actuales</span>

        
    </div>
    <a class="headerlink" href="#NutrientOptimizer.nutrientes_actuales"></a>
    
    

                            </div>
                            <div id="NutrientOptimizer.demandas_ideales" class="classattr">
                                <div class="attr variable">
            <span class="name">demandas_ideales</span>

        
    </div>
    <a class="headerlink" href="#NutrientOptimizer.demandas_ideales"></a>
    
    

                            </div>
                            <div id="NutrientOptimizer.productos_contribuciones" class="classattr">
                                <div class="attr variable">
            <span class="name">productos_contribuciones</span>

        
    </div>
    <a class="headerlink" href="#NutrientOptimizer.productos_contribuciones"></a>
    
    

                            </div>
                            <div id="NutrientOptimizer.coeficientes_variacion" class="classattr">
                                <div class="attr variable">
            <span class="name">coeficientes_variacion</span>

        
    </div>
    <a class="headerlink" href="#NutrientOptimizer.coeficientes_variacion"></a>
    
    

                            </div>
                            <div id="NutrientOptimizer.nutrientes" class="classattr">
                                <div class="attr variable">
            <span class="name">nutrientes</span>

        
    </div>
    <a class="headerlink" href="#NutrientOptimizer.nutrientes"></a>
    
    

                            </div>
                            <div id="NutrientOptimizer.productos" class="classattr">
                                <div class="attr variable">
            <span class="name">productos</span>

        
    </div>
    <a class="headerlink" href="#NutrientOptimizer.productos"></a>
    
    

                            </div>
                            <div id="NutrientOptimizer.calcular_ajustes" class="classattr">
                                        <input id="NutrientOptimizer.calcular_ajustes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calcular_ajustes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="NutrientOptimizer.calcular_ajustes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NutrientOptimizer.calcular_ajustes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NutrientOptimizer.calcular_ajustes-152"><a href="#NutrientOptimizer.calcular_ajustes-152"><span class="linenos">152</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">calcular_ajustes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]:</span>
</span><span id="NutrientOptimizer.calcular_ajustes-153"><a href="#NutrientOptimizer.calcular_ajustes-153"><span class="linenos">153</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer.calcular_ajustes-154"><a href="#NutrientOptimizer.calcular_ajustes-154"><span class="linenos">154</span></a><span class="sd">        Calcula los ajustes necesarios para cada nutriente usando la Ley de Liebig adaptada.</span>
</span><span id="NutrientOptimizer.calcular_ajustes-155"><a href="#NutrientOptimizer.calcular_ajustes-155"><span class="linenos">155</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer.calcular_ajustes-156"><a href="#NutrientOptimizer.calcular_ajustes-156"><span class="linenos">156</span></a>        <span class="n">ajustes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="NutrientOptimizer.calcular_ajustes-157"><a href="#NutrientOptimizer.calcular_ajustes-157"><span class="linenos">157</span></a>        <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes</span><span class="p">:</span>
</span><span id="NutrientOptimizer.calcular_ajustes-158"><a href="#NutrientOptimizer.calcular_ajustes-158"><span class="linenos">158</span></a>            <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes_actuales</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nutriente</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">))</span>
</span><span id="NutrientOptimizer.calcular_ajustes-159"><a href="#NutrientOptimizer.calcular_ajustes-159"><span class="linenos">159</span></a>            <span class="n">ideal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">demandas_ideales</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span>
</span><span id="NutrientOptimizer.calcular_ajustes-160"><a href="#NutrientOptimizer.calcular_ajustes-160"><span class="linenos">160</span></a>            <span class="k">if</span> <span class="n">actual</span> <span class="o">&lt;</span> <span class="n">ideal</span><span class="p">:</span>
</span><span id="NutrientOptimizer.calcular_ajustes-161"><a href="#NutrientOptimizer.calcular_ajustes-161"><span class="linenos">161</span></a>                <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">actual</span> <span class="o">/</span> <span class="n">ideal</span><span class="p">)</span> <span class="o">*</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.0&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">ideal</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.calcular_ajustes-162"><a href="#NutrientOptimizer.calcular_ajustes-162"><span class="linenos">162</span></a>                <span class="n">i</span> <span class="o">=</span> <span class="p">((</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.0&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeficientes_variacion</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span> <span class="o">/</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.0&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.00&#39;</span><span class="p">),</span> <span class="n">rounding</span><span class="o">=</span><span class="n">ROUND_HALF_UP</span><span class="p">)</span>
</span><span id="NutrientOptimizer.calcular_ajustes-163"><a href="#NutrientOptimizer.calcular_ajustes-163"><span class="linenos">163</span></a>                <span class="n">ajustes</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ideal</span> <span class="o">-</span> <span class="n">actual</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span>  <span class="c1"># Cantidad absoluta a ajustar</span>
</span><span id="NutrientOptimizer.calcular_ajustes-164"><a href="#NutrientOptimizer.calcular_ajustes-164"><span class="linenos">164</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NutrientOptimizer.calcular_ajustes-165"><a href="#NutrientOptimizer.calcular_ajustes-165"><span class="linenos">165</span></a>                <span class="n">ajustes</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.calcular_ajustes-166"><a href="#NutrientOptimizer.calcular_ajustes-166"><span class="linenos">166</span></a>        <span class="k">return</span> <span class="n">ajustes</span>
</span></pre></div>


            <div class="docstring"><p>Calcula los ajustes necesarios para cada nutriente usando la Ley de Liebig adaptada.</p>
</div>


                            </div>
                            <div id="NutrientOptimizer.identificar_limitante" class="classattr">
                                        <input id="NutrientOptimizer.identificar_limitante-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">identificar_limitante</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="NutrientOptimizer.identificar_limitante-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NutrientOptimizer.identificar_limitante"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NutrientOptimizer.identificar_limitante-168"><a href="#NutrientOptimizer.identificar_limitante-168"><span class="linenos">168</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">identificar_limitante</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="NutrientOptimizer.identificar_limitante-169"><a href="#NutrientOptimizer.identificar_limitante-169"><span class="linenos">169</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer.identificar_limitante-170"><a href="#NutrientOptimizer.identificar_limitante-170"><span class="linenos">170</span></a><span class="sd">        Identifica el nutriente más limitante según la Ley de Liebig.</span>
</span><span id="NutrientOptimizer.identificar_limitante-171"><a href="#NutrientOptimizer.identificar_limitante-171"><span class="linenos">171</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer.identificar_limitante-172"><a href="#NutrientOptimizer.identificar_limitante-172"><span class="linenos">172</span></a>        <span class="n">porcentajes</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="NutrientOptimizer.identificar_limitante-173"><a href="#NutrientOptimizer.identificar_limitante-173"><span class="linenos">173</span></a>            <span class="n">nutriente</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nutrientes_actuales</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nutriente</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">demandas_ideales</span><span class="p">[</span><span class="n">nutriente</span><span class="p">])</span> <span class="o">*</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.0&#39;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.identificar_limitante-174"><a href="#NutrientOptimizer.identificar_limitante-174"><span class="linenos">174</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">demandas_ideales</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.identificar_limitante-175"><a href="#NutrientOptimizer.identificar_limitante-175"><span class="linenos">175</span></a>            <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes</span>
</span><span id="NutrientOptimizer.identificar_limitante-176"><a href="#NutrientOptimizer.identificar_limitante-176"><span class="linenos">176</span></a>        <span class="p">}</span>
</span><span id="NutrientOptimizer.identificar_limitante-177"><a href="#NutrientOptimizer.identificar_limitante-177"><span class="linenos">177</span></a>        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">porcentajes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">porcentajes</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Identifica el nutriente más limitante según la Ley de Liebig.</p>
</div>


                            </div>
                            <div id="NutrientOptimizer.optimizar_productos" class="classattr">
                                        <input id="NutrientOptimizer.optimizar_productos-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">optimizar_productos</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="NutrientOptimizer.optimizar_productos-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NutrientOptimizer.optimizar_productos"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NutrientOptimizer.optimizar_productos-202"><a href="#NutrientOptimizer.optimizar_productos-202"><span class="linenos">202</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">optimizar_productos</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]]:</span>
</span><span id="NutrientOptimizer.optimizar_productos-203"><a href="#NutrientOptimizer.optimizar_productos-203"><span class="linenos">203</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-204"><a href="#NutrientOptimizer.optimizar_productos-204"><span class="linenos">204</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Iniciando optimización de productos...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-205"><a href="#NutrientOptimizer.optimizar_productos-205"><span class="linenos">205</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-206"><a href="#NutrientOptimizer.optimizar_productos-206"><span class="linenos">206</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No products available for optimization. Cannot generate recommendation.&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-207"><a href="#NutrientOptimizer.optimizar_productos-207"><span class="linenos">207</span></a>            
</span><span id="NutrientOptimizer.optimizar_productos-208"><a href="#NutrientOptimizer.optimizar_productos-208"><span class="linenos">208</span></a>            <span class="n">ajustes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcular_ajustes</span><span class="p">()</span>
</span><span id="NutrientOptimizer.optimizar_productos-209"><a href="#NutrientOptimizer.optimizar_productos-209"><span class="linenos">209</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ajustes calculados:&quot;</span><span class="p">,</span> <span class="n">ajustes</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-210"><a href="#NutrientOptimizer.optimizar_productos-210"><span class="linenos">210</span></a>            
</span><span id="NutrientOptimizer.optimizar_productos-211"><a href="#NutrientOptimizer.optimizar_productos-211"><span class="linenos">211</span></a>            <span class="c1"># Filtrar solo ajustes positivos (nutrientes que necesitan ser agregados)</span>
</span><span id="NutrientOptimizer.optimizar_productos-212"><a href="#NutrientOptimizer.optimizar_productos-212"><span class="linenos">212</span></a>            <span class="n">ajustes_positivos</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ajustes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="NutrientOptimizer.optimizar_productos-213"><a href="#NutrientOptimizer.optimizar_productos-213"><span class="linenos">213</span></a>            
</span><span id="NutrientOptimizer.optimizar_productos-214"><a href="#NutrientOptimizer.optimizar_productos-214"><span class="linenos">214</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">ajustes_positivos</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-215"><a href="#NutrientOptimizer.optimizar_productos-215"><span class="linenos">215</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No hay nutrientes que necesiten ser agregados.&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-216"><a href="#NutrientOptimizer.optimizar_productos-216"><span class="linenos">216</span></a>                <span class="k">return</span> <span class="p">{</span><span class="n">prod</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">},</span> \
</span><span id="NutrientOptimizer.optimizar_productos-217"><a href="#NutrientOptimizer.optimizar_productos-217"><span class="linenos">217</span></a>                       <span class="p">{</span><span class="n">nutriente</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes</span><span class="p">}</span>
</span><span id="NutrientOptimizer.optimizar_productos-218"><a href="#NutrientOptimizer.optimizar_productos-218"><span class="linenos">218</span></a>            
</span><span id="NutrientOptimizer.optimizar_productos-219"><a href="#NutrientOptimizer.optimizar_productos-219"><span class="linenos">219</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nutrientes a optimizar: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">ajustes_positivos</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-220"><a href="#NutrientOptimizer.optimizar_productos-220"><span class="linenos">220</span></a>            
</span><span id="NutrientOptimizer.optimizar_productos-221"><a href="#NutrientOptimizer.optimizar_productos-221"><span class="linenos">221</span></a>            <span class="c1"># Verificar que hay productos que pueden aportar los nutrientes necesarios</span>
</span><span id="NutrientOptimizer.optimizar_productos-222"><a href="#NutrientOptimizer.optimizar_productos-222"><span class="linenos">222</span></a>            <span class="n">productos_utiles</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="NutrientOptimizer.optimizar_productos-223"><a href="#NutrientOptimizer.optimizar_productos-223"><span class="linenos">223</span></a>            <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="n">ajustes_positivos</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-224"><a href="#NutrientOptimizer.optimizar_productos-224"><span class="linenos">224</span></a>                <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-225"><a href="#NutrientOptimizer.optimizar_productos-225"><span class="linenos">225</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos_contribuciones</span><span class="p">[</span><span class="n">prod</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nutriente</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-226"><a href="#NutrientOptimizer.optimizar_productos-226"><span class="linenos">226</span></a>                        <span class="n">productos_utiles</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">prod</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-227"><a href="#NutrientOptimizer.optimizar_productos-227"><span class="linenos">227</span></a>            
</span><span id="NutrientOptimizer.optimizar_productos-228"><a href="#NutrientOptimizer.optimizar_productos-228"><span class="linenos">228</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">productos_utiles</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-229"><a href="#NutrientOptimizer.optimizar_productos-229"><span class="linenos">229</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No hay productos que puedan aportar los nutrientes necesarios.&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-230"><a href="#NutrientOptimizer.optimizar_productos-230"><span class="linenos">230</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Los productos disponibles no pueden satisfacer los requerimientos nutricionales.&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-231"><a href="#NutrientOptimizer.optimizar_productos-231"><span class="linenos">231</span></a>            
</span><span id="NutrientOptimizer.optimizar_productos-232"><a href="#NutrientOptimizer.optimizar_productos-232"><span class="linenos">232</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Productos útiles: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">productos_utiles</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-233"><a href="#NutrientOptimizer.optimizar_productos-233"><span class="linenos">233</span></a>            
</span><span id="NutrientOptimizer.optimizar_productos-234"><a href="#NutrientOptimizer.optimizar_productos-234"><span class="linenos">234</span></a>            <span class="c1"># Coeficientes de la función objetivo (minimizar la suma de productos)</span>
</span><span id="NutrientOptimizer.optimizar_productos-235"><a href="#NutrientOptimizer.optimizar_productos-235"><span class="linenos">235</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Definiendo función objetivo...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-236"><a href="#NutrientOptimizer.optimizar_productos-236"><span class="linenos">236</span></a>            <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-237"><a href="#NutrientOptimizer.optimizar_productos-237"><span class="linenos">237</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Coeficientes de la función objetivo:&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-238"><a href="#NutrientOptimizer.optimizar_productos-238"><span class="linenos">238</span></a>            
</span><span id="NutrientOptimizer.optimizar_productos-239"><a href="#NutrientOptimizer.optimizar_productos-239"><span class="linenos">239</span></a>            <span class="c1"># Matriz de restricciones de desigualdad (A_ub * x &gt;= b_ub)</span>
</span><span id="NutrientOptimizer.optimizar_productos-240"><a href="#NutrientOptimizer.optimizar_productos-240"><span class="linenos">240</span></a>            <span class="c1"># Para linprog necesitamos A_ub * x &lt;= b_ub, así que usamos -A_ub * x &lt;= -b_ub</span>
</span><span id="NutrientOptimizer.optimizar_productos-241"><a href="#NutrientOptimizer.optimizar_productos-241"><span class="linenos">241</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Definiendo restricciones de desigualdad...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-242"><a href="#NutrientOptimizer.optimizar_productos-242"><span class="linenos">242</span></a>            <span class="n">A_ub</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NutrientOptimizer.optimizar_productos-243"><a href="#NutrientOptimizer.optimizar_productos-243"><span class="linenos">243</span></a>            <span class="n">b_ub</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NutrientOptimizer.optimizar_productos-244"><a href="#NutrientOptimizer.optimizar_productos-244"><span class="linenos">244</span></a>            
</span><span id="NutrientOptimizer.optimizar_productos-245"><a href="#NutrientOptimizer.optimizar_productos-245"><span class="linenos">245</span></a>            <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="n">ajustes_positivos</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-246"><a href="#NutrientOptimizer.optimizar_productos-246"><span class="linenos">246</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restricción para </span><span class="si">{</span><span class="n">nutriente</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-247"><a href="#NutrientOptimizer.optimizar_productos-247"><span class="linenos">247</span></a>                <span class="n">fila</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="NutrientOptimizer.optimizar_productos-248"><a href="#NutrientOptimizer.optimizar_productos-248"><span class="linenos">248</span></a>                <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-249"><a href="#NutrientOptimizer.optimizar_productos-249"><span class="linenos">249</span></a>                    <span class="n">contrib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos_contribuciones</span><span class="p">[</span><span class="n">prod</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nutriente</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">))</span>
</span><span id="NutrientOptimizer.optimizar_productos-250"><a href="#NutrientOptimizer.optimizar_productos-250"><span class="linenos">250</span></a>                    <span class="n">fila</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">contrib</span><span class="p">))</span>  <span class="c1"># Negativo para convertir &gt;= en &lt;=</span>
</span><span id="NutrientOptimizer.optimizar_productos-251"><a href="#NutrientOptimizer.optimizar_productos-251"><span class="linenos">251</span></a>                
</span><span id="NutrientOptimizer.optimizar_productos-252"><a href="#NutrientOptimizer.optimizar_productos-252"><span class="linenos">252</span></a>                <span class="c1"># Solo agregar restricción si al menos un producto puede aportar este nutriente</span>
</span><span id="NutrientOptimizer.optimizar_productos-253"><a href="#NutrientOptimizer.optimizar_productos-253"><span class="linenos">253</span></a>                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">fila</span><span class="p">):</span>  <span class="c1"># Al menos una contribución positiva</span>
</span><span id="NutrientOptimizer.optimizar_productos-254"><a href="#NutrientOptimizer.optimizar_productos-254"><span class="linenos">254</span></a>                    <span class="n">A_ub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fila</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-255"><a href="#NutrientOptimizer.optimizar_productos-255"><span class="linenos">255</span></a>                    <span class="n">b_ub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">ajustes_positivos</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]))</span>  <span class="c1"># Negativo para convertir &gt;= en &lt;=</span>
</span><span id="NutrientOptimizer.optimizar_productos-256"><a href="#NutrientOptimizer.optimizar_productos-256"><span class="linenos">256</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coeficientes de la restricción: </span><span class="si">{</span><span class="n">fila</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-257"><a href="#NutrientOptimizer.optimizar_productos-257"><span class="linenos">257</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Valor de la restricción: </span><span class="si">{</span><span class="n">b_ub</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-258"><a href="#NutrientOptimizer.optimizar_productos-258"><span class="linenos">258</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-259"><a href="#NutrientOptimizer.optimizar_productos-259"><span class="linenos">259</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Advertencia: No hay productos que aporten </span><span class="si">{</span><span class="n">nutriente</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-260"><a href="#NutrientOptimizer.optimizar_productos-260"><span class="linenos">260</span></a>            
</span><span id="NutrientOptimizer.optimizar_productos-261"><a href="#NutrientOptimizer.optimizar_productos-261"><span class="linenos">261</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">A_ub</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-262"><a href="#NutrientOptimizer.optimizar_productos-262"><span class="linenos">262</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No se pudieron formar restricciones válidas&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-263"><a href="#NutrientOptimizer.optimizar_productos-263"><span class="linenos">263</span></a>                <span class="n">cantidades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solucion_heuristica</span><span class="p">(</span><span class="n">ajustes_positivos</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-264"><a href="#NutrientOptimizer.optimizar_productos-264"><span class="linenos">264</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-265"><a href="#NutrientOptimizer.optimizar_productos-265"><span class="linenos">265</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matriz de restricciones:&quot;</span><span class="p">,</span> <span class="n">A_ub</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-266"><a href="#NutrientOptimizer.optimizar_productos-266"><span class="linenos">266</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Valores de las restricciones:&quot;</span><span class="p">,</span> <span class="n">b_ub</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-267"><a href="#NutrientOptimizer.optimizar_productos-267"><span class="linenos">267</span></a>                
</span><span id="NutrientOptimizer.optimizar_productos-268"><a href="#NutrientOptimizer.optimizar_productos-268"><span class="linenos">268</span></a>                <span class="c1"># Límites (cantidades &gt;= 0)</span>
</span><span id="NutrientOptimizer.optimizar_productos-269"><a href="#NutrientOptimizer.optimizar_productos-269"><span class="linenos">269</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Definiendo límites...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-270"><a href="#NutrientOptimizer.optimizar_productos-270"><span class="linenos">270</span></a>                <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">productos</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-271"><a href="#NutrientOptimizer.optimizar_productos-271"><span class="linenos">271</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Límites:&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-272"><a href="#NutrientOptimizer.optimizar_productos-272"><span class="linenos">272</span></a>                
</span><span id="NutrientOptimizer.optimizar_productos-273"><a href="#NutrientOptimizer.optimizar_productos-273"><span class="linenos">273</span></a>                <span class="c1"># Resolver optimización</span>
</span><span id="NutrientOptimizer.optimizar_productos-274"><a href="#NutrientOptimizer.optimizar_productos-274"><span class="linenos">274</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resolviendo problema de programación lineal...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-275"><a href="#NutrientOptimizer.optimizar_productos-275"><span class="linenos">275</span></a>                <span class="n">res</span> <span class="o">=</span> <span class="n">linprog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">A_ub</span><span class="o">=</span><span class="n">A_ub</span><span class="p">,</span> <span class="n">b_ub</span><span class="o">=</span><span class="n">b_ub</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;highs&#39;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-276"><a href="#NutrientOptimizer.optimizar_productos-276"><span class="linenos">276</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resultado de la optimización:&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-277"><a href="#NutrientOptimizer.optimizar_productos-277"><span class="linenos">277</span></a>                
</span><span id="NutrientOptimizer.optimizar_productos-278"><a href="#NutrientOptimizer.optimizar_productos-278"><span class="linenos">278</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-279"><a href="#NutrientOptimizer.optimizar_productos-279"><span class="linenos">279</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error en la optimización:&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-280"><a href="#NutrientOptimizer.optimizar_productos-280"><span class="linenos">280</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intentando con método alternativo...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-281"><a href="#NutrientOptimizer.optimizar_productos-281"><span class="linenos">281</span></a>                    
</span><span id="NutrientOptimizer.optimizar_productos-282"><a href="#NutrientOptimizer.optimizar_productos-282"><span class="linenos">282</span></a>                    <span class="c1"># Intentar con método alternativo</span>
</span><span id="NutrientOptimizer.optimizar_productos-283"><a href="#NutrientOptimizer.optimizar_productos-283"><span class="linenos">283</span></a>                    <span class="n">res</span> <span class="o">=</span> <span class="n">linprog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">A_ub</span><span class="o">=</span><span class="n">A_ub</span><span class="p">,</span> <span class="n">b_ub</span><span class="o">=</span><span class="n">b_ub</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;interior-point&#39;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-284"><a href="#NutrientOptimizer.optimizar_productos-284"><span class="linenos">284</span></a>                    
</span><span id="NutrientOptimizer.optimizar_productos-285"><a href="#NutrientOptimizer.optimizar_productos-285"><span class="linenos">285</span></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-286"><a href="#NutrientOptimizer.optimizar_productos-286"><span class="linenos">286</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error con método alternativo:&quot;</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-287"><a href="#NutrientOptimizer.optimizar_productos-287"><span class="linenos">287</span></a>                        
</span><span id="NutrientOptimizer.optimizar_productos-288"><a href="#NutrientOptimizer.optimizar_productos-288"><span class="linenos">288</span></a>                        <span class="c1"># Como último recurso, intentar relajar las restricciones</span>
</span><span id="NutrientOptimizer.optimizar_productos-289"><a href="#NutrientOptimizer.optimizar_productos-289"><span class="linenos">289</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intentando con restricciones relajadas...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-290"><a href="#NutrientOptimizer.optimizar_productos-290"><span class="linenos">290</span></a>                        <span class="c1"># Reducir los requerimientos en un 20%</span>
</span><span id="NutrientOptimizer.optimizar_productos-291"><a href="#NutrientOptimizer.optimizar_productos-291"><span class="linenos">291</span></a>                        <span class="n">b_ub_relajado</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="o">*</span> <span class="mf">0.8</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">b_ub</span><span class="p">]</span>
</span><span id="NutrientOptimizer.optimizar_productos-292"><a href="#NutrientOptimizer.optimizar_productos-292"><span class="linenos">292</span></a>                        <span class="n">res</span> <span class="o">=</span> <span class="n">linprog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">A_ub</span><span class="o">=</span><span class="n">A_ub</span><span class="p">,</span> <span class="n">b_ub</span><span class="o">=</span><span class="n">b_ub_relajado</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;highs&#39;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-293"><a href="#NutrientOptimizer.optimizar_productos-293"><span class="linenos">293</span></a>                        
</span><span id="NutrientOptimizer.optimizar_productos-294"><a href="#NutrientOptimizer.optimizar_productos-294"><span class="linenos">294</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-295"><a href="#NutrientOptimizer.optimizar_productos-295"><span class="linenos">295</span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimización falló completamente: </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-296"><a href="#NutrientOptimizer.optimizar_productos-296"><span class="linenos">296</span></a>                            <span class="n">cantidades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solucion_heuristica</span><span class="p">(</span><span class="n">ajustes_positivos</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-297"><a href="#NutrientOptimizer.optimizar_productos-297"><span class="linenos">297</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-298"><a href="#NutrientOptimizer.optimizar_productos-298"><span class="linenos">298</span></a>                            <span class="n">cantidades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_procesar_resultado_optimizacion</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-299"><a href="#NutrientOptimizer.optimizar_productos-299"><span class="linenos">299</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-300"><a href="#NutrientOptimizer.optimizar_productos-300"><span class="linenos">300</span></a>                        <span class="n">cantidades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_procesar_resultado_optimizacion</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-301"><a href="#NutrientOptimizer.optimizar_productos-301"><span class="linenos">301</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-302"><a href="#NutrientOptimizer.optimizar_productos-302"><span class="linenos">302</span></a>                    <span class="n">cantidades</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_procesar_resultado_optimizacion</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-303"><a href="#NutrientOptimizer.optimizar_productos-303"><span class="linenos">303</span></a>            
</span><span id="NutrientOptimizer.optimizar_productos-304"><a href="#NutrientOptimizer.optimizar_productos-304"><span class="linenos">304</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cantidades de productos:&quot;</span><span class="p">,</span> <span class="n">cantidades</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-305"><a href="#NutrientOptimizer.optimizar_productos-305"><span class="linenos">305</span></a>            
</span><span id="NutrientOptimizer.optimizar_productos-306"><a href="#NutrientOptimizer.optimizar_productos-306"><span class="linenos">306</span></a>            <span class="c1"># Calcular nutrientes aportados</span>
</span><span id="NutrientOptimizer.optimizar_productos-307"><a href="#NutrientOptimizer.optimizar_productos-307"><span class="linenos">307</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculando nutrientes aportados...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-308"><a href="#NutrientOptimizer.optimizar_productos-308"><span class="linenos">308</span></a>            <span class="n">nutrientes_aportados</span> <span class="o">=</span> <span class="p">{</span><span class="n">nutriente</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutrientes</span><span class="p">}</span>
</span><span id="NutrientOptimizer.optimizar_productos-309"><a href="#NutrientOptimizer.optimizar_productos-309"><span class="linenos">309</span></a>            <span class="k">for</span> <span class="n">prod</span><span class="p">,</span> <span class="n">cantidad</span> <span class="ow">in</span> <span class="n">cantidades</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="NutrientOptimizer.optimizar_productos-310"><a href="#NutrientOptimizer.optimizar_productos-310"><span class="linenos">310</span></a>                <span class="k">if</span> <span class="n">cantidad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-311"><a href="#NutrientOptimizer.optimizar_productos-311"><span class="linenos">311</span></a>                    <span class="k">for</span> <span class="n">nutriente</span><span class="p">,</span> <span class="n">contrib</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">productos_contribuciones</span><span class="p">[</span><span class="n">prod</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="NutrientOptimizer.optimizar_productos-312"><a href="#NutrientOptimizer.optimizar_productos-312"><span class="linenos">312</span></a>                        <span class="n">nutrientes_aportados</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span> <span class="o">+=</span> <span class="n">contrib</span> <span class="o">*</span> <span class="n">cantidad</span>
</span><span id="NutrientOptimizer.optimizar_productos-313"><a href="#NutrientOptimizer.optimizar_productos-313"><span class="linenos">313</span></a>            
</span><span id="NutrientOptimizer.optimizar_productos-314"><a href="#NutrientOptimizer.optimizar_productos-314"><span class="linenos">314</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Nutrientes aportados:&quot;</span><span class="p">,</span> <span class="n">nutrientes_aportados</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-315"><a href="#NutrientOptimizer.optimizar_productos-315"><span class="linenos">315</span></a>            
</span><span id="NutrientOptimizer.optimizar_productos-316"><a href="#NutrientOptimizer.optimizar_productos-316"><span class="linenos">316</span></a>            <span class="c1"># Verificar que se cumplan los requerimientos mínimos</span>
</span><span id="NutrientOptimizer.optimizar_productos-317"><a href="#NutrientOptimizer.optimizar_productos-317"><span class="linenos">317</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Verificando cumplimiento de requerimientos...&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-318"><a href="#NutrientOptimizer.optimizar_productos-318"><span class="linenos">318</span></a>            <span class="k">for</span> <span class="n">nutriente</span><span class="p">,</span> <span class="n">requerido</span> <span class="ow">in</span> <span class="n">ajustes_positivos</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="NutrientOptimizer.optimizar_productos-319"><a href="#NutrientOptimizer.optimizar_productos-319"><span class="linenos">319</span></a>                <span class="n">aportado</span> <span class="o">=</span> <span class="n">nutrientes_aportados</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nutriente</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.0&#39;</span><span class="p">))</span>
</span><span id="NutrientOptimizer.optimizar_productos-320"><a href="#NutrientOptimizer.optimizar_productos-320"><span class="linenos">320</span></a>                <span class="n">cumplimiento</span> <span class="o">=</span> <span class="p">(</span><span class="n">aportado</span> <span class="o">/</span> <span class="n">requerido</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">requerido</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;100.0&#39;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-321"><a href="#NutrientOptimizer.optimizar_productos-321"><span class="linenos">321</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nutriente</span><span class="si">}</span><span class="s2">: Requerido=</span><span class="si">{</span><span class="n">requerido</span><span class="si">}</span><span class="s2">, Aportado=</span><span class="si">{</span><span class="n">aportado</span><span class="si">}</span><span class="s2">, Cumplimiento=</span><span class="si">{</span><span class="n">cumplimiento</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.optimizar_productos-322"><a href="#NutrientOptimizer.optimizar_productos-322"><span class="linenos">322</span></a>            
</span><span id="NutrientOptimizer.optimizar_productos-323"><a href="#NutrientOptimizer.optimizar_productos-323"><span class="linenos">323</span></a>            <span class="k">return</span> <span class="n">cantidades</span><span class="p">,</span> <span class="n">nutrientes_aportados</span>
</span><span id="NutrientOptimizer.optimizar_productos-324"><a href="#NutrientOptimizer.optimizar_productos-324"><span class="linenos">324</span></a>            
</span><span id="NutrientOptimizer.optimizar_productos-325"><a href="#NutrientOptimizer.optimizar_productos-325"><span class="linenos">325</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="NutrientOptimizer.optimizar_productos-326"><a href="#NutrientOptimizer.optimizar_productos-326"><span class="linenos">326</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error en la optimización:&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span><span id="NutrientOptimizer.optimizar_productos-327"><a href="#NutrientOptimizer.optimizar_productos-327"><span class="linenos">327</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
</span><span id="NutrientOptimizer.optimizar_productos-328"><a href="#NutrientOptimizer.optimizar_productos-328"><span class="linenos">328</span></a>            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</span><span id="NutrientOptimizer.optimizar_productos-329"><a href="#NutrientOptimizer.optimizar_productos-329"><span class="linenos">329</span></a>            <span class="k">raise</span>
</span></pre></div>


    

                            </div>
                            <div id="NutrientOptimizer.generar_recomendacion" class="classattr">
                                        <input id="NutrientOptimizer.generar_recomendacion-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generar_recomendacion</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">lot_id</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="NutrientOptimizer.generar_recomendacion-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NutrientOptimizer.generar_recomendacion"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NutrientOptimizer.generar_recomendacion-349"><a href="#NutrientOptimizer.generar_recomendacion-349"><span class="linenos">349</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generar_recomendacion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lot_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="NutrientOptimizer.generar_recomendacion-350"><a href="#NutrientOptimizer.generar_recomendacion-350"><span class="linenos">350</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer.generar_recomendacion-351"><a href="#NutrientOptimizer.generar_recomendacion-351"><span class="linenos">351</span></a><span class="sd">        Genera una recomendación para aplicar en el lote.</span>
</span><span id="NutrientOptimizer.generar_recomendacion-352"><a href="#NutrientOptimizer.generar_recomendacion-352"><span class="linenos">352</span></a><span class="sd">        </span>
</span><span id="NutrientOptimizer.generar_recomendacion-353"><a href="#NutrientOptimizer.generar_recomendacion-353"><span class="linenos">353</span></a><span class="sd">        :param lot_id: ID del lote donde se aplicará la recomendación.</span>
</span><span id="NutrientOptimizer.generar_recomendacion-354"><a href="#NutrientOptimizer.generar_recomendacion-354"><span class="linenos">354</span></a><span class="sd">        :return: Texto de la recomendación.</span>
</span><span id="NutrientOptimizer.generar_recomendacion-355"><a href="#NutrientOptimizer.generar_recomendacion-355"><span class="linenos">355</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="NutrientOptimizer.generar_recomendacion-356"><a href="#NutrientOptimizer.generar_recomendacion-356"><span class="linenos">356</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="NutrientOptimizer.generar_recomendacion-357"><a href="#NutrientOptimizer.generar_recomendacion-357"><span class="linenos">357</span></a>            <span class="n">cantidades</span><span class="p">,</span> <span class="n">nutrientes_aportados</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizar_productos</span><span class="p">()</span>
</span><span id="NutrientOptimizer.generar_recomendacion-358"><a href="#NutrientOptimizer.generar_recomendacion-358"><span class="linenos">358</span></a>            
</span><span id="NutrientOptimizer.generar_recomendacion-359"><a href="#NutrientOptimizer.generar_recomendacion-359"><span class="linenos">359</span></a>            <span class="n">lineas</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Aplicar en el lote </span><span class="si">{</span><span class="n">lot_id</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">]</span>
</span><span id="NutrientOptimizer.generar_recomendacion-360"><a href="#NutrientOptimizer.generar_recomendacion-360"><span class="linenos">360</span></a>            
</span><span id="NutrientOptimizer.generar_recomendacion-361"><a href="#NutrientOptimizer.generar_recomendacion-361"><span class="linenos">361</span></a>            <span class="c1"># Solo mostrar productos con cantidades significativas</span>
</span><span id="NutrientOptimizer.generar_recomendacion-362"><a href="#NutrientOptimizer.generar_recomendacion-362"><span class="linenos">362</span></a>            <span class="n">productos_aplicar</span> <span class="o">=</span> <span class="p">{</span><span class="n">prod</span><span class="p">:</span> <span class="n">cant</span> <span class="k">for</span> <span class="n">prod</span><span class="p">,</span> <span class="n">cant</span> <span class="ow">in</span> <span class="n">cantidades</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">cant</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="NutrientOptimizer.generar_recomendacion-363"><a href="#NutrientOptimizer.generar_recomendacion-363"><span class="linenos">363</span></a>            
</span><span id="NutrientOptimizer.generar_recomendacion-364"><a href="#NutrientOptimizer.generar_recomendacion-364"><span class="linenos">364</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">productos_aplicar</span><span class="p">:</span>
</span><span id="NutrientOptimizer.generar_recomendacion-365"><a href="#NutrientOptimizer.generar_recomendacion-365"><span class="linenos">365</span></a>                <span class="n">lineas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;- No se requiere aplicación de productos adicionales&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.generar_recomendacion-366"><a href="#NutrientOptimizer.generar_recomendacion-366"><span class="linenos">366</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="NutrientOptimizer.generar_recomendacion-367"><a href="#NutrientOptimizer.generar_recomendacion-367"><span class="linenos">367</span></a>                <span class="k">for</span> <span class="n">prod</span><span class="p">,</span> <span class="n">cantidad</span> <span class="ow">in</span> <span class="n">productos_aplicar</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="NutrientOptimizer.generar_recomendacion-368"><a href="#NutrientOptimizer.generar_recomendacion-368"><span class="linenos">368</span></a>                    <span class="n">lineas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">cantidad</span><span class="si">}</span><span class="s2"> unidades de </span><span class="si">{</span><span class="n">prod</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.generar_recomendacion-369"><a href="#NutrientOptimizer.generar_recomendacion-369"><span class="linenos">369</span></a>            
</span><span id="NutrientOptimizer.generar_recomendacion-370"><a href="#NutrientOptimizer.generar_recomendacion-370"><span class="linenos">370</span></a>            <span class="n">lineas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Nutrientes aportados:&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.generar_recomendacion-371"><a href="#NutrientOptimizer.generar_recomendacion-371"><span class="linenos">371</span></a>            <span class="k">for</span> <span class="n">nutriente</span><span class="p">,</span> <span class="n">cantidad</span> <span class="ow">in</span> <span class="n">nutrientes_aportados</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="NutrientOptimizer.generar_recomendacion-372"><a href="#NutrientOptimizer.generar_recomendacion-372"><span class="linenos">372</span></a>                <span class="k">if</span> <span class="n">cantidad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Solo mostrar nutrientes con aporte significativo</span>
</span><span id="NutrientOptimizer.generar_recomendacion-373"><a href="#NutrientOptimizer.generar_recomendacion-373"><span class="linenos">373</span></a>                    <span class="c1"># Asumiendo que tienes acceso a macronutrients, sino puedes ajustar esta lógica</span>
</span><span id="NutrientOptimizer.generar_recomendacion-374"><a href="#NutrientOptimizer.generar_recomendacion-374"><span class="linenos">374</span></a>                    <span class="n">unidad</span> <span class="o">=</span> <span class="s2">&quot;kg/ha&quot;</span>  <span class="c1"># Puedes ajustar esto según tu lógica de negocio</span>
</span><span id="NutrientOptimizer.generar_recomendacion-375"><a href="#NutrientOptimizer.generar_recomendacion-375"><span class="linenos">375</span></a>                    <span class="n">lineas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">nutriente</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">cantidad</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unidad</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.generar_recomendacion-376"><a href="#NutrientOptimizer.generar_recomendacion-376"><span class="linenos">376</span></a>            
</span><span id="NutrientOptimizer.generar_recomendacion-377"><a href="#NutrientOptimizer.generar_recomendacion-377"><span class="linenos">377</span></a>            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lineas</span><span class="p">)</span>
</span><span id="NutrientOptimizer.generar_recomendacion-378"><a href="#NutrientOptimizer.generar_recomendacion-378"><span class="linenos">378</span></a>            
</span><span id="NutrientOptimizer.generar_recomendacion-379"><a href="#NutrientOptimizer.generar_recomendacion-379"><span class="linenos">379</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="NutrientOptimizer.generar_recomendacion-380"><a href="#NutrientOptimizer.generar_recomendacion-380"><span class="linenos">380</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generando recomendación: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="NutrientOptimizer.generar_recomendacion-381"><a href="#NutrientOptimizer.generar_recomendacion-381"><span class="linenos">381</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error al generar recomendación para el lote </span><span class="si">{</span><span class="n">lot_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Genera una recomendación para aplicar en el lote.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>lot_id</strong>:  ID del lote donde se aplicará la recomendación.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Texto de la recomendación.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="calcular_cv_nutriente">
                            <input id="calcular_cv_nutriente-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calcular_cv_nutriente</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">lot_id</span>, </span><span class="param"><span class="n">nutriente_name</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="calcular_cv_nutriente-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#calcular_cv_nutriente"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="calcular_cv_nutriente-444"><a href="#calcular_cv_nutriente-444"><span class="linenos">444</span></a><span class="k">def</span><span class="w"> </span><span class="nf">calcular_cv_nutriente</span><span class="p">(</span><span class="n">lot_id</span><span class="p">,</span> <span class="n">nutriente_name</span><span class="p">):</span>
</span><span id="calcular_cv_nutriente-445"><a href="#calcular_cv_nutriente-445"><span class="linenos">445</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Determinar los Coeficientes de Variación &quot;&quot;&quot;</span>
</span><span id="calcular_cv_nutriente-446"><a href="#calcular_cv_nutriente-446"><span class="linenos">446</span></a>    <span class="c1"># Obtener valores históricos de LeafAnalysis para el lote</span>
</span><span id="calcular_cv_nutriente-447"><a href="#calcular_cv_nutriente-447"><span class="linenos">447</span></a>    <span class="n">valores</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">leaf_analysis_nutrients</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LeafAnalysis</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CommonAnalysis</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span><span id="calcular_cv_nutriente-448"><a href="#calcular_cv_nutriente-448"><span class="linenos">448</span></a>        <span class="n">CommonAnalysis</span><span class="o">.</span><span class="n">lot_id</span> <span class="o">==</span> <span class="n">lot_id</span><span class="p">,</span>
</span><span id="calcular_cv_nutriente-449"><a href="#calcular_cv_nutriente-449"><span class="linenos">449</span></a>        <span class="n">leaf_analysis_nutrients</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">nutrient_id</span> <span class="o">==</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">nutriente_name</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>
</span><span id="calcular_cv_nutriente-450"><a href="#calcular_cv_nutriente-450"><span class="linenos">450</span></a>    <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="calcular_cv_nutriente-451"><a href="#calcular_cv_nutriente-451"><span class="linenos">451</span></a>    <span class="n">valores</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">valores</span><span class="p">]</span>
</span><span id="calcular_cv_nutriente-452"><a href="#calcular_cv_nutriente-452"><span class="linenos">452</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valores</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="calcular_cv_nutriente-453"><a href="#calcular_cv_nutriente-453"><span class="linenos">453</span></a>        <span class="k">return</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.5&#39;</span><span class="p">)</span>  <span class="c1"># Valor por defecto si no hay suficientes datos</span>
</span><span id="calcular_cv_nutriente-454"><a href="#calcular_cv_nutriente-454"><span class="linenos">454</span></a>    <span class="n">mu</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">valores</span><span class="p">)</span>
</span><span id="calcular_cv_nutriente-455"><a href="#calcular_cv_nutriente-455"><span class="linenos">455</span></a>    <span class="n">sigma</span> <span class="o">=</span> <span class="n">stdev</span><span class="p">(</span><span class="n">valores</span><span class="p">)</span>
</span><span id="calcular_cv_nutriente-456"><a href="#calcular_cv_nutriente-456"><span class="linenos">456</span></a>    <span class="k">return</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sigma</span> <span class="o">/</span> <span class="n">mu</span><span class="p">))</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.01&#39;</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Determinar los Coeficientes de Variación</p>
</div>


                </section>
                <section id="determinar_coeficientes_variacion">
                            <input id="determinar_coeficientes_variacion-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">determinar_coeficientes_variacion</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">lot_id</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="determinar_coeficientes_variacion-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#determinar_coeficientes_variacion"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="determinar_coeficientes_variacion-467"><a href="#determinar_coeficientes_variacion-467"><span class="linenos">467</span></a><span class="k">def</span><span class="w"> </span><span class="nf">determinar_coeficientes_variacion</span><span class="p">(</span><span class="n">lot_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">]:</span>
</span><span id="determinar_coeficientes_variacion-468"><a href="#determinar_coeficientes_variacion-468"><span class="linenos">468</span></a>    <span class="n">coeficientes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="determinar_coeficientes_variacion-469"><a href="#determinar_coeficientes_variacion-469"><span class="linenos">469</span></a>    <span class="n">nutrientes</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">macronutrients</span> <span class="o">+</span> <span class="n">micronutrients</span><span class="p">]</span>
</span><span id="determinar_coeficientes_variacion-470"><a href="#determinar_coeficientes_variacion-470"><span class="linenos">470</span></a>    <span class="k">for</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="n">nutrientes</span><span class="p">:</span>
</span><span id="determinar_coeficientes_variacion-471"><a href="#determinar_coeficientes_variacion-471"><span class="linenos">471</span></a>        <span class="n">cv</span> <span class="o">=</span> <span class="n">calcular_cv_nutriente</span><span class="p">(</span><span class="n">lot_id</span><span class="p">,</span> <span class="n">nutriente</span><span class="p">)</span>
</span><span id="determinar_coeficientes_variacion-472"><a href="#determinar_coeficientes_variacion-472"><span class="linenos">472</span></a>        <span class="k">if</span> <span class="n">cv</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.5&#39;</span><span class="p">):</span>  <span class="c1"># Valor por defecto si no hay datos</span>
</span><span id="determinar_coeficientes_variacion-473"><a href="#determinar_coeficientes_variacion-473"><span class="linenos">473</span></a>            <span class="c1"># Asignar valores basados en literatura</span>
</span><span id="determinar_coeficientes_variacion-474"><a href="#determinar_coeficientes_variacion-474"><span class="linenos">474</span></a>            <span class="k">if</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Nitrógeno&quot;</span><span class="p">]:</span>
</span><span id="determinar_coeficientes_variacion-475"><a href="#determinar_coeficientes_variacion-475"><span class="linenos">475</span></a>                <span class="n">cv</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.5&quot;</span><span class="p">)</span>
</span><span id="determinar_coeficientes_variacion-476"><a href="#determinar_coeficientes_variacion-476"><span class="linenos">476</span></a>            <span class="k">elif</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Fósforo&quot;</span><span class="p">]:</span>
</span><span id="determinar_coeficientes_variacion-477"><a href="#determinar_coeficientes_variacion-477"><span class="linenos">477</span></a>                <span class="n">cv</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.3&quot;</span><span class="p">)</span>
</span><span id="determinar_coeficientes_variacion-478"><a href="#determinar_coeficientes_variacion-478"><span class="linenos">478</span></a>            <span class="k">elif</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Potasio&quot;</span><span class="p">]:</span>
</span><span id="determinar_coeficientes_variacion-479"><a href="#determinar_coeficientes_variacion-479"><span class="linenos">479</span></a>                <span class="n">cv</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.4&quot;</span><span class="p">)</span>
</span><span id="determinar_coeficientes_variacion-480"><a href="#determinar_coeficientes_variacion-480"><span class="linenos">480</span></a>            <span class="k">elif</span> <span class="n">nutriente</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Cobre&quot;</span><span class="p">,</span> <span class="s2">&quot;Zinc&quot;</span><span class="p">]:</span>
</span><span id="determinar_coeficientes_variacion-481"><a href="#determinar_coeficientes_variacion-481"><span class="linenos">481</span></a>                <span class="n">cv</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.25&quot;</span><span class="p">)</span>
</span><span id="determinar_coeficientes_variacion-482"><a href="#determinar_coeficientes_variacion-482"><span class="linenos">482</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="determinar_coeficientes_variacion-483"><a href="#determinar_coeficientes_variacion-483"><span class="linenos">483</span></a>                <span class="n">cv</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;0.3&quot;</span><span class="p">)</span>  <span class="c1"># Default genérico</span>
</span><span id="determinar_coeficientes_variacion-484"><a href="#determinar_coeficientes_variacion-484"><span class="linenos">484</span></a>        <span class="n">coeficientes</span><span class="p">[</span><span class="n">nutriente</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv</span>
</span><span id="determinar_coeficientes_variacion-485"><a href="#determinar_coeficientes_variacion-485"><span class="linenos">485</span></a>    <span class="k">return</span> <span class="n">coeficientes</span>
</span></pre></div>


    

                </section>
                <section id="contribuciones_de_producto">
                            <input id="contribuciones_de_producto-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">contribuciones_de_producto</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="contribuciones_de_producto-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#contribuciones_de_producto"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="contribuciones_de_producto-488"><a href="#contribuciones_de_producto-488"><span class="linenos">488</span></a><span class="k">def</span><span class="w"> </span><span class="nf">contribuciones_de_producto</span><span class="p">():</span>
</span><span id="contribuciones_de_producto-489"><a href="#contribuciones_de_producto-489"><span class="linenos">489</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Contribuciones de producto &quot;&quot;&quot;</span>
</span><span id="contribuciones_de_producto-490"><a href="#contribuciones_de_producto-490"><span class="linenos">490</span></a>    <span class="n">product_contributions</span> <span class="o">=</span> <span class="n">ProductContribution</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="contribuciones_de_producto-491"><a href="#contribuciones_de_producto-491"><span class="linenos">491</span></a>    
</span><span id="contribuciones_de_producto-492"><a href="#contribuciones_de_producto-492"><span class="linenos">492</span></a>    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="contribuciones_de_producto-493"><a href="#contribuciones_de_producto-493"><span class="linenos">493</span></a>    
</span><span id="contribuciones_de_producto-494"><a href="#contribuciones_de_producto-494"><span class="linenos">494</span></a>    <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">product_contributions</span><span class="p">:</span>
</span><span id="contribuciones_de_producto-495"><a href="#contribuciones_de_producto-495"><span class="linenos">495</span></a>        <span class="n">product_name</span> <span class="o">=</span> <span class="n">pc</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">name</span>
</span><span id="contribuciones_de_producto-496"><a href="#contribuciones_de_producto-496"><span class="linenos">496</span></a>        
</span><span id="contribuciones_de_producto-497"><a href="#contribuciones_de_producto-497"><span class="linenos">497</span></a>        <span class="k">if</span> <span class="n">product_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span id="contribuciones_de_producto-498"><a href="#contribuciones_de_producto-498"><span class="linenos">498</span></a>            <span class="n">result</span><span class="p">[</span><span class="n">product_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="contribuciones_de_producto-499"><a href="#contribuciones_de_producto-499"><span class="linenos">499</span></a>        
</span><span id="contribuciones_de_producto-500"><a href="#contribuciones_de_producto-500"><span class="linenos">500</span></a>        <span class="n">nutrient_contributions</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="contribuciones_de_producto-501"><a href="#contribuciones_de_producto-501"><span class="linenos">501</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">product_contribution_nutrients</span><span class="p">)</span>
</span><span id="contribuciones_de_producto-502"><a href="#contribuciones_de_producto-502"><span class="linenos">502</span></a>            <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">product_contribution_id</span><span class="o">=</span><span class="n">pc</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="contribuciones_de_producto-503"><a href="#contribuciones_de_producto-503"><span class="linenos">503</span></a>            <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="contribuciones_de_producto-504"><a href="#contribuciones_de_producto-504"><span class="linenos">504</span></a>        <span class="p">)</span>
</span><span id="contribuciones_de_producto-505"><a href="#contribuciones_de_producto-505"><span class="linenos">505</span></a>        
</span><span id="contribuciones_de_producto-506"><a href="#contribuciones_de_producto-506"><span class="linenos">506</span></a>        <span class="k">for</span> <span class="n">contribution</span> <span class="ow">in</span> <span class="n">nutrient_contributions</span><span class="p">:</span>
</span><span id="contribuciones_de_producto-507"><a href="#contribuciones_de_producto-507"><span class="linenos">507</span></a>            <span class="n">nutrient</span> <span class="o">=</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">contribution</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span>
</span><span id="contribuciones_de_producto-508"><a href="#contribuciones_de_producto-508"><span class="linenos">508</span></a>            <span class="n">result</span><span class="p">[</span><span class="n">product_name</span><span class="p">][</span><span class="n">nutrient</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">contribution</span><span class="o">.</span><span class="n">contribution</span><span class="p">))</span>
</span><span id="contribuciones_de_producto-509"><a href="#contribuciones_de_producto-509"><span class="linenos">509</span></a>    
</span><span id="contribuciones_de_producto-510"><a href="#contribuciones_de_producto-510"><span class="linenos">510</span></a>    <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


            <div class="docstring"><p>Contribuciones de producto</p>
</div>


                </section>
                <section id="ObjectiveResource">
                            <input id="ObjectiveResource-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ObjectiveResource</span>:

                <label class="view-source-button" for="ObjectiveResource-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ObjectiveResource"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ObjectiveResource-516"><a href="#ObjectiveResource-516"><span class="linenos">516</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ObjectiveResource</span><span class="p">:</span>
</span><span id="ObjectiveResource-517"><a href="#ObjectiveResource-517"><span class="linenos">517</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_objective_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ObjectiveResource-518"><a href="#ObjectiveResource-518"><span class="linenos">518</span></a>        <span class="n">objectives</span> <span class="o">=</span> <span class="n">Objective</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="ObjectiveResource-519"><a href="#ObjectiveResource-519"><span class="linenos">519</span></a>        <span class="n">crop_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_objectives_by_crop</span><span class="p">(</span><span class="n">objectives</span><span class="p">)</span>
</span><span id="ObjectiveResource-520"><a href="#ObjectiveResource-520"><span class="linenos">520</span></a>        <span class="k">return</span> <span class="n">CropResponse</span><span class="p">(</span><span class="n">crop_data</span><span class="p">)</span>
</span><span id="ObjectiveResource-521"><a href="#ObjectiveResource-521"><span class="linenos">521</span></a>
</span><span id="ObjectiveResource-522"><a href="#ObjectiveResource-522"><span class="linenos">522</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_serialize_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objective</span><span class="p">):</span>
</span><span id="ObjectiveResource-523"><a href="#ObjectiveResource-523"><span class="linenos">523</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Serialize an Objective object to a dictionary (unchanged from your code)&quot;&quot;&quot;</span>
</span><span id="ObjectiveResource-524"><a href="#ObjectiveResource-524"><span class="linenos">524</span></a>        <span class="n">nutrient_targets</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ObjectiveResource-525"><a href="#ObjectiveResource-525"><span class="linenos">525</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">objective_nutrients</span><span class="p">)</span>
</span><span id="ObjectiveResource-526"><a href="#ObjectiveResource-526"><span class="linenos">526</span></a>            <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">objective_id</span><span class="o">=</span><span class="n">objective</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ObjectiveResource-527"><a href="#ObjectiveResource-527"><span class="linenos">527</span></a>            <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="ObjectiveResource-528"><a href="#ObjectiveResource-528"><span class="linenos">528</span></a>        <span class="p">)</span>
</span><span id="ObjectiveResource-529"><a href="#ObjectiveResource-529"><span class="linenos">529</span></a>        <span class="n">nutrient_targets_dict</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ObjectiveResource-530"><a href="#ObjectiveResource-530"><span class="linenos">530</span></a>            <span class="p">{</span>
</span><span id="ObjectiveResource-531"><a href="#ObjectiveResource-531"><span class="linenos">531</span></a>                <span class="s2">&quot;nutrient_id&quot;</span><span class="p">:</span> <span class="n">target</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">,</span>
</span><span id="ObjectiveResource-532"><a href="#ObjectiveResource-532"><span class="linenos">532</span></a>                <span class="s2">&quot;target_value&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">target_value</span><span class="p">)),</span>  <span class="c1"># Convert to Decimal</span>
</span><span id="ObjectiveResource-533"><a href="#ObjectiveResource-533"><span class="linenos">533</span></a>                <span class="s2">&quot;nutrient_name&quot;</span><span class="p">:</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="ObjectiveResource-534"><a href="#ObjectiveResource-534"><span class="linenos">534</span></a>                <span class="s2">&quot;nutrient_symbol&quot;</span><span class="p">:</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
</span><span id="ObjectiveResource-535"><a href="#ObjectiveResource-535"><span class="linenos">535</span></a>                <span class="s2">&quot;nutrient_unit&quot;</span><span class="p">:</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span>
</span><span id="ObjectiveResource-536"><a href="#ObjectiveResource-536"><span class="linenos">536</span></a>            <span class="p">}</span>
</span><span id="ObjectiveResource-537"><a href="#ObjectiveResource-537"><span class="linenos">537</span></a>            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">nutrient_targets</span>
</span><span id="ObjectiveResource-538"><a href="#ObjectiveResource-538"><span class="linenos">538</span></a>        <span class="p">]</span>
</span><span id="ObjectiveResource-539"><a href="#ObjectiveResource-539"><span class="linenos">539</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="ObjectiveResource-540"><a href="#ObjectiveResource-540"><span class="linenos">540</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">objective</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="ObjectiveResource-541"><a href="#ObjectiveResource-541"><span class="linenos">541</span></a>            <span class="s2">&quot;crop_id&quot;</span><span class="p">:</span> <span class="n">objective</span><span class="o">.</span><span class="n">crop_id</span><span class="p">,</span>
</span><span id="ObjectiveResource-542"><a href="#ObjectiveResource-542"><span class="linenos">542</span></a>            <span class="s2">&quot;crop_name&quot;</span><span class="p">:</span> <span class="n">objective</span><span class="o">.</span><span class="n">crop</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="ObjectiveResource-543"><a href="#ObjectiveResource-543"><span class="linenos">543</span></a>            <span class="s2">&quot;target_value&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">objective</span><span class="o">.</span><span class="n">target_value</span><span class="p">)),</span>
</span><span id="ObjectiveResource-544"><a href="#ObjectiveResource-544"><span class="linenos">544</span></a>            <span class="s2">&quot;protein&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">objective</span><span class="o">.</span><span class="n">protein</span><span class="p">)),</span>
</span><span id="ObjectiveResource-545"><a href="#ObjectiveResource-545"><span class="linenos">545</span></a>            <span class="s2">&quot;rest&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">objective</span><span class="o">.</span><span class="n">rest</span><span class="p">)),</span>
</span><span id="ObjectiveResource-546"><a href="#ObjectiveResource-546"><span class="linenos">546</span></a>            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">objective</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="ObjectiveResource-547"><a href="#ObjectiveResource-547"><span class="linenos">547</span></a>            <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">objective</span><span class="o">.</span><span class="n">updated_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="ObjectiveResource-548"><a href="#ObjectiveResource-548"><span class="linenos">548</span></a>            <span class="s2">&quot;nutrient_targets&quot;</span><span class="p">:</span> <span class="n">nutrient_targets_dict</span><span class="p">,</span>
</span><span id="ObjectiveResource-549"><a href="#ObjectiveResource-549"><span class="linenos">549</span></a>        <span class="p">}</span>
</span><span id="ObjectiveResource-550"><a href="#ObjectiveResource-550"><span class="linenos">550</span></a>
</span><span id="ObjectiveResource-551"><a href="#ObjectiveResource-551"><span class="linenos">551</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_objectives_by_crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objectives</span><span class="p">):</span>
</span><span id="ObjectiveResource-552"><a href="#ObjectiveResource-552"><span class="linenos">552</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process objectives into a dictionary grouped by crop name with multiple objectives&quot;&quot;&quot;</span>
</span><span id="ObjectiveResource-553"><a href="#ObjectiveResource-553"><span class="linenos">553</span></a>        <span class="n">crop_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ObjectiveResource-554"><a href="#ObjectiveResource-554"><span class="linenos">554</span></a>        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objectives</span><span class="p">:</span>
</span><span id="ObjectiveResource-555"><a href="#ObjectiveResource-555"><span class="linenos">555</span></a>            <span class="n">serialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_objective</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="ObjectiveResource-556"><a href="#ObjectiveResource-556"><span class="linenos">556</span></a>            <span class="n">crop_name</span> <span class="o">=</span> <span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;crop_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>  <span class="c1"># e.g., &#39;arroz&#39;, &#39;papa&#39;</span>
</span><span id="ObjectiveResource-557"><a href="#ObjectiveResource-557"><span class="linenos">557</span></a>            
</span><span id="ObjectiveResource-558"><a href="#ObjectiveResource-558"><span class="linenos">558</span></a>            <span class="c1"># Initialize crop entry as a list if not present</span>
</span><span id="ObjectiveResource-559"><a href="#ObjectiveResource-559"><span class="linenos">559</span></a>            <span class="k">if</span> <span class="n">crop_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">crop_dict</span><span class="p">:</span>
</span><span id="ObjectiveResource-560"><a href="#ObjectiveResource-560"><span class="linenos">560</span></a>                <span class="n">crop_dict</span><span class="p">[</span><span class="n">crop_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ObjectiveResource-561"><a href="#ObjectiveResource-561"><span class="linenos">561</span></a>            
</span><span id="ObjectiveResource-562"><a href="#ObjectiveResource-562"><span class="linenos">562</span></a>            <span class="c1"># Simplify nutrient targets into a dict for easier access</span>
</span><span id="ObjectiveResource-563"><a href="#ObjectiveResource-563"><span class="linenos">563</span></a>            <span class="n">nutrient_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ObjectiveResource-564"><a href="#ObjectiveResource-564"><span class="linenos">564</span></a>                <span class="n">target</span><span class="p">[</span><span class="s2">&quot;nutrient_name&quot;</span><span class="p">]:</span> <span class="n">target</span><span class="p">[</span><span class="s2">&quot;target_value&quot;</span><span class="p">]</span>
</span><span id="ObjectiveResource-565"><a href="#ObjectiveResource-565"><span class="linenos">565</span></a>                <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;nutrient_targets&quot;</span><span class="p">]</span>
</span><span id="ObjectiveResource-566"><a href="#ObjectiveResource-566"><span class="linenos">566</span></a>            <span class="p">}</span>
</span><span id="ObjectiveResource-567"><a href="#ObjectiveResource-567"><span class="linenos">567</span></a>            <span class="c1"># Add objective data to the crop&#39;s list</span>
</span><span id="ObjectiveResource-568"><a href="#ObjectiveResource-568"><span class="linenos">568</span></a>            <span class="n">crop_dict</span><span class="p">[</span><span class="n">crop_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="ObjectiveResource-569"><a href="#ObjectiveResource-569"><span class="linenos">569</span></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="ObjectiveResource-570"><a href="#ObjectiveResource-570"><span class="linenos">570</span></a>                <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;created_at&quot;</span><span class="p">],</span>
</span><span id="ObjectiveResource-571"><a href="#ObjectiveResource-571"><span class="linenos">571</span></a>                <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">],</span>
</span><span id="ObjectiveResource-572"><a href="#ObjectiveResource-572"><span class="linenos">572</span></a>                <span class="s2">&quot;nutrients&quot;</span><span class="p">:</span> <span class="n">nutrient_dict</span>
</span><span id="ObjectiveResource-573"><a href="#ObjectiveResource-573"><span class="linenos">573</span></a>            <span class="p">})</span>
</span><span id="ObjectiveResource-574"><a href="#ObjectiveResource-574"><span class="linenos">574</span></a>        
</span><span id="ObjectiveResource-575"><a href="#ObjectiveResource-575"><span class="linenos">575</span></a>        <span class="k">return</span> <span class="n">crop_dict</span>
</span></pre></div>


    

                            <div id="ObjectiveResource.get_objective_list" class="classattr">
                                        <input id="ObjectiveResource.get_objective_list-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_objective_list</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ObjectiveResource.get_objective_list-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ObjectiveResource.get_objective_list"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ObjectiveResource.get_objective_list-517"><a href="#ObjectiveResource.get_objective_list-517"><span class="linenos">517</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_objective_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ObjectiveResource.get_objective_list-518"><a href="#ObjectiveResource.get_objective_list-518"><span class="linenos">518</span></a>        <span class="n">objectives</span> <span class="o">=</span> <span class="n">Objective</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="ObjectiveResource.get_objective_list-519"><a href="#ObjectiveResource.get_objective_list-519"><span class="linenos">519</span></a>        <span class="n">crop_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_objectives_by_crop</span><span class="p">(</span><span class="n">objectives</span><span class="p">)</span>
</span><span id="ObjectiveResource.get_objective_list-520"><a href="#ObjectiveResource.get_objective_list-520"><span class="linenos">520</span></a>        <span class="k">return</span> <span class="n">CropResponse</span><span class="p">(</span><span class="n">crop_data</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="CropResponse">
                            <input id="CropResponse-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CropResponse</span>:

                <label class="view-source-button" for="CropResponse-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CropResponse"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CropResponse-577"><a href="#CropResponse-577"><span class="linenos">577</span></a><span class="k">class</span><span class="w"> </span><span class="nc">CropResponse</span><span class="p">:</span>
</span><span id="CropResponse-578"><a href="#CropResponse-578"><span class="linenos">578</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom response class to allow accessing crop data like response.arroz&quot;&quot;&quot;</span>
</span><span id="CropResponse-579"><a href="#CropResponse-579"><span class="linenos">579</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crop_data</span><span class="p">):</span>
</span><span id="CropResponse-580"><a href="#CropResponse-580"><span class="linenos">580</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crop_data</span> <span class="o">=</span> <span class="n">crop_data</span>
</span><span id="CropResponse-581"><a href="#CropResponse-581"><span class="linenos">581</span></a>        <span class="c1"># Dynamically set attributes for each crop</span>
</span><span id="CropResponse-582"><a href="#CropResponse-582"><span class="linenos">582</span></a>        <span class="k">for</span> <span class="n">crop_name</span> <span class="ow">in</span> <span class="n">crop_data</span><span class="p">:</span>
</span><span id="CropResponse-583"><a href="#CropResponse-583"><span class="linenos">583</span></a>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crop_name</span><span class="p">,</span> <span class="n">CropObjectives</span><span class="p">(</span><span class="n">crop_data</span><span class="p">[</span><span class="n">crop_name</span><span class="p">]))</span>
</span><span id="CropResponse-584"><a href="#CropResponse-584"><span class="linenos">584</span></a>
</span><span id="CropResponse-585"><a href="#CropResponse-585"><span class="linenos">585</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CropResponse-586"><a href="#CropResponse-586"><span class="linenos">586</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the full crop data as JSON&quot;&quot;&quot;</span>
</span><span id="CropResponse-587"><a href="#CropResponse-587"><span class="linenos">587</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crop_data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Custom response class to allow accessing crop data like response.arroz</p>
</div>


                            <div id="CropResponse.__init__" class="classattr">
                                        <input id="CropResponse.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">CropResponse</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">crop_data</span></span>)</span>

                <label class="view-source-button" for="CropResponse.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CropResponse.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CropResponse.__init__-579"><a href="#CropResponse.__init__-579"><span class="linenos">579</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crop_data</span><span class="p">):</span>
</span><span id="CropResponse.__init__-580"><a href="#CropResponse.__init__-580"><span class="linenos">580</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">crop_data</span> <span class="o">=</span> <span class="n">crop_data</span>
</span><span id="CropResponse.__init__-581"><a href="#CropResponse.__init__-581"><span class="linenos">581</span></a>        <span class="c1"># Dynamically set attributes for each crop</span>
</span><span id="CropResponse.__init__-582"><a href="#CropResponse.__init__-582"><span class="linenos">582</span></a>        <span class="k">for</span> <span class="n">crop_name</span> <span class="ow">in</span> <span class="n">crop_data</span><span class="p">:</span>
</span><span id="CropResponse.__init__-583"><a href="#CropResponse.__init__-583"><span class="linenos">583</span></a>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crop_name</span><span class="p">,</span> <span class="n">CropObjectives</span><span class="p">(</span><span class="n">crop_data</span><span class="p">[</span><span class="n">crop_name</span><span class="p">]))</span>
</span></pre></div>


    

                            </div>
                            <div id="CropResponse.crop_data" class="classattr">
                                <div class="attr variable">
            <span class="name">crop_data</span>

        
    </div>
    <a class="headerlink" href="#CropResponse.crop_data"></a>
    
    

                            </div>
                            <div id="CropResponse.get_json" class="classattr">
                                        <input id="CropResponse.get_json-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_json</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CropResponse.get_json-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CropResponse.get_json"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CropResponse.get_json-585"><a href="#CropResponse.get_json-585"><span class="linenos">585</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CropResponse.get_json-586"><a href="#CropResponse.get_json-586"><span class="linenos">586</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the full crop data as JSON&quot;&quot;&quot;</span>
</span><span id="CropResponse.get_json-587"><a href="#CropResponse.get_json-587"><span class="linenos">587</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">crop_data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Return the full crop data as JSON</p>
</div>


                            </div>
                </section>
                <section id="CropObjectives">
                            <input id="CropObjectives-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CropObjectives</span>:

                <label class="view-source-button" for="CropObjectives-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CropObjectives"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CropObjectives-589"><a href="#CropObjectives-589"><span class="linenos">589</span></a><span class="k">class</span><span class="w"> </span><span class="nc">CropObjectives</span><span class="p">:</span>
</span><span id="CropObjectives-590"><a href="#CropObjectives-590"><span class="linenos">590</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class to handle multiple objectives for a single crop&quot;&quot;&quot;</span>
</span><span id="CropObjectives-591"><a href="#CropObjectives-591"><span class="linenos">591</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objectives</span><span class="p">):</span>
</span><span id="CropObjectives-592"><a href="#CropObjectives-592"><span class="linenos">592</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span> <span class="o">=</span> <span class="n">objectives</span>  <span class="c1"># List of objectives for this crop</span>
</span><span id="CropObjectives-593"><a href="#CropObjectives-593"><span class="linenos">593</span></a>
</span><span id="CropObjectives-594"><a href="#CropObjectives-594"><span class="linenos">594</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="CropObjectives-595"><a href="#CropObjectives-595"><span class="linenos">595</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Access a specific objective by index or id&quot;&quot;&quot;</span>
</span><span id="CropObjectives-596"><a href="#CropObjectives-596"><span class="linenos">596</span></a>        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CropObjectives-597"><a href="#CropObjectives-597"><span class="linenos">597</span></a>            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">:</span>
</span><span id="CropObjectives-598"><a href="#CropObjectives-598"><span class="linenos">598</span></a>                <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
</span><span id="CropObjectives-599"><a href="#CropObjectives-599"><span class="linenos">599</span></a>                    <span class="k">return</span> <span class="n">CropData</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span>
</span><span id="CropObjectives-600"><a href="#CropObjectives-600"><span class="linenos">600</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No objective found with id </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CropObjectives-601"><a href="#CropObjectives-601"><span class="linenos">601</span></a>        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CropObjectives-602"><a href="#CropObjectives-602"><span class="linenos">602</span></a>            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">):</span>
</span><span id="CropObjectives-603"><a href="#CropObjectives-603"><span class="linenos">603</span></a>                <span class="k">return</span> <span class="n">CropData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span>
</span><span id="CropObjectives-604"><a href="#CropObjectives-604"><span class="linenos">604</span></a>            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> out of range for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">)</span><span class="si">}</span><span class="s2"> objectives&quot;</span><span class="p">)</span>
</span><span id="CropObjectives-605"><a href="#CropObjectives-605"><span class="linenos">605</span></a>        <span class="c1"># Default: return the most recent objective (based on updated_at)</span>
</span><span id="CropObjectives-606"><a href="#CropObjectives-606"><span class="linenos">606</span></a>        <span class="n">sorted_objectives</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="CropObjectives-607"><a href="#CropObjectives-607"><span class="linenos">607</span></a>        <span class="k">return</span> <span class="n">CropData</span><span class="p">(</span><span class="n">sorted_objectives</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span>
</span><span id="CropObjectives-608"><a href="#CropObjectives-608"><span class="linenos">608</span></a>
</span><span id="CropObjectives-609"><a href="#CropObjectives-609"><span class="linenos">609</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CropObjectives-610"><a href="#CropObjectives-610"><span class="linenos">610</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all objectives as a list of CropData objects&quot;&quot;&quot;</span>
</span><span id="CropObjectives-611"><a href="#CropObjectives-611"><span class="linenos">611</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">CropData</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">]</span>
</span><span id="CropObjectives-612"><a href="#CropObjectives-612"><span class="linenos">612</span></a>
</span><span id="CropObjectives-613"><a href="#CropObjectives-613"><span class="linenos">613</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CropObjectives-614"><a href="#CropObjectives-614"><span class="linenos">614</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all objectives as JSON&quot;&quot;&quot;</span>
</span><span id="CropObjectives-615"><a href="#CropObjectives-615"><span class="linenos">615</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Class to handle multiple objectives for a single crop</p>
</div>


                            <div id="CropObjectives.__init__" class="classattr">
                                        <input id="CropObjectives.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">CropObjectives</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">objectives</span></span>)</span>

                <label class="view-source-button" for="CropObjectives.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CropObjectives.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CropObjectives.__init__-591"><a href="#CropObjectives.__init__-591"><span class="linenos">591</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objectives</span><span class="p">):</span>
</span><span id="CropObjectives.__init__-592"><a href="#CropObjectives.__init__-592"><span class="linenos">592</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span> <span class="o">=</span> <span class="n">objectives</span>  <span class="c1"># List of objectives for this crop</span>
</span></pre></div>


    

                            </div>
                            <div id="CropObjectives.objectives" class="classattr">
                                <div class="attr variable">
            <span class="name">objectives</span>

        
    </div>
    <a class="headerlink" href="#CropObjectives.objectives"></a>
    
    

                            </div>
                            <div id="CropObjectives.get" class="classattr">
                                        <input id="CropObjectives.get-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">index</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="nb">id</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CropObjectives.get-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CropObjectives.get"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CropObjectives.get-594"><a href="#CropObjectives.get-594"><span class="linenos">594</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="CropObjectives.get-595"><a href="#CropObjectives.get-595"><span class="linenos">595</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Access a specific objective by index or id&quot;&quot;&quot;</span>
</span><span id="CropObjectives.get-596"><a href="#CropObjectives.get-596"><span class="linenos">596</span></a>        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CropObjectives.get-597"><a href="#CropObjectives.get-597"><span class="linenos">597</span></a>            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">:</span>
</span><span id="CropObjectives.get-598"><a href="#CropObjectives.get-598"><span class="linenos">598</span></a>                <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
</span><span id="CropObjectives.get-599"><a href="#CropObjectives.get-599"><span class="linenos">599</span></a>                    <span class="k">return</span> <span class="n">CropData</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span>
</span><span id="CropObjectives.get-600"><a href="#CropObjectives.get-600"><span class="linenos">600</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No objective found with id </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CropObjectives.get-601"><a href="#CropObjectives.get-601"><span class="linenos">601</span></a>        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CropObjectives.get-602"><a href="#CropObjectives.get-602"><span class="linenos">602</span></a>            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">):</span>
</span><span id="CropObjectives.get-603"><a href="#CropObjectives.get-603"><span class="linenos">603</span></a>                <span class="k">return</span> <span class="n">CropData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span>
</span><span id="CropObjectives.get-604"><a href="#CropObjectives.get-604"><span class="linenos">604</span></a>            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> out of range for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">)</span><span class="si">}</span><span class="s2"> objectives&quot;</span><span class="p">)</span>
</span><span id="CropObjectives.get-605"><a href="#CropObjectives.get-605"><span class="linenos">605</span></a>        <span class="c1"># Default: return the most recent objective (based on updated_at)</span>
</span><span id="CropObjectives.get-606"><a href="#CropObjectives.get-606"><span class="linenos">606</span></a>        <span class="n">sorted_objectives</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="CropObjectives.get-607"><a href="#CropObjectives.get-607"><span class="linenos">607</span></a>        <span class="k">return</span> <span class="n">CropData</span><span class="p">(</span><span class="n">sorted_objectives</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Access a specific objective by index or id</p>
</div>


                            </div>
                            <div id="CropObjectives.all" class="classattr">
                                        <input id="CropObjectives.all-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">all</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CropObjectives.all-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CropObjectives.all"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CropObjectives.all-609"><a href="#CropObjectives.all-609"><span class="linenos">609</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CropObjectives.all-610"><a href="#CropObjectives.all-610"><span class="linenos">610</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all objectives as a list of CropData objects&quot;&quot;&quot;</span>
</span><span id="CropObjectives.all-611"><a href="#CropObjectives.all-611"><span class="linenos">611</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">CropData</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Return all objectives as a list of CropData objects</p>
</div>


                            </div>
                            <div id="CropObjectives.get_json" class="classattr">
                                        <input id="CropObjectives.get_json-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_json</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CropObjectives.get_json-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CropObjectives.get_json"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CropObjectives.get_json-613"><a href="#CropObjectives.get_json-613"><span class="linenos">613</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CropObjectives.get_json-614"><a href="#CropObjectives.get_json-614"><span class="linenos">614</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all objectives as JSON&quot;&quot;&quot;</span>
</span><span id="CropObjectives.get_json-615"><a href="#CropObjectives.get_json-615"><span class="linenos">615</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">objectives</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Return all objectives as JSON</p>
</div>


                            </div>
                </section>
                <section id="CropData">
                            <input id="CropData-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CropData</span>:

                <label class="view-source-button" for="CropData-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CropData"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CropData-617"><a href="#CropData-617"><span class="linenos">617</span></a><span class="k">class</span><span class="w"> </span><span class="nc">CropData</span><span class="p">:</span>
</span><span id="CropData-618"><a href="#CropData-618"><span class="linenos">618</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper class to represent nutrient data for a single objective&quot;&quot;&quot;</span>
</span><span id="CropData-619"><a href="#CropData-619"><span class="linenos">619</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nutrient_data</span><span class="p">):</span>
</span><span id="CropData-620"><a href="#CropData-620"><span class="linenos">620</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nutrient_data</span> <span class="o">=</span> <span class="n">nutrient_data</span>
</span><span id="CropData-621"><a href="#CropData-621"><span class="linenos">621</span></a>
</span><span id="CropData-622"><a href="#CropData-622"><span class="linenos">622</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CropData-623"><a href="#CropData-623"><span class="linenos">623</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return nutrient data as JSON&quot;&quot;&quot;</span>
</span><span id="CropData-624"><a href="#CropData-624"><span class="linenos">624</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nutrient_data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span><span id="CropData-625"><a href="#CropData-625"><span class="linenos">625</span></a>
</span><span id="CropData-626"><a href="#CropData-626"><span class="linenos">626</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CropData-627"><a href="#CropData-627"><span class="linenos">627</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;String representation for printing&quot;&quot;&quot;</span>
</span><span id="CropData-628"><a href="#CropData-628"><span class="linenos">628</span></a>        <span class="k">return</span> <span class="nb">str</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutrient_data</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
</span></pre></div>


            <div class="docstring"><p>Helper class to represent nutrient data for a single objective</p>
</div>


                            <div id="CropData.__init__" class="classattr">
                                        <input id="CropData.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">CropData</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">nutrient_data</span></span>)</span>

                <label class="view-source-button" for="CropData.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CropData.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CropData.__init__-619"><a href="#CropData.__init__-619"><span class="linenos">619</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nutrient_data</span><span class="p">):</span>
</span><span id="CropData.__init__-620"><a href="#CropData.__init__-620"><span class="linenos">620</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nutrient_data</span> <span class="o">=</span> <span class="n">nutrient_data</span>
</span></pre></div>


    

                            </div>
                            <div id="CropData.nutrient_data" class="classattr">
                                <div class="attr variable">
            <span class="name">nutrient_data</span>

        
    </div>
    <a class="headerlink" href="#CropData.nutrient_data"></a>
    
    

                            </div>
                            <div id="CropData.get_json" class="classattr">
                                        <input id="CropData.get_json-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_json</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CropData.get_json-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CropData.get_json"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CropData.get_json-622"><a href="#CropData.get_json-622"><span class="linenos">622</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CropData.get_json-623"><a href="#CropData.get_json-623"><span class="linenos">623</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return nutrient data as JSON&quot;&quot;&quot;</span>
</span><span id="CropData.get_json-624"><a href="#CropData.get_json-624"><span class="linenos">624</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nutrient_data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Return nutrient data as JSON</p>
</div>


                            </div>
                </section>
                <section id="LeafAnalysisResource">
                            <input id="LeafAnalysisResource-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LeafAnalysisResource</span>:

                <label class="view-source-button" for="LeafAnalysisResource-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeafAnalysisResource"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeafAnalysisResource-634"><a href="#LeafAnalysisResource-634"><span class="linenos">634</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LeafAnalysisResource</span><span class="p">:</span>
</span><span id="LeafAnalysisResource-635"><a href="#LeafAnalysisResource-635"><span class="linenos">635</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_leaf_analysis_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LeafAnalysisResource-636"><a href="#LeafAnalysisResource-636"><span class="linenos">636</span></a>        <span class="n">leaf_analyses</span> <span class="o">=</span> <span class="n">LeafAnalysis</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="LeafAnalysisResource-637"><a href="#LeafAnalysisResource-637"><span class="linenos">637</span></a>        
</span><span id="LeafAnalysisResource-638"><a href="#LeafAnalysisResource-638"><span class="linenos">638</span></a>        <span class="c1"># Process leaf analyses into a structure grouped by common_analysis_id</span>
</span><span id="LeafAnalysisResource-639"><a href="#LeafAnalysisResource-639"><span class="linenos">639</span></a>        <span class="n">analysis_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_leaf_analyses_by_common_id</span><span class="p">(</span><span class="n">leaf_analyses</span><span class="p">)</span>
</span><span id="LeafAnalysisResource-640"><a href="#LeafAnalysisResource-640"><span class="linenos">640</span></a>        <span class="k">return</span> <span class="n">LeafAnalysisResponse</span><span class="p">(</span><span class="n">analysis_data</span><span class="p">)</span>
</span><span id="LeafAnalysisResource-641"><a href="#LeafAnalysisResource-641"><span class="linenos">641</span></a>
</span><span id="LeafAnalysisResource-642"><a href="#LeafAnalysisResource-642"><span class="linenos">642</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_serialize_leaf_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">leaf_analysis</span><span class="p">):</span>
</span><span id="LeafAnalysisResource-643"><a href="#LeafAnalysisResource-643"><span class="linenos">643</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Serializa un objeto LeafAnalysis a un diccionario.&quot;&quot;&quot;</span>
</span><span id="LeafAnalysisResource-644"><a href="#LeafAnalysisResource-644"><span class="linenos">644</span></a>        <span class="n">nutrient_values</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LeafAnalysisResource-645"><a href="#LeafAnalysisResource-645"><span class="linenos">645</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">leaf_analysis_nutrients</span><span class="p">)</span>
</span><span id="LeafAnalysisResource-646"><a href="#LeafAnalysisResource-646"><span class="linenos">646</span></a>            <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">leaf_analysis_id</span><span class="o">=</span><span class="n">leaf_analysis</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="LeafAnalysisResource-647"><a href="#LeafAnalysisResource-647"><span class="linenos">647</span></a>            <span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="LeafAnalysisResource-648"><a href="#LeafAnalysisResource-648"><span class="linenos">648</span></a>        <span class="p">)</span>
</span><span id="LeafAnalysisResource-649"><a href="#LeafAnalysisResource-649"><span class="linenos">649</span></a>        <span class="n">nutrient_values_dict</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LeafAnalysisResource-650"><a href="#LeafAnalysisResource-650"><span class="linenos">650</span></a>            <span class="p">{</span>
</span><span id="LeafAnalysisResource-651"><a href="#LeafAnalysisResource-651"><span class="linenos">651</span></a>                <span class="s2">&quot;nutrient_id&quot;</span><span class="p">:</span> <span class="n">nv</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">,</span>
</span><span id="LeafAnalysisResource-652"><a href="#LeafAnalysisResource-652"><span class="linenos">652</span></a>                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">nv</span><span class="o">.</span><span class="n">value</span><span class="p">)),</span>  <span class="c1"># Convert to Decimal</span>
</span><span id="LeafAnalysisResource-653"><a href="#LeafAnalysisResource-653"><span class="linenos">653</span></a>                <span class="s2">&quot;nutrient_name&quot;</span><span class="p">:</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nv</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="LeafAnalysisResource-654"><a href="#LeafAnalysisResource-654"><span class="linenos">654</span></a>                <span class="s2">&quot;nutrient_symbol&quot;</span><span class="p">:</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nv</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
</span><span id="LeafAnalysisResource-655"><a href="#LeafAnalysisResource-655"><span class="linenos">655</span></a>                <span class="s2">&quot;nutrient_unit&quot;</span><span class="p">:</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nv</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span><span class="o">.</span><span class="n">unit</span><span class="p">,</span>
</span><span id="LeafAnalysisResource-656"><a href="#LeafAnalysisResource-656"><span class="linenos">656</span></a>            <span class="p">}</span>
</span><span id="LeafAnalysisResource-657"><a href="#LeafAnalysisResource-657"><span class="linenos">657</span></a>            <span class="k">for</span> <span class="n">nv</span> <span class="ow">in</span> <span class="n">nutrient_values</span>
</span><span id="LeafAnalysisResource-658"><a href="#LeafAnalysisResource-658"><span class="linenos">658</span></a>        <span class="p">]</span>
</span><span id="LeafAnalysisResource-659"><a href="#LeafAnalysisResource-659"><span class="linenos">659</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="LeafAnalysisResource-660"><a href="#LeafAnalysisResource-660"><span class="linenos">660</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">leaf_analysis</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="LeafAnalysisResource-661"><a href="#LeafAnalysisResource-661"><span class="linenos">661</span></a>            <span class="s2">&quot;common_analysis_id&quot;</span><span class="p">:</span> <span class="n">leaf_analysis</span><span class="o">.</span><span class="n">common_analysis_id</span><span class="p">,</span>
</span><span id="LeafAnalysisResource-662"><a href="#LeafAnalysisResource-662"><span class="linenos">662</span></a>            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">leaf_analysis</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="LeafAnalysisResource-663"><a href="#LeafAnalysisResource-663"><span class="linenos">663</span></a>            <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">leaf_analysis</span><span class="o">.</span><span class="n">updated_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="LeafAnalysisResource-664"><a href="#LeafAnalysisResource-664"><span class="linenos">664</span></a>            <span class="s2">&quot;nutrient_values&quot;</span><span class="p">:</span> <span class="n">nutrient_values_dict</span><span class="p">,</span>
</span><span id="LeafAnalysisResource-665"><a href="#LeafAnalysisResource-665"><span class="linenos">665</span></a>        <span class="p">}</span>
</span><span id="LeafAnalysisResource-666"><a href="#LeafAnalysisResource-666"><span class="linenos">666</span></a>
</span><span id="LeafAnalysisResource-667"><a href="#LeafAnalysisResource-667"><span class="linenos">667</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_leaf_analyses_by_common_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">leaf_analyses</span><span class="p">):</span>
</span><span id="LeafAnalysisResource-668"><a href="#LeafAnalysisResource-668"><span class="linenos">668</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process leaf analyses into a dictionary grouped by common_analysis_id.&quot;&quot;&quot;</span>
</span><span id="LeafAnalysisResource-669"><a href="#LeafAnalysisResource-669"><span class="linenos">669</span></a>        <span class="n">analysis_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="LeafAnalysisResource-670"><a href="#LeafAnalysisResource-670"><span class="linenos">670</span></a>        <span class="k">for</span> <span class="n">leaf_analysis</span> <span class="ow">in</span> <span class="n">leaf_analyses</span><span class="p">:</span>
</span><span id="LeafAnalysisResource-671"><a href="#LeafAnalysisResource-671"><span class="linenos">671</span></a>            <span class="n">serialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_leaf_analysis</span><span class="p">(</span><span class="n">leaf_analysis</span><span class="p">)</span>
</span><span id="LeafAnalysisResource-672"><a href="#LeafAnalysisResource-672"><span class="linenos">672</span></a>            <span class="n">common_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;common_analysis_id&quot;</span><span class="p">])</span>  <span class="c1"># Convert to string for attribute access</span>
</span><span id="LeafAnalysisResource-673"><a href="#LeafAnalysisResource-673"><span class="linenos">673</span></a>            
</span><span id="LeafAnalysisResource-674"><a href="#LeafAnalysisResource-674"><span class="linenos">674</span></a>            <span class="c1"># Initialize entry as a list if not present</span>
</span><span id="LeafAnalysisResource-675"><a href="#LeafAnalysisResource-675"><span class="linenos">675</span></a>            <span class="k">if</span> <span class="n">common_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">analysis_dict</span><span class="p">:</span>
</span><span id="LeafAnalysisResource-676"><a href="#LeafAnalysisResource-676"><span class="linenos">676</span></a>                <span class="n">analysis_dict</span><span class="p">[</span><span class="n">common_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LeafAnalysisResource-677"><a href="#LeafAnalysisResource-677"><span class="linenos">677</span></a>            
</span><span id="LeafAnalysisResource-678"><a href="#LeafAnalysisResource-678"><span class="linenos">678</span></a>            <span class="c1"># Simplify nutrient values into a dict</span>
</span><span id="LeafAnalysisResource-679"><a href="#LeafAnalysisResource-679"><span class="linenos">679</span></a>            <span class="n">nutrient_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="LeafAnalysisResource-680"><a href="#LeafAnalysisResource-680"><span class="linenos">680</span></a>                <span class="n">nutrient</span><span class="p">[</span><span class="s2">&quot;nutrient_name&quot;</span><span class="p">]:</span> <span class="n">nutrient</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
</span><span id="LeafAnalysisResource-681"><a href="#LeafAnalysisResource-681"><span class="linenos">681</span></a>                <span class="k">for</span> <span class="n">nutrient</span> <span class="ow">in</span> <span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;nutrient_values&quot;</span><span class="p">]</span>
</span><span id="LeafAnalysisResource-682"><a href="#LeafAnalysisResource-682"><span class="linenos">682</span></a>            <span class="p">}</span>
</span><span id="LeafAnalysisResource-683"><a href="#LeafAnalysisResource-683"><span class="linenos">683</span></a>            <span class="c1"># Add analysis data to the common_analysis_id&#39;s list</span>
</span><span id="LeafAnalysisResource-684"><a href="#LeafAnalysisResource-684"><span class="linenos">684</span></a>            <span class="n">analysis_dict</span><span class="p">[</span><span class="n">common_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span id="LeafAnalysisResource-685"><a href="#LeafAnalysisResource-685"><span class="linenos">685</span></a>                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="LeafAnalysisResource-686"><a href="#LeafAnalysisResource-686"><span class="linenos">686</span></a>                <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;created_at&quot;</span><span class="p">],</span>
</span><span id="LeafAnalysisResource-687"><a href="#LeafAnalysisResource-687"><span class="linenos">687</span></a>                <span class="s2">&quot;updated_at&quot;</span><span class="p">:</span> <span class="n">serialized</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">],</span>
</span><span id="LeafAnalysisResource-688"><a href="#LeafAnalysisResource-688"><span class="linenos">688</span></a>                <span class="s2">&quot;nutrients&quot;</span><span class="p">:</span> <span class="n">nutrient_dict</span>
</span><span id="LeafAnalysisResource-689"><a href="#LeafAnalysisResource-689"><span class="linenos">689</span></a>            <span class="p">})</span>
</span><span id="LeafAnalysisResource-690"><a href="#LeafAnalysisResource-690"><span class="linenos">690</span></a>        
</span><span id="LeafAnalysisResource-691"><a href="#LeafAnalysisResource-691"><span class="linenos">691</span></a>        <span class="k">return</span> <span class="n">analysis_dict</span>
</span></pre></div>


    

                            <div id="LeafAnalysisResource.get_leaf_analysis_list" class="classattr">
                                        <input id="LeafAnalysisResource.get_leaf_analysis_list-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_leaf_analysis_list</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LeafAnalysisResource.get_leaf_analysis_list-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeafAnalysisResource.get_leaf_analysis_list"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeafAnalysisResource.get_leaf_analysis_list-635"><a href="#LeafAnalysisResource.get_leaf_analysis_list-635"><span class="linenos">635</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_leaf_analysis_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LeafAnalysisResource.get_leaf_analysis_list-636"><a href="#LeafAnalysisResource.get_leaf_analysis_list-636"><span class="linenos">636</span></a>        <span class="n">leaf_analyses</span> <span class="o">=</span> <span class="n">LeafAnalysis</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="LeafAnalysisResource.get_leaf_analysis_list-637"><a href="#LeafAnalysisResource.get_leaf_analysis_list-637"><span class="linenos">637</span></a>        
</span><span id="LeafAnalysisResource.get_leaf_analysis_list-638"><a href="#LeafAnalysisResource.get_leaf_analysis_list-638"><span class="linenos">638</span></a>        <span class="c1"># Process leaf analyses into a structure grouped by common_analysis_id</span>
</span><span id="LeafAnalysisResource.get_leaf_analysis_list-639"><a href="#LeafAnalysisResource.get_leaf_analysis_list-639"><span class="linenos">639</span></a>        <span class="n">analysis_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_leaf_analyses_by_common_id</span><span class="p">(</span><span class="n">leaf_analyses</span><span class="p">)</span>
</span><span id="LeafAnalysisResource.get_leaf_analysis_list-640"><a href="#LeafAnalysisResource.get_leaf_analysis_list-640"><span class="linenos">640</span></a>        <span class="k">return</span> <span class="n">LeafAnalysisResponse</span><span class="p">(</span><span class="n">analysis_data</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="LeafAnalysisResponse">
                            <input id="LeafAnalysisResponse-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LeafAnalysisResponse</span>:

                <label class="view-source-button" for="LeafAnalysisResponse-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeafAnalysisResponse"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeafAnalysisResponse-693"><a href="#LeafAnalysisResponse-693"><span class="linenos">693</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LeafAnalysisResponse</span><span class="p">:</span>
</span><span id="LeafAnalysisResponse-694"><a href="#LeafAnalysisResponse-694"><span class="linenos">694</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom response class to allow accessing leaf analyses like response.common_analysis_id.&lt;id&gt;&quot;&quot;&quot;</span>
</span><span id="LeafAnalysisResponse-695"><a href="#LeafAnalysisResponse-695"><span class="linenos">695</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_data</span><span class="p">):</span>
</span><span id="LeafAnalysisResponse-696"><a href="#LeafAnalysisResponse-696"><span class="linenos">696</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_data</span> <span class="o">=</span> <span class="n">analysis_data</span>
</span><span id="LeafAnalysisResponse-697"><a href="#LeafAnalysisResponse-697"><span class="linenos">697</span></a>        <span class="c1"># Dynamically create a nested object for common_analysis_id</span>
</span><span id="LeafAnalysisResponse-698"><a href="#LeafAnalysisResponse-698"><span class="linenos">698</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">common_analysis_id</span> <span class="o">=</span> <span class="n">CommonAnalysisContainer</span><span class="p">(</span><span class="n">analysis_data</span><span class="p">)</span>
</span><span id="LeafAnalysisResponse-699"><a href="#LeafAnalysisResponse-699"><span class="linenos">699</span></a>
</span><span id="LeafAnalysisResponse-700"><a href="#LeafAnalysisResponse-700"><span class="linenos">700</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LeafAnalysisResponse-701"><a href="#LeafAnalysisResponse-701"><span class="linenos">701</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the full analysis data as JSON&quot;&quot;&quot;</span>
</span><span id="LeafAnalysisResponse-702"><a href="#LeafAnalysisResponse-702"><span class="linenos">702</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Custom response class to allow accessing leaf analyses like response.common_analysis_id.<id></p>
</div>


                            <div id="LeafAnalysisResponse.__init__" class="classattr">
                                        <input id="LeafAnalysisResponse.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">LeafAnalysisResponse</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">analysis_data</span></span>)</span>

                <label class="view-source-button" for="LeafAnalysisResponse.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeafAnalysisResponse.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeafAnalysisResponse.__init__-695"><a href="#LeafAnalysisResponse.__init__-695"><span class="linenos">695</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_data</span><span class="p">):</span>
</span><span id="LeafAnalysisResponse.__init__-696"><a href="#LeafAnalysisResponse.__init__-696"><span class="linenos">696</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_data</span> <span class="o">=</span> <span class="n">analysis_data</span>
</span><span id="LeafAnalysisResponse.__init__-697"><a href="#LeafAnalysisResponse.__init__-697"><span class="linenos">697</span></a>        <span class="c1"># Dynamically create a nested object for common_analysis_id</span>
</span><span id="LeafAnalysisResponse.__init__-698"><a href="#LeafAnalysisResponse.__init__-698"><span class="linenos">698</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">common_analysis_id</span> <span class="o">=</span> <span class="n">CommonAnalysisContainer</span><span class="p">(</span><span class="n">analysis_data</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="LeafAnalysisResponse.analysis_data" class="classattr">
                                <div class="attr variable">
            <span class="name">analysis_data</span>

        
    </div>
    <a class="headerlink" href="#LeafAnalysisResponse.analysis_data"></a>
    
    

                            </div>
                            <div id="LeafAnalysisResponse.common_analysis_id" class="classattr">
                                <div class="attr variable">
            <span class="name">common_analysis_id</span>

        
    </div>
    <a class="headerlink" href="#LeafAnalysisResponse.common_analysis_id"></a>
    
    

                            </div>
                            <div id="LeafAnalysisResponse.get_json" class="classattr">
                                        <input id="LeafAnalysisResponse.get_json-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_json</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LeafAnalysisResponse.get_json-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeafAnalysisResponse.get_json"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeafAnalysisResponse.get_json-700"><a href="#LeafAnalysisResponse.get_json-700"><span class="linenos">700</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LeafAnalysisResponse.get_json-701"><a href="#LeafAnalysisResponse.get_json-701"><span class="linenos">701</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the full analysis data as JSON&quot;&quot;&quot;</span>
</span><span id="LeafAnalysisResponse.get_json-702"><a href="#LeafAnalysisResponse.get_json-702"><span class="linenos">702</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Return the full analysis data as JSON</p>
</div>


                            </div>
                </section>
                <section id="CommonAnalysisContainer">
                            <input id="CommonAnalysisContainer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CommonAnalysisContainer</span>:

                <label class="view-source-button" for="CommonAnalysisContainer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CommonAnalysisContainer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CommonAnalysisContainer-704"><a href="#CommonAnalysisContainer-704"><span class="linenos">704</span></a><span class="k">class</span><span class="w"> </span><span class="nc">CommonAnalysisContainer</span><span class="p">:</span>
</span><span id="CommonAnalysisContainer-705"><a href="#CommonAnalysisContainer-705"><span class="linenos">705</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Container for accessing leaf analyses by common_analysis_id&quot;&quot;&quot;</span>
</span><span id="CommonAnalysisContainer-706"><a href="#CommonAnalysisContainer-706"><span class="linenos">706</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_data</span><span class="p">):</span>
</span><span id="CommonAnalysisContainer-707"><a href="#CommonAnalysisContainer-707"><span class="linenos">707</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_data</span> <span class="o">=</span> <span class="n">analysis_data</span>
</span><span id="CommonAnalysisContainer-708"><a href="#CommonAnalysisContainer-708"><span class="linenos">708</span></a>        <span class="c1"># Dynamically set attributes for each common_analysis_id</span>
</span><span id="CommonAnalysisContainer-709"><a href="#CommonAnalysisContainer-709"><span class="linenos">709</span></a>        <span class="k">for</span> <span class="n">common_id</span> <span class="ow">in</span> <span class="n">analysis_data</span><span class="p">:</span>
</span><span id="CommonAnalysisContainer-710"><a href="#CommonAnalysisContainer-710"><span class="linenos">710</span></a>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">common_id</span><span class="p">,</span> <span class="n">LeafAnalyses</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_data</span><span class="p">[</span><span class="n">common_id</span><span class="p">]))</span>
</span></pre></div>


            <div class="docstring"><p>Container for accessing leaf analyses by common_analysis_id</p>
</div>


                            <div id="CommonAnalysisContainer.__init__" class="classattr">
                                        <input id="CommonAnalysisContainer.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">CommonAnalysisContainer</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">analysis_data</span></span>)</span>

                <label class="view-source-button" for="CommonAnalysisContainer.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CommonAnalysisContainer.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CommonAnalysisContainer.__init__-706"><a href="#CommonAnalysisContainer.__init__-706"><span class="linenos">706</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_data</span><span class="p">):</span>
</span><span id="CommonAnalysisContainer.__init__-707"><a href="#CommonAnalysisContainer.__init__-707"><span class="linenos">707</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">analysis_data</span> <span class="o">=</span> <span class="n">analysis_data</span>
</span><span id="CommonAnalysisContainer.__init__-708"><a href="#CommonAnalysisContainer.__init__-708"><span class="linenos">708</span></a>        <span class="c1"># Dynamically set attributes for each common_analysis_id</span>
</span><span id="CommonAnalysisContainer.__init__-709"><a href="#CommonAnalysisContainer.__init__-709"><span class="linenos">709</span></a>        <span class="k">for</span> <span class="n">common_id</span> <span class="ow">in</span> <span class="n">analysis_data</span><span class="p">:</span>
</span><span id="CommonAnalysisContainer.__init__-710"><a href="#CommonAnalysisContainer.__init__-710"><span class="linenos">710</span></a>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">common_id</span><span class="p">,</span> <span class="n">LeafAnalyses</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analysis_data</span><span class="p">[</span><span class="n">common_id</span><span class="p">]))</span>
</span></pre></div>


    

                            </div>
                            <div id="CommonAnalysisContainer.analysis_data" class="classattr">
                                <div class="attr variable">
            <span class="name">analysis_data</span>

        
    </div>
    <a class="headerlink" href="#CommonAnalysisContainer.analysis_data"></a>
    
    

                            </div>
                </section>
                <section id="LeafAnalyses">
                            <input id="LeafAnalyses-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LeafAnalyses</span>:

                <label class="view-source-button" for="LeafAnalyses-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeafAnalyses"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeafAnalyses-712"><a href="#LeafAnalyses-712"><span class="linenos">712</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LeafAnalyses</span><span class="p">:</span>
</span><span id="LeafAnalyses-713"><a href="#LeafAnalyses-713"><span class="linenos">713</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class to handle multiple leaf analyses for a single common_analysis_id&quot;&quot;&quot;</span>
</span><span id="LeafAnalyses-714"><a href="#LeafAnalyses-714"><span class="linenos">714</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analyses</span><span class="p">):</span>
</span><span id="LeafAnalyses-715"><a href="#LeafAnalyses-715"><span class="linenos">715</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">analyses</span> <span class="o">=</span> <span class="n">analyses</span>  <span class="c1"># List of leaf analyses for this common_analysis_id</span>
</span><span id="LeafAnalyses-716"><a href="#LeafAnalyses-716"><span class="linenos">716</span></a>
</span><span id="LeafAnalyses-717"><a href="#LeafAnalyses-717"><span class="linenos">717</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="LeafAnalyses-718"><a href="#LeafAnalyses-718"><span class="linenos">718</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Access a specific leaf analysis by index or id&quot;&quot;&quot;</span>
</span><span id="LeafAnalyses-719"><a href="#LeafAnalyses-719"><span class="linenos">719</span></a>        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LeafAnalyses-720"><a href="#LeafAnalyses-720"><span class="linenos">720</span></a>            <span class="k">for</span> <span class="n">analysis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">:</span>
</span><span id="LeafAnalyses-721"><a href="#LeafAnalyses-721"><span class="linenos">721</span></a>                <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
</span><span id="LeafAnalyses-722"><a href="#LeafAnalyses-722"><span class="linenos">722</span></a>                    <span class="k">return</span> <span class="n">LeafAnalysisData</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span>
</span><span id="LeafAnalyses-723"><a href="#LeafAnalyses-723"><span class="linenos">723</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No leaf analysis found with id </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LeafAnalyses-724"><a href="#LeafAnalyses-724"><span class="linenos">724</span></a>        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LeafAnalyses-725"><a href="#LeafAnalyses-725"><span class="linenos">725</span></a>            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">):</span>
</span><span id="LeafAnalyses-726"><a href="#LeafAnalyses-726"><span class="linenos">726</span></a>                <span class="k">return</span> <span class="n">LeafAnalysisData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span>
</span><span id="LeafAnalyses-727"><a href="#LeafAnalyses-727"><span class="linenos">727</span></a>            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> out of range for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">)</span><span class="si">}</span><span class="s2"> analyses&quot;</span><span class="p">)</span>
</span><span id="LeafAnalyses-728"><a href="#LeafAnalyses-728"><span class="linenos">728</span></a>        <span class="c1"># Default: return the most recent analysis (based on updated_at)</span>
</span><span id="LeafAnalyses-729"><a href="#LeafAnalyses-729"><span class="linenos">729</span></a>        <span class="n">sorted_analyses</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LeafAnalyses-730"><a href="#LeafAnalyses-730"><span class="linenos">730</span></a>        <span class="k">return</span> <span class="n">LeafAnalysisData</span><span class="p">(</span><span class="n">sorted_analyses</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span>
</span><span id="LeafAnalyses-731"><a href="#LeafAnalyses-731"><span class="linenos">731</span></a>
</span><span id="LeafAnalyses-732"><a href="#LeafAnalyses-732"><span class="linenos">732</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LeafAnalyses-733"><a href="#LeafAnalyses-733"><span class="linenos">733</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all analyses as a list of LeafAnalysisData objects&quot;&quot;&quot;</span>
</span><span id="LeafAnalyses-734"><a href="#LeafAnalyses-734"><span class="linenos">734</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">LeafAnalysisData</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">analysis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">]</span>
</span><span id="LeafAnalyses-735"><a href="#LeafAnalyses-735"><span class="linenos">735</span></a>
</span><span id="LeafAnalyses-736"><a href="#LeafAnalyses-736"><span class="linenos">736</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LeafAnalyses-737"><a href="#LeafAnalyses-737"><span class="linenos">737</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all analyses as JSON&quot;&quot;&quot;</span>
</span><span id="LeafAnalyses-738"><a href="#LeafAnalyses-738"><span class="linenos">738</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Class to handle multiple leaf analyses for a single common_analysis_id</p>
</div>


                            <div id="LeafAnalyses.__init__" class="classattr">
                                        <input id="LeafAnalyses.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">LeafAnalyses</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">analyses</span></span>)</span>

                <label class="view-source-button" for="LeafAnalyses.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeafAnalyses.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeafAnalyses.__init__-714"><a href="#LeafAnalyses.__init__-714"><span class="linenos">714</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analyses</span><span class="p">):</span>
</span><span id="LeafAnalyses.__init__-715"><a href="#LeafAnalyses.__init__-715"><span class="linenos">715</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">analyses</span> <span class="o">=</span> <span class="n">analyses</span>  <span class="c1"># List of leaf analyses for this common_analysis_id</span>
</span></pre></div>


    

                            </div>
                            <div id="LeafAnalyses.analyses" class="classattr">
                                <div class="attr variable">
            <span class="name">analyses</span>

        
    </div>
    <a class="headerlink" href="#LeafAnalyses.analyses"></a>
    
    

                            </div>
                            <div id="LeafAnalyses.get" class="classattr">
                                        <input id="LeafAnalyses.get-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">index</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="nb">id</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LeafAnalyses.get-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeafAnalyses.get"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeafAnalyses.get-717"><a href="#LeafAnalyses.get-717"><span class="linenos">717</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="LeafAnalyses.get-718"><a href="#LeafAnalyses.get-718"><span class="linenos">718</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Access a specific leaf analysis by index or id&quot;&quot;&quot;</span>
</span><span id="LeafAnalyses.get-719"><a href="#LeafAnalyses.get-719"><span class="linenos">719</span></a>        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LeafAnalyses.get-720"><a href="#LeafAnalyses.get-720"><span class="linenos">720</span></a>            <span class="k">for</span> <span class="n">analysis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">:</span>
</span><span id="LeafAnalyses.get-721"><a href="#LeafAnalyses.get-721"><span class="linenos">721</span></a>                <span class="k">if</span> <span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
</span><span id="LeafAnalyses.get-722"><a href="#LeafAnalyses.get-722"><span class="linenos">722</span></a>                    <span class="k">return</span> <span class="n">LeafAnalysisData</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span>
</span><span id="LeafAnalyses.get-723"><a href="#LeafAnalyses.get-723"><span class="linenos">723</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No leaf analysis found with id </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="LeafAnalyses.get-724"><a href="#LeafAnalyses.get-724"><span class="linenos">724</span></a>        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LeafAnalyses.get-725"><a href="#LeafAnalyses.get-725"><span class="linenos">725</span></a>            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">):</span>
</span><span id="LeafAnalyses.get-726"><a href="#LeafAnalyses.get-726"><span class="linenos">726</span></a>                <span class="k">return</span> <span class="n">LeafAnalysisData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span>
</span><span id="LeafAnalyses.get-727"><a href="#LeafAnalyses.get-727"><span class="linenos">727</span></a>            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> out of range for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">)</span><span class="si">}</span><span class="s2"> analyses&quot;</span><span class="p">)</span>
</span><span id="LeafAnalyses.get-728"><a href="#LeafAnalyses.get-728"><span class="linenos">728</span></a>        <span class="c1"># Default: return the most recent analysis (based on updated_at)</span>
</span><span id="LeafAnalyses.get-729"><a href="#LeafAnalyses.get-729"><span class="linenos">729</span></a>        <span class="n">sorted_analyses</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LeafAnalyses.get-730"><a href="#LeafAnalyses.get-730"><span class="linenos">730</span></a>        <span class="k">return</span> <span class="n">LeafAnalysisData</span><span class="p">(</span><span class="n">sorted_analyses</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Access a specific leaf analysis by index or id</p>
</div>


                            </div>
                            <div id="LeafAnalyses.all" class="classattr">
                                        <input id="LeafAnalyses.all-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">all</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LeafAnalyses.all-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeafAnalyses.all"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeafAnalyses.all-732"><a href="#LeafAnalyses.all-732"><span class="linenos">732</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LeafAnalyses.all-733"><a href="#LeafAnalyses.all-733"><span class="linenos">733</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all analyses as a list of LeafAnalysisData objects&quot;&quot;&quot;</span>
</span><span id="LeafAnalyses.all-734"><a href="#LeafAnalyses.all-734"><span class="linenos">734</span></a>        <span class="k">return</span> <span class="p">[</span><span class="n">LeafAnalysisData</span><span class="p">(</span><span class="n">analysis</span><span class="p">[</span><span class="s2">&quot;nutrients&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">analysis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Return all analyses as a list of LeafAnalysisData objects</p>
</div>


                            </div>
                            <div id="LeafAnalyses.get_json" class="classattr">
                                        <input id="LeafAnalyses.get_json-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_json</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LeafAnalyses.get_json-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeafAnalyses.get_json"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeafAnalyses.get_json-736"><a href="#LeafAnalyses.get_json-736"><span class="linenos">736</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LeafAnalyses.get_json-737"><a href="#LeafAnalyses.get_json-737"><span class="linenos">737</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all analyses as JSON&quot;&quot;&quot;</span>
</span><span id="LeafAnalyses.get_json-738"><a href="#LeafAnalyses.get_json-738"><span class="linenos">738</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analyses</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Return all analyses as JSON</p>
</div>


                            </div>
                </section>
                <section id="LeafAnalysisData">
                            <input id="LeafAnalysisData-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LeafAnalysisData</span>:

                <label class="view-source-button" for="LeafAnalysisData-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeafAnalysisData"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeafAnalysisData-740"><a href="#LeafAnalysisData-740"><span class="linenos">740</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LeafAnalysisData</span><span class="p">:</span>
</span><span id="LeafAnalysisData-741"><a href="#LeafAnalysisData-741"><span class="linenos">741</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper class to represent nutrient data for a single leaf analysis&quot;&quot;&quot;</span>
</span><span id="LeafAnalysisData-742"><a href="#LeafAnalysisData-742"><span class="linenos">742</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nutrient_data</span><span class="p">):</span>
</span><span id="LeafAnalysisData-743"><a href="#LeafAnalysisData-743"><span class="linenos">743</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nutrient_data</span> <span class="o">=</span> <span class="n">nutrient_data</span>
</span><span id="LeafAnalysisData-744"><a href="#LeafAnalysisData-744"><span class="linenos">744</span></a>
</span><span id="LeafAnalysisData-745"><a href="#LeafAnalysisData-745"><span class="linenos">745</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LeafAnalysisData-746"><a href="#LeafAnalysisData-746"><span class="linenos">746</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return nutrient data as JSON&quot;&quot;&quot;</span>
</span><span id="LeafAnalysisData-747"><a href="#LeafAnalysisData-747"><span class="linenos">747</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nutrient_data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span><span id="LeafAnalysisData-748"><a href="#LeafAnalysisData-748"><span class="linenos">748</span></a>
</span><span id="LeafAnalysisData-749"><a href="#LeafAnalysisData-749"><span class="linenos">749</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LeafAnalysisData-750"><a href="#LeafAnalysisData-750"><span class="linenos">750</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;String representation for printing&quot;&quot;&quot;</span>
</span><span id="LeafAnalysisData-751"><a href="#LeafAnalysisData-751"><span class="linenos">751</span></a>        <span class="k">return</span> <span class="nb">str</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nutrient_data</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
</span></pre></div>


            <div class="docstring"><p>Helper class to represent nutrient data for a single leaf analysis</p>
</div>


                            <div id="LeafAnalysisData.__init__" class="classattr">
                                        <input id="LeafAnalysisData.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">LeafAnalysisData</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">nutrient_data</span></span>)</span>

                <label class="view-source-button" for="LeafAnalysisData.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeafAnalysisData.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeafAnalysisData.__init__-742"><a href="#LeafAnalysisData.__init__-742"><span class="linenos">742</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nutrient_data</span><span class="p">):</span>
</span><span id="LeafAnalysisData.__init__-743"><a href="#LeafAnalysisData.__init__-743"><span class="linenos">743</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nutrient_data</span> <span class="o">=</span> <span class="n">nutrient_data</span>
</span></pre></div>


    

                            </div>
                            <div id="LeafAnalysisData.nutrient_data" class="classattr">
                                <div class="attr variable">
            <span class="name">nutrient_data</span>

        
    </div>
    <a class="headerlink" href="#LeafAnalysisData.nutrient_data"></a>
    
    

                            </div>
                            <div id="LeafAnalysisData.get_json" class="classattr">
                                        <input id="LeafAnalysisData.get_json-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_json</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LeafAnalysisData.get_json-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LeafAnalysisData.get_json"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LeafAnalysisData.get_json-745"><a href="#LeafAnalysisData.get_json-745"><span class="linenos">745</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LeafAnalysisData.get_json-746"><a href="#LeafAnalysisData.get_json-746"><span class="linenos">746</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return nutrient data as JSON&quot;&quot;&quot;</span>
</span><span id="LeafAnalysisData.get_json-747"><a href="#LeafAnalysisData.get_json-747"><span class="linenos">747</span></a>        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nutrient_data</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Return nutrient data as JSON</p>
</div>


                            </div>
                </section>
                <section id="ReportView">
                            <input id="ReportView-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ReportView</span><wbr>(<span class="base">flask.views.MethodView</span>):

                <label class="view-source-button" for="ReportView-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReportView"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReportView-756"><a href="#ReportView-756"><span class="linenos"> 756</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ReportView</span><span class="p">(</span><span class="n">MethodView</span><span class="p">):</span>
</span><span id="ReportView-757"><a href="#ReportView-757"><span class="linenos"> 757</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Clase para generar reportes integrados de análisis&quot;&quot;&quot;</span>
</span><span id="ReportView-758"><a href="#ReportView-758"><span class="linenos"> 758</span></a>    <span class="n">decorators</span> <span class="o">=</span> <span class="p">[</span><span class="n">jwt_required</span><span class="p">()]</span>
</span><span id="ReportView-759"><a href="#ReportView-759"><span class="linenos"> 759</span></a>
</span><span id="ReportView-760"><a href="#ReportView-760"><span class="linenos"> 760</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
</span><span id="ReportView-761"><a href="#ReportView-761"><span class="linenos"> 761</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReportView-762"><a href="#ReportView-762"><span class="linenos"> 762</span></a><span class="sd">        Genera reporte completo de análisis con niveles óptimos</span>
</span><span id="ReportView-763"><a href="#ReportView-763"><span class="linenos"> 763</span></a><span class="sd">        Args:</span>
</span><span id="ReportView-764"><a href="#ReportView-764"><span class="linenos"> 764</span></a><span class="sd">            common_analysis_id (int): ID del análisis común a reportar</span>
</span><span id="ReportView-765"><a href="#ReportView-765"><span class="linenos"> 765</span></a><span class="sd">            (NOTA: La ruta lo llama &#39;id&#39;, pero la lógica parece asumir que es un Recommendation ID)</span>
</span><span id="ReportView-766"><a href="#ReportView-766"><span class="linenos"> 766</span></a><span class="sd">        Returns:</span>
</span><span id="ReportView-767"><a href="#ReportView-767"><span class="linenos"> 767</span></a><span class="sd">            JSON: Estructura con datos de análisis y niveles óptimos</span>
</span><span id="ReportView-768"><a href="#ReportView-768"><span class="linenos"> 768</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReportView-769"><a href="#ReportView-769"><span class="linenos"> 769</span></a>        <span class="n">recommendation_id</span> <span class="o">=</span> <span class="nb">id</span> <span class="c1"># Asumiendo que el ID es de Recommendation</span>
</span><span id="ReportView-770"><a href="#ReportView-770"><span class="linenos"> 770</span></a>        <span class="n">report</span> <span class="o">=</span> <span class="n">Recommendation</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="n">recommendation_id</span><span class="p">)</span>
</span><span id="ReportView-771"><a href="#ReportView-771"><span class="linenos"> 771</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_access</span><span class="p">(</span><span class="n">report</span><span class="p">)</span> <span class="c1"># Pasar el objeto &#39;report&#39; para verificar acceso</span>
</span><span id="ReportView-772"><a href="#ReportView-772"><span class="linenos"> 772</span></a>
</span><span id="ReportView-773"><a href="#ReportView-773"><span class="linenos"> 773</span></a>        <span class="c1"># --- Deserializar datos del reporte ---</span>
</span><span id="ReportView-774"><a href="#ReportView-774"><span class="linenos"> 774</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ReportView-775"><a href="#ReportView-775"><span class="linenos"> 775</span></a>            <span class="c1"># Usar .get(&#39;{}&#39;) para evitar errores si el campo es None</span>
</span><span id="ReportView-776"><a href="#ReportView-776"><span class="linenos"> 776</span></a>            <span class="n">foliar_details_str</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">foliar_analysis_details</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span>
</span><span id="ReportView-777"><a href="#ReportView-777"><span class="linenos"> 777</span></a>            <span class="n">soil_details_str</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">soil_analysis_details</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span>
</span><span id="ReportView-778"><a href="#ReportView-778"><span class="linenos"> 778</span></a>            <span class="n">optimal_levels_str</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">optimal_comparison</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span>
</span><span id="ReportView-779"><a href="#ReportView-779"><span class="linenos"> 779</span></a>            <span class="n">recommendations_str</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">automatic_recommendations</span> <span class="ow">or</span> <span class="s1">&#39;[]&#39;</span> <span class="c1"># Asumir lista JSON</span>
</span><span id="ReportView-780"><a href="#ReportView-780"><span class="linenos"> 780</span></a>
</span><span id="ReportView-781"><a href="#ReportView-781"><span class="linenos"> 781</span></a>            <span class="n">foliar_details</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">foliar_details_str</span><span class="p">)</span>
</span><span id="ReportView-782"><a href="#ReportView-782"><span class="linenos"> 782</span></a>            <span class="n">soil_details</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">soil_details_str</span><span class="p">)</span>
</span><span id="ReportView-783"><a href="#ReportView-783"><span class="linenos"> 783</span></a>            <span class="n">optimal_levels</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">optimal_levels_str</span><span class="p">)</span>
</span><span id="ReportView-784"><a href="#ReportView-784"><span class="linenos"> 784</span></a>            <span class="n">recommendations_list</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">recommendations_str</span><span class="p">)</span>
</span><span id="ReportView-785"><a href="#ReportView-785"><span class="linenos"> 785</span></a>
</span><span id="ReportView-786"><a href="#ReportView-786"><span class="linenos"> 786</span></a>            <span class="c1"># Reconstruir analysisData (Necesita el CommonAnalysis)</span>
</span><span id="ReportView-787"><a href="#ReportView-787"><span class="linenos"> 787</span></a>            <span class="c1"># Tratar de obtener el common_analysis_id de los detalles deserializados</span>
</span><span id="ReportView-788"><a href="#ReportView-788"><span class="linenos"> 788</span></a>            <span class="n">common_analysis_id_foliar</span> <span class="o">=</span> <span class="n">foliar_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;common_analysis_id&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">foliar_details</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="ReportView-789"><a href="#ReportView-789"><span class="linenos"> 789</span></a>            <span class="n">common_analysis_id_soil</span> <span class="o">=</span> <span class="n">soil_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;common_analysis_id&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">soil_details</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="ReportView-790"><a href="#ReportView-790"><span class="linenos"> 790</span></a>            <span class="c1"># O obtenerlo desde el lote/fecha del reporte si no está en los detalles</span>
</span><span id="ReportView-791"><a href="#ReportView-791"><span class="linenos"> 791</span></a>            <span class="n">common_analysis</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ReportView-792"><a href="#ReportView-792"><span class="linenos"> 792</span></a>            <span class="k">if</span> <span class="n">common_analysis_id_foliar</span><span class="p">:</span>
</span><span id="ReportView-793"><a href="#ReportView-793"><span class="linenos"> 793</span></a>                 <span class="n">common_analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_common_analysis</span><span class="p">(</span><span class="n">common_analysis_id_foliar</span><span class="p">)</span>
</span><span id="ReportView-794"><a href="#ReportView-794"><span class="linenos"> 794</span></a>            <span class="k">elif</span> <span class="n">common_analysis_id_soil</span><span class="p">:</span>
</span><span id="ReportView-795"><a href="#ReportView-795"><span class="linenos"> 795</span></a>                 <span class="n">common_analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_common_analysis</span><span class="p">(</span><span class="n">common_analysis_id_soil</span><span class="p">)</span>
</span><span id="ReportView-796"><a href="#ReportView-796"><span class="linenos"> 796</span></a>            <span class="c1"># Fallback: buscar por lote y fecha si es necesario (puede ser impreciso)</span>
</span><span id="ReportView-797"><a href="#ReportView-797"><span class="linenos"> 797</span></a>            <span class="c1"># if not common_analysis and report.lot_id and report.date:</span>
</span><span id="ReportView-798"><a href="#ReportView-798"><span class="linenos"> 798</span></a>            <span class="c1">#      common_analysis = CommonAnalysis.query.filter_by(lot_id=report.lot_id, date=report.date).first()</span>
</span><span id="ReportView-799"><a href="#ReportView-799"><span class="linenos"> 799</span></a>
</span><span id="ReportView-800"><a href="#ReportView-800"><span class="linenos"> 800</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">common_analysis</span><span class="p">:</span>
</span><span id="ReportView-801"><a href="#ReportView-801"><span class="linenos"> 801</span></a>                 <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No se pudo determinar el CommonAnalysis asociado al reporte.&quot;</span><span class="p">)</span>
</span><span id="ReportView-802"><a href="#ReportView-802"><span class="linenos"> 802</span></a>
</span><span id="ReportView-803"><a href="#ReportView-803"><span class="linenos"> 803</span></a>            <span class="n">analysisData</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ReportView-804"><a href="#ReportView-804"><span class="linenos"> 804</span></a>                <span class="s2">&quot;common&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_common</span><span class="p">(</span><span class="n">common_analysis</span><span class="p">),</span>
</span><span id="ReportView-805"><a href="#ReportView-805"><span class="linenos"> 805</span></a>                <span class="s2">&quot;foliar&quot;</span><span class="p">:</span> <span class="n">foliar_details</span><span class="p">,</span>
</span><span id="ReportView-806"><a href="#ReportView-806"><span class="linenos"> 806</span></a>                <span class="s2">&quot;soil&quot;</span><span class="p">:</span> <span class="n">soil_details</span>
</span><span id="ReportView-807"><a href="#ReportView-807"><span class="linenos"> 807</span></a>            <span class="p">}</span>
</span><span id="ReportView-808"><a href="#ReportView-808"><span class="linenos"> 808</span></a>
</span><span id="ReportView-809"><a href="#ReportView-809"><span class="linenos"> 809</span></a>            <span class="c1"># Datos históricos (esto podría necesitar una consulta separada)</span>
</span><span id="ReportView-810"><a href="#ReportView-810"><span class="linenos"> 810</span></a>            <span class="n">historicalData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_historical_data</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">lot_id</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
</span><span id="ReportView-811"><a href="#ReportView-811"><span class="linenos"> 811</span></a>
</span><span id="ReportView-812"><a href="#ReportView-812"><span class="linenos"> 812</span></a>            <span class="c1"># Nutriente limitante</span>
</span><span id="ReportView-813"><a href="#ReportView-813"><span class="linenos"> 813</span></a>            <span class="n">limitingNutrientData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_limiting_nutrient_data</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">limiting_nutrient_id</span><span class="p">,</span> <span class="n">analysisData</span><span class="p">,</span> <span class="n">optimal_levels</span><span class="p">)</span>
</span><span id="ReportView-814"><a href="#ReportView-814"><span class="linenos"> 814</span></a>
</span><span id="ReportView-815"><a href="#ReportView-815"><span class="linenos"> 815</span></a>
</span><span id="ReportView-816"><a href="#ReportView-816"><span class="linenos"> 816</span></a>        <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ReportView-817"><a href="#ReportView-817"><span class="linenos"> 817</span></a>             <span class="n">current_app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deserializando datos del reporte </span><span class="si">{</span><span class="n">recommendation_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="ReportView-818"><a href="#ReportView-818"><span class="linenos"> 818</span></a>             <span class="c1"># Retornar un error o datos vacíos/predeterminados</span>
</span><span id="ReportView-819"><a href="#ReportView-819"><span class="linenos"> 819</span></a>             <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Error procesando datos del reporte&quot;</span><span class="p">}),</span> <span class="mi">500</span>
</span><span id="ReportView-820"><a href="#ReportView-820"><span class="linenos"> 820</span></a>
</span><span id="ReportView-821"><a href="#ReportView-821"><span class="linenos"> 821</span></a>        <span class="n">report_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ReportView-822"><a href="#ReportView-822"><span class="linenos"> 822</span></a>            <span class="s2">&quot;analysisData&quot;</span><span class="p">:</span> <span class="n">analysisData</span><span class="p">,</span>
</span><span id="ReportView-823"><a href="#ReportView-823"><span class="linenos"> 823</span></a>            <span class="s2">&quot;optimalLevels&quot;</span><span class="p">:</span> <span class="n">optimal_levels</span><span class="p">,</span>
</span><span id="ReportView-824"><a href="#ReportView-824"><span class="linenos"> 824</span></a>            <span class="s2">&quot;historicalData&quot;</span><span class="p">:</span> <span class="n">historicalData</span><span class="p">,</span>
</span><span id="ReportView-825"><a href="#ReportView-825"><span class="linenos"> 825</span></a>            <span class="s2">&quot;recommendations&quot;</span><span class="p">:</span> <span class="n">recommendations_list</span><span class="p">,</span>
</span><span id="ReportView-826"><a href="#ReportView-826"><span class="linenos"> 826</span></a>            <span class="s2">&quot;limitingNutrient&quot;</span><span class="p">:</span> <span class="n">limitingNutrientData</span><span class="p">,</span>
</span><span id="ReportView-827"><a href="#ReportView-827"><span class="linenos"> 827</span></a>            <span class="s2">&quot;nutrientNames&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nutrient_name_map</span><span class="p">()</span> <span class="c1"># Mapa de nombres para la plantilla</span>
</span><span id="ReportView-828"><a href="#ReportView-828"><span class="linenos"> 828</span></a>        <span class="p">}</span>
</span><span id="ReportView-829"><a href="#ReportView-829"><span class="linenos"> 829</span></a>
</span><span id="ReportView-830"><a href="#ReportView-830"><span class="linenos"> 830</span></a>        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">report_data</span><span class="p">),</span> <span class="mi">200</span>
</span><span id="ReportView-831"><a href="#ReportView-831"><span class="linenos"> 831</span></a>
</span><span id="ReportView-832"><a href="#ReportView-832"><span class="linenos"> 832</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_common_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_id</span><span class="p">):</span>
</span><span id="ReportView-833"><a href="#ReportView-833"><span class="linenos"> 833</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtiene el análisis común con relaciones optimizadas&quot;&quot;&quot;</span>
</span><span id="ReportView-834"><a href="#ReportView-834"><span class="linenos"> 834</span></a>        <span class="k">return</span> <span class="n">CommonAnalysis</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
</span><span id="ReportView-835"><a href="#ReportView-835"><span class="linenos"> 835</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="n">CommonAnalysis</span><span class="o">.</span><span class="n">lot</span><span class="p">)</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="n">Lot</span><span class="o">.</span><span class="n">farm</span><span class="p">),</span>
</span><span id="ReportView-836"><a href="#ReportView-836"><span class="linenos"> 836</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="n">CommonAnalysis</span><span class="o">.</span><span class="n">soil_analysis</span><span class="p">),</span>
</span><span id="ReportView-837"><a href="#ReportView-837"><span class="linenos"> 837</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="n">CommonAnalysis</span><span class="o">.</span><span class="n">leaf_analysis</span><span class="p">)</span>
</span><span id="ReportView-838"><a href="#ReportView-838"><span class="linenos"> 838</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="n">analysis_id</span><span class="p">)</span>
</span><span id="ReportView-839"><a href="#ReportView-839"><span class="linenos"> 839</span></a>
</span><span id="ReportView-840"><a href="#ReportView-840"><span class="linenos"> 840</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_access</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">common_analysis</span><span class="p">):</span>
</span><span id="ReportView-841"><a href="#ReportView-841"><span class="linenos"> 841</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Valida permisos de acceso a la organización&quot;&quot;&quot;</span>
</span><span id="ReportView-842"><a href="#ReportView-842"><span class="linenos"> 842</span></a>        <span class="n">claims</span> <span class="o">=</span> <span class="n">get_jwt</span><span class="p">()</span>
</span><span id="ReportView-843"><a href="#ReportView-843"><span class="linenos"> 843</span></a>        <span class="n">user_role</span> <span class="o">=</span> <span class="n">claims</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rol&quot;</span><span class="p">)</span>
</span><span id="ReportView-844"><a href="#ReportView-844"><span class="linenos"> 844</span></a>        
</span><span id="ReportView-845"><a href="#ReportView-845"><span class="linenos"> 845</span></a>        <span class="k">if</span> <span class="n">user_role</span> <span class="o">==</span> <span class="n">RoleEnum</span><span class="o">.</span><span class="n">ADMINISTRATOR</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
</span><span id="ReportView-846"><a href="#ReportView-846"><span class="linenos"> 846</span></a>            <span class="k">return</span>
</span><span id="ReportView-847"><a href="#ReportView-847"><span class="linenos"> 847</span></a>            
</span><span id="ReportView-848"><a href="#ReportView-848"><span class="linenos"> 848</span></a>        <span class="k">if</span> <span class="n">user_role</span> <span class="o">==</span> <span class="n">RoleEnum</span><span class="o">.</span><span class="n">RESELLER</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
</span><span id="ReportView-849"><a href="#ReportView-849"><span class="linenos"> 849</span></a>            <span class="n">org_id</span> <span class="o">=</span> <span class="n">common_analysis</span><span class="o">.</span><span class="n">organization</span><span class="o">.</span><span class="n">id</span> <span class="k">if</span> <span class="n">common_analysis</span><span class="o">.</span><span class="n">organization</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="ReportView-850"><a href="#ReportView-850"><span class="linenos"> 850</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">org_id</span><span class="p">:</span>
</span><span id="ReportView-851"><a href="#ReportView-851"><span class="linenos"> 851</span></a>                <span class="k">raise</span> <span class="n">Forbidden</span><span class="p">(</span><span class="s2">&quot;No se pudo determinar la organización del análisis&quot;</span><span class="p">)</span>
</span><span id="ReportView-852"><a href="#ReportView-852"><span class="linenos"> 852</span></a>                
</span><span id="ReportView-853"><a href="#ReportView-853"><span class="linenos"> 853</span></a>            <span class="n">reseller_package</span> <span class="o">=</span> <span class="n">ResellerPackage</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
</span><span id="ReportView-854"><a href="#ReportView-854"><span class="linenos"> 854</span></a>                <span class="n">reseller_id</span><span class="o">=</span><span class="n">claims</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;org_id&quot;</span><span class="p">)</span>
</span><span id="ReportView-855"><a href="#ReportView-855"><span class="linenos"> 855</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="ReportView-856"><a href="#ReportView-856"><span class="linenos"> 856</span></a>            
</span><span id="ReportView-857"><a href="#ReportView-857"><span class="linenos"> 857</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">reseller_package</span> <span class="ow">or</span> <span class="n">org_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reseller_package</span><span class="o">.</span><span class="n">organization_ids</span><span class="p">:</span>
</span><span id="ReportView-858"><a href="#ReportView-858"><span class="linenos"> 858</span></a>                <span class="k">raise</span> <span class="n">Forbidden</span><span class="p">(</span><span class="s2">&quot;Acceso denegado al recurso&quot;</span><span class="p">)</span>
</span><span id="ReportView-859"><a href="#ReportView-859"><span class="linenos"> 859</span></a>
</span><span id="ReportView-860"><a href="#ReportView-860"><span class="linenos"> 860</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_analysis_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis</span><span class="p">):</span>
</span><span id="ReportView-861"><a href="#ReportView-861"><span class="linenos"> 861</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Construye la estructura principal del reporte&quot;&quot;&quot;</span>
</span><span id="ReportView-862"><a href="#ReportView-862"><span class="linenos"> 862</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="ReportView-863"><a href="#ReportView-863"><span class="linenos"> 863</span></a>            <span class="s2">&quot;common&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_common</span><span class="p">(</span><span class="n">analysis</span><span class="p">),</span>
</span><span id="ReportView-864"><a href="#ReportView-864"><span class="linenos"> 864</span></a>            <span class="s2">&quot;foliar&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_foliar_data</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">leaf_analysis</span><span class="p">),</span>
</span><span id="ReportView-865"><a href="#ReportView-865"><span class="linenos"> 865</span></a>            <span class="s2">&quot;soil&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_soil_data</span><span class="p">(</span><span class="n">analysis</span><span class="o">.</span><span class="n">soil_analysis</span><span class="p">)</span>
</span><span id="ReportView-866"><a href="#ReportView-866"><span class="linenos"> 866</span></a>        <span class="p">}</span>
</span><span id="ReportView-867"><a href="#ReportView-867"><span class="linenos"> 867</span></a>
</span><span id="ReportView-868"><a href="#ReportView-868"><span class="linenos"> 868</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_serialize_common</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis</span><span class="p">):</span>
</span><span id="ReportView-869"><a href="#ReportView-869"><span class="linenos"> 869</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Serializa datos del análisis común&quot;&quot;&quot;</span>
</span><span id="ReportView-870"><a href="#ReportView-870"><span class="linenos"> 870</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="ReportView-871"><a href="#ReportView-871"><span class="linenos"> 871</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="ReportView-872"><a href="#ReportView-872"><span class="linenos"> 872</span></a>            <span class="s2">&quot;fechaAnalisis&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="ReportView-873"><a href="#ReportView-873"><span class="linenos"> 873</span></a>            <span class="s2">&quot;finca&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">farm_name</span> <span class="k">if</span> <span class="n">analysis</span><span class="o">.</span><span class="n">lot</span> <span class="ow">and</span> <span class="n">analysis</span><span class="o">.</span><span class="n">lot</span><span class="o">.</span><span class="n">farm</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="ReportView-874"><a href="#ReportView-874"><span class="linenos"> 874</span></a>            <span class="s2">&quot;lote&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">lot_name</span> <span class="k">if</span> <span class="n">analysis</span><span class="o">.</span><span class="n">lot</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
</span><span id="ReportView-875"><a href="#ReportView-875"><span class="linenos"> 875</span></a>            <span class="s2">&quot;proteinas&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">protein</span><span class="p">,</span>
</span><span id="ReportView-876"><a href="#ReportView-876"><span class="linenos"> 876</span></a>            <span class="s2">&quot;descanso&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">rest</span><span class="p">,</span>
</span><span id="ReportView-877"><a href="#ReportView-877"><span class="linenos"> 877</span></a>            <span class="s2">&quot;diasDescanso&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">rest_days</span><span class="p">,</span>
</span><span id="ReportView-878"><a href="#ReportView-878"><span class="linenos"> 878</span></a>            <span class="s2">&quot;mes&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
</span><span id="ReportView-879"><a href="#ReportView-879"><span class="linenos"> 879</span></a>            <span class="s2">&quot;aforo&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">yield_estimate</span>
</span><span id="ReportView-880"><a href="#ReportView-880"><span class="linenos"> 880</span></a>        <span class="p">}</span>
</span><span id="ReportView-881"><a href="#ReportView-881"><span class="linenos"> 881</span></a>
</span><span id="ReportView-882"><a href="#ReportView-882"><span class="linenos"> 882</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_foliar_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">leaf_analysis</span><span class="p">):</span>
</span><span id="ReportView-883"><a href="#ReportView-883"><span class="linenos"> 883</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtiene y formatea datos foliares&quot;&quot;&quot;</span>
</span><span id="ReportView-884"><a href="#ReportView-884"><span class="linenos"> 884</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">leaf_analysis</span><span class="p">:</span>
</span><span id="ReportView-885"><a href="#ReportView-885"><span class="linenos"> 885</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="ReportView-886"><a href="#ReportView-886"><span class="linenos"> 886</span></a>
</span><span id="ReportView-887"><a href="#ReportView-887"><span class="linenos"> 887</span></a>        <span class="n">foliar_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">leaf_analysis</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
</span><span id="ReportView-888"><a href="#ReportView-888"><span class="linenos"> 888</span></a>        <span class="n">nutrients</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">leaf_analysis_nutrients</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
</span><span id="ReportView-889"><a href="#ReportView-889"><span class="linenos"> 889</span></a>            <span class="n">leaf_analysis_id</span><span class="o">=</span><span class="n">leaf_analysis</span><span class="o">.</span><span class="n">id</span>
</span><span id="ReportView-890"><a href="#ReportView-890"><span class="linenos"> 890</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="ReportView-891"><a href="#ReportView-891"><span class="linenos"> 891</span></a>
</span><span id="ReportView-892"><a href="#ReportView-892"><span class="linenos"> 892</span></a>        <span class="k">for</span> <span class="n">nv</span> <span class="ow">in</span> <span class="n">nutrients</span><span class="p">:</span>
</span><span id="ReportView-893"><a href="#ReportView-893"><span class="linenos"> 893</span></a>            <span class="n">nutrient</span> <span class="o">=</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nv</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span>
</span><span id="ReportView-894"><a href="#ReportView-894"><span class="linenos"> 894</span></a>            <span class="k">if</span> <span class="n">nutrient</span><span class="p">:</span>
</span><span id="ReportView-895"><a href="#ReportView-895"><span class="linenos"> 895</span></a>                <span class="n">key</span> <span class="o">=</span> <span class="n">nutrient</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ReportView-896"><a href="#ReportView-896"><span class="linenos"> 896</span></a>                <span class="n">foliar_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv</span><span class="o">.</span><span class="n">value</span>
</span><span id="ReportView-897"><a href="#ReportView-897"><span class="linenos"> 897</span></a>
</span><span id="ReportView-898"><a href="#ReportView-898"><span class="linenos"> 898</span></a>        <span class="k">return</span> <span class="n">foliar_data</span>
</span><span id="ReportView-899"><a href="#ReportView-899"><span class="linenos"> 899</span></a>
</span><span id="ReportView-900"><a href="#ReportView-900"><span class="linenos"> 900</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_soil_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soil_analysis</span><span class="p">):</span>
</span><span id="ReportView-901"><a href="#ReportView-901"><span class="linenos"> 901</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtiene y formatea datos de suelo&quot;&quot;&quot;</span>
</span><span id="ReportView-902"><a href="#ReportView-902"><span class="linenos"> 902</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">soil_analysis</span><span class="p">:</span>
</span><span id="ReportView-903"><a href="#ReportView-903"><span class="linenos"> 903</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="ReportView-904"><a href="#ReportView-904"><span class="linenos"> 904</span></a>
</span><span id="ReportView-905"><a href="#ReportView-905"><span class="linenos"> 905</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="ReportView-906"><a href="#ReportView-906"><span class="linenos"> 906</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">soil_analysis</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="ReportView-907"><a href="#ReportView-907"><span class="linenos"> 907</span></a>            <span class="s2">&quot;energia&quot;</span><span class="p">:</span> <span class="n">soil_analysis</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span>
</span><span id="ReportView-908"><a href="#ReportView-908"><span class="linenos"> 908</span></a>            <span class="s2">&quot;pastoreo&quot;</span><span class="p">:</span> <span class="n">soil_analysis</span><span class="o">.</span><span class="n">grazing</span>
</span><span id="ReportView-909"><a href="#ReportView-909"><span class="linenos"> 909</span></a>        <span class="p">}</span>
</span><span id="ReportView-910"><a href="#ReportView-910"><span class="linenos"> 910</span></a>
</span><span id="ReportView-911"><a href="#ReportView-911"><span class="linenos"> 911</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_lot_crop_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">common_analysis</span><span class="p">):</span>
</span><span id="ReportView-912"><a href="#ReportView-912"><span class="linenos"> 912</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtiene el cultivo activo del lote en la fecha del análisis&quot;&quot;&quot;</span>
</span><span id="ReportView-913"><a href="#ReportView-913"><span class="linenos"> 913</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">common_analysis</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">common_analysis</span><span class="o">.</span><span class="n">lot_id</span><span class="p">:</span>
</span><span id="ReportView-914"><a href="#ReportView-914"><span class="linenos"> 914</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="ReportView-915"><a href="#ReportView-915"><span class="linenos"> 915</span></a>
</span><span id="ReportView-916"><a href="#ReportView-916"><span class="linenos"> 916</span></a>        <span class="c1"># Buscar el cultivo activo en el rango de fechas</span>
</span><span id="ReportView-917"><a href="#ReportView-917"><span class="linenos"> 917</span></a>        <span class="n">lot_crop</span> <span class="o">=</span> <span class="n">LotCrop</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
</span><span id="ReportView-918"><a href="#ReportView-918"><span class="linenos"> 918</span></a>            <span class="n">LotCrop</span><span class="o">.</span><span class="n">lot_id</span> <span class="o">==</span> <span class="n">common_analysis</span><span class="o">.</span><span class="n">lot_id</span><span class="p">,</span>
</span><span id="ReportView-919"><a href="#ReportView-919"><span class="linenos"> 919</span></a>            <span class="n">LotCrop</span><span class="o">.</span><span class="n">start_date</span> <span class="o">&lt;=</span> <span class="n">common_analysis</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
</span><span id="ReportView-920"><a href="#ReportView-920"><span class="linenos"> 920</span></a>            <span class="n">db</span><span class="o">.</span><span class="n">or_</span><span class="p">(</span>
</span><span id="ReportView-921"><a href="#ReportView-921"><span class="linenos"> 921</span></a>                <span class="n">LotCrop</span><span class="o">.</span><span class="n">end_date</span> <span class="o">&gt;=</span> <span class="n">common_analysis</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
</span><span id="ReportView-922"><a href="#ReportView-922"><span class="linenos"> 922</span></a>                <span class="n">LotCrop</span><span class="o">.</span><span class="n">end_date</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="ReportView-923"><a href="#ReportView-923"><span class="linenos"> 923</span></a>            <span class="p">)</span>
</span><span id="ReportView-924"><a href="#ReportView-924"><span class="linenos"> 924</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">joinedload</span><span class="p">(</span><span class="n">LotCrop</span><span class="o">.</span><span class="n">crop</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="ReportView-925"><a href="#ReportView-925"><span class="linenos"> 925</span></a>
</span><span id="ReportView-926"><a href="#ReportView-926"><span class="linenos"> 926</span></a>        <span class="k">return</span> <span class="n">lot_crop</span>
</span><span id="ReportView-927"><a href="#ReportView-927"><span class="linenos"> 927</span></a>
</span><span id="ReportView-928"><a href="#ReportView-928"><span class="linenos"> 928</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_optimal_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">common_analysis</span><span class="p">):</span>
</span><span id="ReportView-929"><a href="#ReportView-929"><span class="linenos"> 929</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtiene niveles óptimos del cultivo actual&quot;&quot;&quot;</span>
</span><span id="ReportView-930"><a href="#ReportView-930"><span class="linenos"> 930</span></a>        <span class="n">lot_crop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lot_crop_data</span><span class="p">(</span><span class="n">common_analysis</span><span class="p">)</span>
</span><span id="ReportView-931"><a href="#ReportView-931"><span class="linenos"> 931</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">lot_crop</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">lot_crop</span><span class="o">.</span><span class="n">crop</span><span class="p">:</span>
</span><span id="ReportView-932"><a href="#ReportView-932"><span class="linenos"> 932</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="ReportView-933"><a href="#ReportView-933"><span class="linenos"> 933</span></a>
</span><span id="ReportView-934"><a href="#ReportView-934"><span class="linenos"> 934</span></a>        <span class="n">objective</span> <span class="o">=</span> <span class="n">Objective</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">crop_id</span><span class="o">=</span><span class="n">lot_crop</span><span class="o">.</span><span class="n">crop</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span id="ReportView-935"><a href="#ReportView-935"><span class="linenos"> 935</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">objective</span><span class="p">:</span>
</span><span id="ReportView-936"><a href="#ReportView-936"><span class="linenos"> 936</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="ReportView-937"><a href="#ReportView-937"><span class="linenos"> 937</span></a>
</span><span id="ReportView-938"><a href="#ReportView-938"><span class="linenos"> 938</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="ReportView-939"><a href="#ReportView-939"><span class="linenos"> 939</span></a>            <span class="s2">&quot;info&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="ReportView-940"><a href="#ReportView-940"><span class="linenos"> 940</span></a>                <span class="s2">&quot;cultivo&quot;</span><span class="p">:</span> <span class="n">lot_crop</span><span class="o">.</span><span class="n">crop</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="ReportView-941"><a href="#ReportView-941"><span class="linenos"> 941</span></a>                <span class="s2">&quot;valor_obj&quot;</span><span class="p">:</span> <span class="n">objective</span><span class="o">.</span><span class="n">target_value</span><span class="p">,</span>
</span><span id="ReportView-942"><a href="#ReportView-942"><span class="linenos"> 942</span></a>                <span class="s2">&quot;proteina&quot;</span><span class="p">:</span> <span class="n">objective</span><span class="o">.</span><span class="n">protein</span><span class="p">,</span>
</span><span id="ReportView-943"><a href="#ReportView-943"><span class="linenos"> 943</span></a>                <span class="s2">&quot;descanso&quot;</span><span class="p">:</span> <span class="n">objective</span><span class="o">.</span><span class="n">rest</span>
</span><span id="ReportView-944"><a href="#ReportView-944"><span class="linenos"> 944</span></a>            <span class="p">},</span>
</span><span id="ReportView-945"><a href="#ReportView-945"><span class="linenos"> 945</span></a>            <span class="s2">&quot;nutrientes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nutrient_targets</span><span class="p">(</span><span class="n">objective</span><span class="p">)</span>
</span><span id="ReportView-946"><a href="#ReportView-946"><span class="linenos"> 946</span></a>        <span class="p">}</span>
</span><span id="ReportView-947"><a href="#ReportView-947"><span class="linenos"> 947</span></a>
</span><span id="ReportView-948"><a href="#ReportView-948"><span class="linenos"> 948</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_nutrient_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objective</span><span class="p">):</span>
</span><span id="ReportView-949"><a href="#ReportView-949"><span class="linenos"> 949</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtiene y formatea los objetivos de nutrientes desde objective_nutrients&quot;&quot;&quot;</span>
</span><span id="ReportView-950"><a href="#ReportView-950"><span class="linenos"> 950</span></a>        <span class="n">targets</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ReportView-951"><a href="#ReportView-951"><span class="linenos"> 951</span></a>        <span class="n">obj_nutrients</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">objective_nutrients</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
</span><span id="ReportView-952"><a href="#ReportView-952"><span class="linenos"> 952</span></a>            <span class="n">objective_id</span><span class="o">=</span><span class="n">objective</span><span class="o">.</span><span class="n">id</span>
</span><span id="ReportView-953"><a href="#ReportView-953"><span class="linenos"> 953</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="ReportView-954"><a href="#ReportView-954"><span class="linenos"> 954</span></a>
</span><span id="ReportView-955"><a href="#ReportView-955"><span class="linenos"> 955</span></a>        <span class="k">for</span> <span class="n">on</span> <span class="ow">in</span> <span class="n">obj_nutrients</span><span class="p">:</span>
</span><span id="ReportView-956"><a href="#ReportView-956"><span class="linenos"> 956</span></a>            <span class="n">nutrient</span> <span class="o">=</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">on</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span>
</span><span id="ReportView-957"><a href="#ReportView-957"><span class="linenos"> 957</span></a>            <span class="k">if</span> <span class="n">nutrient</span><span class="p">:</span>
</span><span id="ReportView-958"><a href="#ReportView-958"><span class="linenos"> 958</span></a>                <span class="n">key</span> <span class="o">=</span> <span class="n">nutrient</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="ReportView-959"><a href="#ReportView-959"><span class="linenos"> 959</span></a>                <span class="n">targets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">on</span><span class="o">.</span><span class="n">target_value</span>  <span class="c1"># Usamos el target_value de objective_nutrients directamente</span>
</span><span id="ReportView-960"><a href="#ReportView-960"><span class="linenos"> 960</span></a>
</span><span id="ReportView-961"><a href="#ReportView-961"><span class="linenos"> 961</span></a>        <span class="k">return</span> <span class="n">targets</span>
</span><span id="ReportView-962"><a href="#ReportView-962"><span class="linenos"> 962</span></a>
</span><span id="ReportView-963"><a href="#ReportView-963"><span class="linenos"> 963</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_historical_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lot_id</span><span class="p">,</span> <span class="n">current_date</span><span class="p">):</span>
</span><span id="ReportView-964"><a href="#ReportView-964"><span class="linenos"> 964</span></a><span class="w">         </span><span class="sd">&quot;&quot;&quot;Obtiene datos históricos de análisis foliares para el lote (simplificado).&quot;&quot;&quot;</span>
</span><span id="ReportView-965"><a href="#ReportView-965"><span class="linenos"> 965</span></a>         <span class="c1"># Consulta los últimos N análisis para el lote antes de la fecha actual</span>
</span><span id="ReportView-966"><a href="#ReportView-966"><span class="linenos"> 966</span></a>         <span class="n">historical_analyses</span> <span class="o">=</span> <span class="n">LeafAnalysis</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CommonAnalysis</span><span class="p">)</span>\
</span><span id="ReportView-967"><a href="#ReportView-967"><span class="linenos"> 967</span></a>             <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">CommonAnalysis</span><span class="o">.</span><span class="n">lot_id</span> <span class="o">==</span> <span class="n">lot_id</span><span class="p">,</span> <span class="n">CommonAnalysis</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">current_date</span><span class="p">)</span>\
</span><span id="ReportView-968"><a href="#ReportView-968"><span class="linenos"> 968</span></a>             <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">CommonAnalysis</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>\
</span><span id="ReportView-969"><a href="#ReportView-969"><span class="linenos"> 969</span></a>             <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="c1"># Limita a 5 análisis históricos, por ejemplo</span>
</span><span id="ReportView-970"><a href="#ReportView-970"><span class="linenos"> 970</span></a>
</span><span id="ReportView-971"><a href="#ReportView-971"><span class="linenos"> 971</span></a>         <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ReportView-972"><a href="#ReportView-972"><span class="linenos"> 972</span></a>         <span class="k">for</span> <span class="n">analysis</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">historical_analyses</span><span class="p">):</span> <span class="c1"># Invertir para orden cronológico</span>
</span><span id="ReportView-973"><a href="#ReportView-973"><span class="linenos"> 973</span></a>             <span class="n">nutrients</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">leaf_analysis_nutrients</span><span class="p">)</span>\
</span><span id="ReportView-974"><a href="#ReportView-974"><span class="linenos"> 974</span></a>                 <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">leaf_analysis_id</span><span class="o">=</span><span class="n">analysis</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="ReportView-975"><a href="#ReportView-975"><span class="linenos"> 975</span></a>             <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fecha&quot;</span><span class="p">:</span> <span class="n">analysis</span><span class="o">.</span><span class="n">common_analysis</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b %Y&#39;</span><span class="p">)}</span> <span class="c1"># Formato Mes Año</span>
</span><span id="ReportView-976"><a href="#ReportView-976"><span class="linenos"> 976</span></a>             <span class="k">for</span> <span class="n">nv</span> <span class="ow">in</span> <span class="n">nutrients</span><span class="p">:</span>
</span><span id="ReportView-977"><a href="#ReportView-977"><span class="linenos"> 977</span></a>                 <span class="n">nutrient</span> <span class="o">=</span> <span class="n">Nutrient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nv</span><span class="o">.</span><span class="n">nutrient_id</span><span class="p">)</span>
</span><span id="ReportView-978"><a href="#ReportView-978"><span class="linenos"> 978</span></a>                 <span class="k">if</span> <span class="n">nutrient</span> <span class="ow">and</span> <span class="n">nutrient</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nitrogeno&#39;</span><span class="p">,</span> <span class="s1">&#39;fosforo&#39;</span><span class="p">,</span> <span class="s1">&#39;potasio&#39;</span><span class="p">]:</span> <span class="c1"># Solo algunos para el ejemplo</span>
</span><span id="ReportView-979"><a href="#ReportView-979"><span class="linenos"> 979</span></a>                      <span class="n">entry</span><span class="p">[</span><span class="n">nutrient</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">nv</span><span class="o">.</span><span class="n">value</span>
</span><span id="ReportView-980"><a href="#ReportView-980"><span class="linenos"> 980</span></a>             <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
</span><span id="ReportView-981"><a href="#ReportView-981"><span class="linenos"> 981</span></a>         <span class="k">return</span> <span class="n">data</span>
</span><span id="ReportView-982"><a href="#ReportView-982"><span class="linenos"> 982</span></a>
</span><span id="ReportView-983"><a href="#ReportView-983"><span class="linenos"> 983</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_limiting_nutrient_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limiting_name</span><span class="p">,</span> <span class="n">analysisData</span><span class="p">,</span> <span class="n">optimalLevels</span><span class="p">):</span>
</span><span id="ReportView-984"><a href="#ReportView-984"><span class="linenos"> 984</span></a><span class="w">         </span><span class="sd">&quot;&quot;&quot;Intenta reconstruir los datos del nutriente limitante.&quot;&quot;&quot;</span>
</span><span id="ReportView-985"><a href="#ReportView-985"><span class="linenos"> 985</span></a>         <span class="k">if</span> <span class="ow">not</span> <span class="n">limiting_name</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">analysisData</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">optimalLevels</span><span class="p">:</span>
</span><span id="ReportView-986"><a href="#ReportView-986"><span class="linenos"> 986</span></a>             <span class="k">return</span> <span class="kc">None</span>
</span><span id="ReportView-987"><a href="#ReportView-987"><span class="linenos"> 987</span></a>
</span><span id="ReportView-988"><a href="#ReportView-988"><span class="linenos"> 988</span></a>         <span class="c1"># Buscar en foliar</span>
</span><span id="ReportView-989"><a href="#ReportView-989"><span class="linenos"> 989</span></a>         <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">analysisData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;foliar&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="ReportView-990"><a href="#ReportView-990"><span class="linenos"> 990</span></a>             <span class="k">if</span> <span class="n">nutrient_names_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">limiting_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="ReportView-991"><a href="#ReportView-991"><span class="linenos"> 991</span></a>                 <span class="n">levels</span> <span class="o">=</span> <span class="n">optimalLevels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nutrientes&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="ReportView-992"><a href="#ReportView-992"><span class="linenos"> 992</span></a>                 <span class="k">if</span> <span class="n">levels</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;min&#39;</span> <span class="ow">in</span> <span class="n">levels</span> <span class="ow">and</span> <span class="s1">&#39;max&#39;</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">:</span>
</span><span id="ReportView-993"><a href="#ReportView-993"><span class="linenos"> 993</span></a>                      <span class="n">optimalMid</span> <span class="o">=</span> <span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">levels</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="ReportView-994"><a href="#ReportView-994"><span class="linenos"> 994</span></a>                      <span class="n">percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="n">optimalMid</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">optimalMid</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="ReportView-995"><a href="#ReportView-995"><span class="linenos"> 995</span></a>                      <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s2">&quot;percentage&quot;</span><span class="p">:</span> <span class="n">percentage</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;foliar&quot;</span><span class="p">}</span>
</span><span id="ReportView-996"><a href="#ReportView-996"><span class="linenos"> 996</span></a>
</span><span id="ReportView-997"><a href="#ReportView-997"><span class="linenos"> 997</span></a>         <span class="c1"># Buscar en suelo (excluyendo pH)</span>
</span><span id="ReportView-998"><a href="#ReportView-998"><span class="linenos"> 998</span></a>         <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">analysisData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;soil&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="ReportView-999"><a href="#ReportView-999"><span class="linenos"> 999</span></a>              <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;ph&#39;</span> <span class="ow">and</span> <span class="n">nutrient_names_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">limiting_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="ReportView-1000"><a href="#ReportView-1000"><span class="linenos">1000</span></a>                   <span class="n">levels</span> <span class="o">=</span> <span class="n">optimalLevels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nutrientes&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="ReportView-1001"><a href="#ReportView-1001"><span class="linenos">1001</span></a>                   <span class="k">if</span> <span class="n">levels</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;min&#39;</span> <span class="ow">in</span> <span class="n">levels</span> <span class="ow">and</span> <span class="s1">&#39;max&#39;</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">:</span>
</span><span id="ReportView-1002"><a href="#ReportView-1002"><span class="linenos">1002</span></a>                        <span class="n">optimalMid</span> <span class="o">=</span> <span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">levels</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="ReportView-1003"><a href="#ReportView-1003"><span class="linenos">1003</span></a>                        <span class="n">percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="n">optimalMid</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">optimalMid</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="ReportView-1004"><a href="#ReportView-1004"><span class="linenos">1004</span></a>                        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s2">&quot;percentage&quot;</span><span class="p">:</span> <span class="n">percentage</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;soil&quot;</span><span class="p">}</span>
</span><span id="ReportView-1005"><a href="#ReportView-1005"><span class="linenos">1005</span></a>
</span><span id="ReportView-1006"><a href="#ReportView-1006"><span class="linenos">1006</span></a>         <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">limiting_name</span><span class="p">,</span> <span class="s2">&quot;percentage&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">}</span> <span class="c1"># Si no se encuentran los detalles</span>
</span><span id="ReportView-1007"><a href="#ReportView-1007"><span class="linenos">1007</span></a>
</span><span id="ReportView-1008"><a href="#ReportView-1008"><span class="linenos">1008</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_nutrient_name_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ReportView-1009"><a href="#ReportView-1009"><span class="linenos">1009</span></a><span class="w">         </span><span class="sd">&quot;&quot;&quot;Genera un mapa de claves internas a nombres legibles.&quot;&quot;&quot;</span>
</span><span id="ReportView-1010"><a href="#ReportView-1010"><span class="linenos">1010</span></a>         <span class="c1"># Este mapa debe ser consistente con cómo se generan las claves en analysisData</span>
</span><span id="ReportView-1011"><a href="#ReportView-1011"><span class="linenos">1011</span></a>         <span class="k">return</span> <span class="p">{</span>
</span><span id="ReportView-1012"><a href="#ReportView-1012"><span class="linenos">1012</span></a>             <span class="s2">&quot;nitrogeno&quot;</span><span class="p">:</span> <span class="s2">&quot;Nitrógeno&quot;</span><span class="p">,</span> <span class="s2">&quot;fosforo&quot;</span><span class="p">:</span> <span class="s2">&quot;Fósforo&quot;</span><span class="p">,</span> <span class="s2">&quot;potasio&quot;</span><span class="p">:</span> <span class="s2">&quot;Potasio&quot;</span><span class="p">,</span>
</span><span id="ReportView-1013"><a href="#ReportView-1013"><span class="linenos">1013</span></a>             <span class="s2">&quot;calcio&quot;</span><span class="p">:</span> <span class="s2">&quot;Calcio&quot;</span><span class="p">,</span> <span class="s2">&quot;magnesio&quot;</span><span class="p">:</span> <span class="s2">&quot;Magnesio&quot;</span><span class="p">,</span> <span class="s2">&quot;azufre&quot;</span><span class="p">:</span> <span class="s2">&quot;Azufre&quot;</span><span class="p">,</span>
</span><span id="ReportView-1014"><a href="#ReportView-1014"><span class="linenos">1014</span></a>             <span class="s2">&quot;hierro&quot;</span><span class="p">:</span> <span class="s2">&quot;Hierro&quot;</span><span class="p">,</span> <span class="s2">&quot;manganeso&quot;</span><span class="p">:</span> <span class="s2">&quot;Manganeso&quot;</span><span class="p">,</span> <span class="s2">&quot;zinc&quot;</span><span class="p">:</span> <span class="s2">&quot;Zinc&quot;</span><span class="p">,</span>
</span><span id="ReportView-1015"><a href="#ReportView-1015"><span class="linenos">1015</span></a>             <span class="s2">&quot;cobre&quot;</span><span class="p">:</span> <span class="s2">&quot;Cobre&quot;</span><span class="p">,</span> <span class="s2">&quot;boro&quot;</span><span class="p">:</span> <span class="s2">&quot;Boro&quot;</span><span class="p">,</span> <span class="s2">&quot;ph&quot;</span><span class="p">:</span> <span class="s2">&quot;pH&quot;</span><span class="p">,</span>
</span><span id="ReportView-1016"><a href="#ReportView-1016"><span class="linenos">1016</span></a>             <span class="s2">&quot;materiaOrganica&quot;</span><span class="p">:</span> <span class="s2">&quot;Materia Orgánica&quot;</span><span class="p">,</span> <span class="s2">&quot;cic&quot;</span><span class="p">:</span> <span class="s2">&quot;CIC&quot;</span><span class="p">,</span>
</span><span id="ReportView-1017"><a href="#ReportView-1017"><span class="linenos">1017</span></a>             <span class="c1"># Añade mapeos para todas las claves que uses</span>
</span><span id="ReportView-1018"><a href="#ReportView-1018"><span class="linenos">1018</span></a>         <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Clase para generar reportes integrados de análisis</p>
</div>


                            <div id="ReportView.decorators" class="classattr">
                                <div class="attr variable">
            <span class="name">decorators</span>        =
<span class="default_value">[&lt;function jwt_required.&lt;locals&gt;.wrapper&gt;]</span>

        
    </div>
    <a class="headerlink" href="#ReportView.decorators"></a>
    
    

                            </div>
                            <div id="ReportView.get" class="classattr">
                                        <input id="ReportView.get-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="nb">id</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReportView.get-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReportView.get"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReportView.get-760"><a href="#ReportView.get-760"><span class="linenos">760</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
</span><span id="ReportView.get-761"><a href="#ReportView.get-761"><span class="linenos">761</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ReportView.get-762"><a href="#ReportView.get-762"><span class="linenos">762</span></a><span class="sd">        Genera reporte completo de análisis con niveles óptimos</span>
</span><span id="ReportView.get-763"><a href="#ReportView.get-763"><span class="linenos">763</span></a><span class="sd">        Args:</span>
</span><span id="ReportView.get-764"><a href="#ReportView.get-764"><span class="linenos">764</span></a><span class="sd">            common_analysis_id (int): ID del análisis común a reportar</span>
</span><span id="ReportView.get-765"><a href="#ReportView.get-765"><span class="linenos">765</span></a><span class="sd">            (NOTA: La ruta lo llama &#39;id&#39;, pero la lógica parece asumir que es un Recommendation ID)</span>
</span><span id="ReportView.get-766"><a href="#ReportView.get-766"><span class="linenos">766</span></a><span class="sd">        Returns:</span>
</span><span id="ReportView.get-767"><a href="#ReportView.get-767"><span class="linenos">767</span></a><span class="sd">            JSON: Estructura con datos de análisis y niveles óptimos</span>
</span><span id="ReportView.get-768"><a href="#ReportView.get-768"><span class="linenos">768</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReportView.get-769"><a href="#ReportView.get-769"><span class="linenos">769</span></a>        <span class="n">recommendation_id</span> <span class="o">=</span> <span class="nb">id</span> <span class="c1"># Asumiendo que el ID es de Recommendation</span>
</span><span id="ReportView.get-770"><a href="#ReportView.get-770"><span class="linenos">770</span></a>        <span class="n">report</span> <span class="o">=</span> <span class="n">Recommendation</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="n">recommendation_id</span><span class="p">)</span>
</span><span id="ReportView.get-771"><a href="#ReportView.get-771"><span class="linenos">771</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_check_access</span><span class="p">(</span><span class="n">report</span><span class="p">)</span> <span class="c1"># Pasar el objeto &#39;report&#39; para verificar acceso</span>
</span><span id="ReportView.get-772"><a href="#ReportView.get-772"><span class="linenos">772</span></a>
</span><span id="ReportView.get-773"><a href="#ReportView.get-773"><span class="linenos">773</span></a>        <span class="c1"># --- Deserializar datos del reporte ---</span>
</span><span id="ReportView.get-774"><a href="#ReportView.get-774"><span class="linenos">774</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ReportView.get-775"><a href="#ReportView.get-775"><span class="linenos">775</span></a>            <span class="c1"># Usar .get(&#39;{}&#39;) para evitar errores si el campo es None</span>
</span><span id="ReportView.get-776"><a href="#ReportView.get-776"><span class="linenos">776</span></a>            <span class="n">foliar_details_str</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">foliar_analysis_details</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span>
</span><span id="ReportView.get-777"><a href="#ReportView.get-777"><span class="linenos">777</span></a>            <span class="n">soil_details_str</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">soil_analysis_details</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span>
</span><span id="ReportView.get-778"><a href="#ReportView.get-778"><span class="linenos">778</span></a>            <span class="n">optimal_levels_str</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">optimal_comparison</span> <span class="ow">or</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span>
</span><span id="ReportView.get-779"><a href="#ReportView.get-779"><span class="linenos">779</span></a>            <span class="n">recommendations_str</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">automatic_recommendations</span> <span class="ow">or</span> <span class="s1">&#39;[]&#39;</span> <span class="c1"># Asumir lista JSON</span>
</span><span id="ReportView.get-780"><a href="#ReportView.get-780"><span class="linenos">780</span></a>
</span><span id="ReportView.get-781"><a href="#ReportView.get-781"><span class="linenos">781</span></a>            <span class="n">foliar_details</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">foliar_details_str</span><span class="p">)</span>
</span><span id="ReportView.get-782"><a href="#ReportView.get-782"><span class="linenos">782</span></a>            <span class="n">soil_details</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">soil_details_str</span><span class="p">)</span>
</span><span id="ReportView.get-783"><a href="#ReportView.get-783"><span class="linenos">783</span></a>            <span class="n">optimal_levels</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">optimal_levels_str</span><span class="p">)</span>
</span><span id="ReportView.get-784"><a href="#ReportView.get-784"><span class="linenos">784</span></a>            <span class="n">recommendations_list</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">recommendations_str</span><span class="p">)</span>
</span><span id="ReportView.get-785"><a href="#ReportView.get-785"><span class="linenos">785</span></a>
</span><span id="ReportView.get-786"><a href="#ReportView.get-786"><span class="linenos">786</span></a>            <span class="c1"># Reconstruir analysisData (Necesita el CommonAnalysis)</span>
</span><span id="ReportView.get-787"><a href="#ReportView.get-787"><span class="linenos">787</span></a>            <span class="c1"># Tratar de obtener el common_analysis_id de los detalles deserializados</span>
</span><span id="ReportView.get-788"><a href="#ReportView.get-788"><span class="linenos">788</span></a>            <span class="n">common_analysis_id_foliar</span> <span class="o">=</span> <span class="n">foliar_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;common_analysis_id&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">foliar_details</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="ReportView.get-789"><a href="#ReportView.get-789"><span class="linenos">789</span></a>            <span class="n">common_analysis_id_soil</span> <span class="o">=</span> <span class="n">soil_details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;common_analysis_id&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">soil_details</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="ReportView.get-790"><a href="#ReportView.get-790"><span class="linenos">790</span></a>            <span class="c1"># O obtenerlo desde el lote/fecha del reporte si no está en los detalles</span>
</span><span id="ReportView.get-791"><a href="#ReportView.get-791"><span class="linenos">791</span></a>            <span class="n">common_analysis</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ReportView.get-792"><a href="#ReportView.get-792"><span class="linenos">792</span></a>            <span class="k">if</span> <span class="n">common_analysis_id_foliar</span><span class="p">:</span>
</span><span id="ReportView.get-793"><a href="#ReportView.get-793"><span class="linenos">793</span></a>                 <span class="n">common_analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_common_analysis</span><span class="p">(</span><span class="n">common_analysis_id_foliar</span><span class="p">)</span>
</span><span id="ReportView.get-794"><a href="#ReportView.get-794"><span class="linenos">794</span></a>            <span class="k">elif</span> <span class="n">common_analysis_id_soil</span><span class="p">:</span>
</span><span id="ReportView.get-795"><a href="#ReportView.get-795"><span class="linenos">795</span></a>                 <span class="n">common_analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_common_analysis</span><span class="p">(</span><span class="n">common_analysis_id_soil</span><span class="p">)</span>
</span><span id="ReportView.get-796"><a href="#ReportView.get-796"><span class="linenos">796</span></a>            <span class="c1"># Fallback: buscar por lote y fecha si es necesario (puede ser impreciso)</span>
</span><span id="ReportView.get-797"><a href="#ReportView.get-797"><span class="linenos">797</span></a>            <span class="c1"># if not common_analysis and report.lot_id and report.date:</span>
</span><span id="ReportView.get-798"><a href="#ReportView.get-798"><span class="linenos">798</span></a>            <span class="c1">#      common_analysis = CommonAnalysis.query.filter_by(lot_id=report.lot_id, date=report.date).first()</span>
</span><span id="ReportView.get-799"><a href="#ReportView.get-799"><span class="linenos">799</span></a>
</span><span id="ReportView.get-800"><a href="#ReportView.get-800"><span class="linenos">800</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">common_analysis</span><span class="p">:</span>
</span><span id="ReportView.get-801"><a href="#ReportView.get-801"><span class="linenos">801</span></a>                 <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No se pudo determinar el CommonAnalysis asociado al reporte.&quot;</span><span class="p">)</span>
</span><span id="ReportView.get-802"><a href="#ReportView.get-802"><span class="linenos">802</span></a>
</span><span id="ReportView.get-803"><a href="#ReportView.get-803"><span class="linenos">803</span></a>            <span class="n">analysisData</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ReportView.get-804"><a href="#ReportView.get-804"><span class="linenos">804</span></a>                <span class="s2">&quot;common&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_common</span><span class="p">(</span><span class="n">common_analysis</span><span class="p">),</span>
</span><span id="ReportView.get-805"><a href="#ReportView.get-805"><span class="linenos">805</span></a>                <span class="s2">&quot;foliar&quot;</span><span class="p">:</span> <span class="n">foliar_details</span><span class="p">,</span>
</span><span id="ReportView.get-806"><a href="#ReportView.get-806"><span class="linenos">806</span></a>                <span class="s2">&quot;soil&quot;</span><span class="p">:</span> <span class="n">soil_details</span>
</span><span id="ReportView.get-807"><a href="#ReportView.get-807"><span class="linenos">807</span></a>            <span class="p">}</span>
</span><span id="ReportView.get-808"><a href="#ReportView.get-808"><span class="linenos">808</span></a>
</span><span id="ReportView.get-809"><a href="#ReportView.get-809"><span class="linenos">809</span></a>            <span class="c1"># Datos históricos (esto podría necesitar una consulta separada)</span>
</span><span id="ReportView.get-810"><a href="#ReportView.get-810"><span class="linenos">810</span></a>            <span class="n">historicalData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_historical_data</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">lot_id</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
</span><span id="ReportView.get-811"><a href="#ReportView.get-811"><span class="linenos">811</span></a>
</span><span id="ReportView.get-812"><a href="#ReportView.get-812"><span class="linenos">812</span></a>            <span class="c1"># Nutriente limitante</span>
</span><span id="ReportView.get-813"><a href="#ReportView.get-813"><span class="linenos">813</span></a>            <span class="n">limitingNutrientData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_limiting_nutrient_data</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">limiting_nutrient_id</span><span class="p">,</span> <span class="n">analysisData</span><span class="p">,</span> <span class="n">optimal_levels</span><span class="p">)</span>
</span><span id="ReportView.get-814"><a href="#ReportView.get-814"><span class="linenos">814</span></a>
</span><span id="ReportView.get-815"><a href="#ReportView.get-815"><span class="linenos">815</span></a>
</span><span id="ReportView.get-816"><a href="#ReportView.get-816"><span class="linenos">816</span></a>        <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ReportView.get-817"><a href="#ReportView.get-817"><span class="linenos">817</span></a>             <span class="n">current_app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deserializando datos del reporte </span><span class="si">{</span><span class="n">recommendation_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="ReportView.get-818"><a href="#ReportView.get-818"><span class="linenos">818</span></a>             <span class="c1"># Retornar un error o datos vacíos/predeterminados</span>
</span><span id="ReportView.get-819"><a href="#ReportView.get-819"><span class="linenos">819</span></a>             <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Error procesando datos del reporte&quot;</span><span class="p">}),</span> <span class="mi">500</span>
</span><span id="ReportView.get-820"><a href="#ReportView.get-820"><span class="linenos">820</span></a>
</span><span id="ReportView.get-821"><a href="#ReportView.get-821"><span class="linenos">821</span></a>        <span class="n">report_data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="ReportView.get-822"><a href="#ReportView.get-822"><span class="linenos">822</span></a>            <span class="s2">&quot;analysisData&quot;</span><span class="p">:</span> <span class="n">analysisData</span><span class="p">,</span>
</span><span id="ReportView.get-823"><a href="#ReportView.get-823"><span class="linenos">823</span></a>            <span class="s2">&quot;optimalLevels&quot;</span><span class="p">:</span> <span class="n">optimal_levels</span><span class="p">,</span>
</span><span id="ReportView.get-824"><a href="#ReportView.get-824"><span class="linenos">824</span></a>            <span class="s2">&quot;historicalData&quot;</span><span class="p">:</span> <span class="n">historicalData</span><span class="p">,</span>
</span><span id="ReportView.get-825"><a href="#ReportView.get-825"><span class="linenos">825</span></a>            <span class="s2">&quot;recommendations&quot;</span><span class="p">:</span> <span class="n">recommendations_list</span><span class="p">,</span>
</span><span id="ReportView.get-826"><a href="#ReportView.get-826"><span class="linenos">826</span></a>            <span class="s2">&quot;limitingNutrient&quot;</span><span class="p">:</span> <span class="n">limitingNutrientData</span><span class="p">,</span>
</span><span id="ReportView.get-827"><a href="#ReportView.get-827"><span class="linenos">827</span></a>            <span class="s2">&quot;nutrientNames&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nutrient_name_map</span><span class="p">()</span> <span class="c1"># Mapa de nombres para la plantilla</span>
</span><span id="ReportView.get-828"><a href="#ReportView.get-828"><span class="linenos">828</span></a>        <span class="p">}</span>
</span><span id="ReportView.get-829"><a href="#ReportView.get-829"><span class="linenos">829</span></a>
</span><span id="ReportView.get-830"><a href="#ReportView.get-830"><span class="linenos">830</span></a>        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">report_data</span><span class="p">),</span> <span class="mi">200</span>
</span></pre></div>


            <div class="docstring"><p>Genera reporte completo de análisis con niveles óptimos</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>common_analysis_id (int):</strong>  ID del análisis común a reportar</li>
<li><strong>(NOTA:</strong>  La ruta lo llama 'id', pero la lógica parece asumir que es un Recommendation ID)</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>JSON: Estructura con datos de análisis y niveles óptimos</p>
</blockquote>
</div>


                            </div>
                            <div id="ReportView.methods" class="classattr">
                                <div class="attr variable">
            <span class="name">methods</span><span class="annotation">: ClassVar[Optional[Collection[str]]]</span>        =
<span class="default_value">{&#39;GET&#39;}</span>

        
    </div>
    <a class="headerlink" href="#ReportView.methods"></a>
    
    

                            </div>
                </section>
                <section id="nutrient_names_map">
                    <div class="attr variable">
            <span class="name">nutrient_names_map</span>        =
<input id="nutrient_names_map-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="nutrient_names_map-view-value"></label><span class="default_value">{&#39;nitrogeno&#39;: &#39;Nitrógeno&#39;, &#39;fosforo&#39;: &#39;Fósforo&#39;, &#39;potasio&#39;: &#39;Potasio&#39;, &#39;calcio&#39;: &#39;Calcio&#39;, &#39;magnesio&#39;: &#39;Magnesio&#39;, &#39;azufre&#39;: &#39;Azufre&#39;, &#39;hierro&#39;: &#39;Hierro&#39;, &#39;manganeso&#39;: &#39;Manganeso&#39;, &#39;zinc&#39;: &#39;Zinc&#39;, &#39;cobre&#39;: &#39;Cobre&#39;, &#39;boro&#39;: &#39;Boro&#39;, &#39;ph&#39;: &#39;pH&#39;, &#39;materiaOrganica&#39;: &#39;Materia Orgánica&#39;, &#39;cic&#39;: &#39;CIC&#39;}</span>

        
    </div>
    <a class="headerlink" href="#nutrient_names_map"></a>
    
            <div class="docstring"><p>Reportes, incluirán los datos completos de un análisis completo común (CommonAnalysis) 
ahí se identificará el análisis de suelo (SoilAnalysis) y foliar (LeafAnalysis, debe incluir los nutrientes relacionados de la tabla leaf_analysis_nutrients ) relacionados con el ID del CommonAnalysis, esto deben presentarse así (Nota, los datos y listado de nutriente deben obtenerse de los registrados en el modelo Nutrient): </p>

<pre><code>analysisData = {
    "common": {
        "id": 3,
        "fechaAnalisis": "2025-03-26",
        "finca": "El nuevo rocío",
        "lote": "Lote 1",
        "proteinas": 6.0,
        "descanso": 5.0,
        "diasDescanso": 5,
        "mes": 5,
    },
    "foliar": {
        "id": 1,
        "nitrogeno": 2.5,
        "fosforo": 0.3,
        "potasio": 1.8,
        "calcio": 1.2,
        "magnesio": 0.4,
        "azufre": 0.2,
        "hierro": 85,
        "manganeso": 45,
        "zinc": 18,
        "cobre": 6,
        "boro": 25,
    },
    "soil": {
        "id": 1,
        "ph": 6.5,
        "materiaOrganica": 3.2,
        "nitrogeno": 0.15,
        "fosforo": 12,
        "potasio": 180,
        "calcio": 1200,
        "magnesio": 180,
        "azufre": 15,
        "textura": "Franco-arcillosa",
        "cic": 15.2,
    },
}
</code></pre>

<p>optimalLevels se obtendrá a partir del tipo de cultivo, este se comparará con los tipos de cultivo registrados en Crops y sus valores de nutrientes registrados en objective_nutrients (Nota, los datos y listado de nutriente deben obtenerse de los registrados en el modelo Nutrient)
    optimalLevels = {
        VALOR OBJETIVO  PROTEÍNA        DESCANSO
        "info": {
            "cultivo": "papa", 
            "valor_obj": "10",
            "proteina": "8",
            "descanso": "5",</p>

<pre><code>    }
    "nutrientes": {
        "nitrogeno": {"min": 2.8, "max": 3.5},
        "fosforo": {"min": 0.2, "max": 0.4},
        "potasio": {"min": 2.0, "max": 3.0},
        "calcio": {"min": 1.0, "max": 2.0},
        "magnesio": {"min": 0.3, "max": 0.6},
        "azufre": {"min": 0.2, "max": 0.4},
        "hierro": {"min": 50, "max": 150},
        "manganeso": {"min": 25, "max": 100},
        "zinc": {"min": 20, "max": 50},
        "cobre": {"min": 5, "max": 15},
        "boro": {"min": 20, "max": 50},
    },
}

foliarChartData = [
    {"name": "N", "actual": analysisData["foliar"]["nitrogeno"], "min": optimalLevels["foliar"]["nitrogeno"]["min"], "max": optimalLevels["foliar"]["nitrogeno"]["max"]},
    {"name": "P", "actual": analysisData["foliar"]["fosforo"], "min": optimalLevels["foliar"]["fosforo"]["min"], "max": optimalLevels["foliar"]["fosforo"]["max"]},
    {"name": "K", "actual": analysisData["foliar"]["potasio"], "min": optimalLevels["foliar"]["potasio"]["min"], "max": optimalLevels["foliar"]["potasio"]["max"]},
    {"name": "Ca", "actual": analysisData["foliar"]["calcio"], "min": optimalLevels["foliar"]["calcio"]["min"], "max": optimalLevels["foliar"]["calcio"]["max"]},
    {"name": "Mg", "actual": analysisData["foliar"]["magnesio"], "min": optimalLevels["foliar"]["magnesio"]["min"], "max": optimalLevels["foliar"]["magnesio"]["max"]},
    {"name": "S", "actual": analysisData["foliar"]["azufre"], "min": optimalLevels["foliar"]["azufre"]["min"], "max": optimalLevels["foliar"]["azufre"]["max"]},
]

soilChartData = [
    {"name": "pH", "actual": analysisData["soil"]["ph"], "min": optimalLevels["soil"]["ph"]["min"], "max": optimalLevels["soil"]["ph"]["max"], "unit": ""},
    {"name": "M.O.", "actual": analysisData["soil"]["materiaOrganica"], "min": optimalLevels["soil"]["materiaOrganica"]["min"], "max": optimalLevels["soil"]["materiaOrganica"]["max"], "unit": "%"},
    {"name": "N", "actual": analysisData["soil"]["nitrogeno"], "min": optimalLevels["soil"]["nitrogeno"]["min"], "max": optimalLevels["soil"]["nitrogeno"]["max"], "unit": "%"},
    {"name": "P", "actual": analysisData["soil"]["fosforo"], "min": optimalLevels["soil"]["fosforo"]["min"], "max": optimalLevels["soil"]["fosforo"]["max"], "unit": "ppm"},
    {"name": "K", "actual": analysisData["soil"]["potasio"], "min": optimalLevels["soil"]["potasio"]["min"], "max": optimalLevels["soil"]["potasio"]["max"], "unit": "ppm"},
    {"name": "CIC", "actual": analysisData["soil"]["cic"], "min": optimalLevels["soil"]["cic"]["min"], "max": optimalLevels["soil"]["cic"]["max"], "unit": "meq/100g"},
]

historicalData = [
    {"fecha": "Ene 2025", "nitrogeno": 2.3, "fosforo": 0.25, "potasio": 1.5},
    {"fecha": "Feb 2025", "nitrogeno": 2.4, "fosforo": 0.28, "potasio": 1.6},
    {"fecha": "Mar 2025", "nitrogeno": 2.5, "fosforo": 0.3, "potasio": 1.8},
]

nutrientNames = {
    "nitrogeno": "Nitrógeno",
    "fosforo": "Fósforo",
    "potasio": "Potasio",
    "calcio": "Calcio",
    "magnesio": "Magnesio",
    "azufre": "Azufre",
    "hierro": "Hierro",
    "manganeso": "Manganeso",
    "zinc": "Zinc",
    "cobre": "Cobre",
    "boro": "Boro",
    "ph": "pH",
    "materiaOrganica": "Materia Orgánica",
    "cic": "CIC",
}

def getNutrientStatus(actual, min, max):
    if actual &lt; min:
        return "deficiente"
    if actual &gt; max:
        return "excesivo"
    return "óptimo"

def getStatusColor(status):
    match status:
        case "deficiente":
            return "text-red-500"
        case "excesivo":
            return "text-yellow-500"
        case "óptimo":
            return "text-green-500"
        case _:
            return ""

def getStatusIcon(status):
    match status:
        case "deficiente":
            return '&lt;svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-red-500"&gt;&lt;polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"&gt;&lt;/polygon&gt;&lt;line x1="12" y1="8" x2="12" y2="12"&gt;&lt;/line&gt;&lt;line x1="12" y1="16" x2="12.01" y2="16"&gt;&lt;/line&gt;&lt;/svg&gt;'
        case "excesivo":
            return '&lt;svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-yellow-500"&gt;&lt;polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"&gt;&lt;/polygon&gt;&lt;line x1="12" y1="8" x2="12" y2="12"&gt;&lt;/line&gt;&lt;line x1="12" y1="16" x2="12.01" y2="16"&gt;&lt;/line&gt;&lt;/svg&gt;'
        case "óptimo":
            return '&lt;svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-green-500"&gt;&lt;path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"&gt;&lt;/path&gt;&lt;polyline points="12 2 2 7.86 12 12"&gt;&lt;/polyline&gt;&lt;line x1="12" y1="16" x2="12.01" y2="16"&gt;&lt;/line&gt;&lt;/svg&gt;'
        case _:
            return ""

def findLimitingNutrient():
    limitingNutrient = None
    lowestPercentage = 100

    for nutrient, value in analysisData["foliar"].items():
        if nutrient in optimalLevels["foliar"]:
            min_value = optimalLevels["foliar"][nutrient]["min"]
            max_value = optimalLevels["foliar"][nutrient]["max"]
            optimalMid = (min_value + max_value) / 2
            percentage = (value / optimalMid) * 100
            if percentage &lt; lowestPercentage and percentage &lt; 90:
                lowestPercentage = percentage
                limitingNutrient = {
                    "name": nutrient,
                    "value": value,
                    "optimal": optimalMid,
                    "percentage": percentage,
                    "type": "foliar",
                }

    for nutrient, value in analysisData["soil"].items():
        if nutrient in optimalLevels["soil"] and nutrient != "ph":
            min_value = optimalLevels["soil"][nutrient]["min"]
            max_value = optimalLevels["soil"][nutrient]["max"]
            optimalMid = (min_value + max_value) / 2
            percentage = (value / optimalMid) * 100
            if percentage &lt; lowestPercentage and percentage &lt; 90:
                lowestPercentage = percentage
                limitingNutrient = {
                    "name": nutrient,
                    "value": value,
                    "optimal": optimalMid,
                    "percentage": percentage,
                    "type": "soil",
                }

    return limitingNutrient

def generateRecommendations():
    recommendations = []

    limitingNutrient = findLimitingNutrient()

    if limitingNutrient:
        nutrientName = nutrientNames[limitingNutrient["name"]] or limitingNutrient["name"]
        recommendations.append({
            "title": f"Corregir deficiencia de {nutrientName}",
            "description": f"El {nutrientName} es el nutriente limitante según la Ley de Liebig. Está al limitingNutrient['percentage']% del nivel óptimo.",
            "priority": "alta",
            "action": "Aplicar fertilizante foliar rico en {nutrientName}" if limitingNutrient["type"] == "foliar" else f"Incorporar {nutrientName} al suelo mediante fertilización",
        })

    phStatus = getNutrientStatus(analysisData["soil"]["ph"], optimalLevels["soil"]["ph"]["min"], optimalLevels["soil"]["ph"]["max"])
    if phStatus != "óptimo":
        recommendations.append({
            "title": "Corregir acidez del suelo" if phStatus == "deficiente" else "Reducir alcalinidad del suelo",
            "description": f"El pH actual ({analysisData['soil']['ph']}) está {'por debajo' if phStatus == 'deficiente' else 'por encima'} del rango óptimo.",
            "priority": "media",
            "action": "Aplicar cal agrícola para elevar el pH" if phStatus == "deficiente" else "Aplicar azufre elemental o materia orgánica para reducir el pH",
        })

    moStatus = getNutrientStatus(analysisData["soil"]["materiaOrganica"], optimalLevels["soil"]["materiaOrganica"]["min"], optimalLevels["soil"]["materiaOrganica"]["max"])
    if moStatus == "deficiente":
        recommendations.append({
            "title": "Aumentar materia orgánica",
            "description": f"El nivel de materia orgánica ({analysisData['soil']['materiaOrganica']}%) está por debajo del óptimo.",
            "priority": "media",
            "action": "Incorporar compost, estiércol bien descompuesto o abonos verdes",
        })

    return recommendations

limitingNutrient = findLimitingNutrient()
recommendations = generateRecommendations()
</code></pre>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>