{% macro get_nutrient_status(actual, min, max) %}
  {% if actual < min %}
    deficiente
  {% elif actual > max %}
    excesivo
  {% else %}
    óptimo
  {% endif %}
{% endmacro %}

{% macro get_status_color(status) %}
  {% if status == "deficiente" %}
    text-red-500
  {% elif status == "excesivo" %}
    text-yellow-500
  {% elif status == "óptimo" %}
    text-green-500
  {% else %}
    ""
  {% endif %}
{% endmacro %}

{% set button_class_report = "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm dark:text-black" %}

{% macro get_status_icon(status) %}
  {% if status == "deficiente" %}
    <svg class="h-4 w-4 text-red-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path stroke-linecap="round" stroke-linejoin="round" d="M10.29 3.86a2.82 2.82 0 013.42 0l7.46 5.7a2.82 2.82 0 011 2.24v6.27a2.82 2.82 0 01-1 2.24l-7.46 5.7a2.82 2.82 0 01-3.42 0l-7.46-5.7a2.82 2.82 0 01-1-2.24v-6.27a2.82 2.82 0 011-2.24z"></path>
    </svg>
  {% elif status == "excesivo" %}
    <svg class="h-4 w-4 text-yellow-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path stroke-linecap="round" stroke-linejoin="round" d="M10.29 3.86a2.82 2.82 0 013.42 0l7.46 5.7a2.82 2.82 0 011 2.24v6.27a2.82 2.82 0 01-1 2.24l-7.46 5.7a2.82 2.82 0 01-3.42 0l-7.46-5.7a2.82 2.82 0 01-1-2.24v-6.27a2.82 2.82 0 011-2.24z"></path>
    </svg>
  {% elif status == "óptimo" %}
    <svg class="h-4 w-4 text-green-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
    </svg>
  {% else %}
    ""
  {% endif %}
{% endmacro %}


{% extends "base.j2" %}
 {% block extra_css %}

    {{ css_code|safe }}
    {{ super() }}
<style>
    .tabs-trigger {
        padding: 0.5rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.25rem;
        background-color: #f8fafc;
        cursor: pointer;
        transition: background-color 0.3s, border-color 0.3s;
    }

    .tabs-trigger.active {
        border-bottom: 2px solid #68d391;
        background-color: #f0fff4;
    }

    .tabs-content {
        display: none;
    }

    .tabs-content:not(.hidden) {
        display: block;
    }
</style>{% endblock %}
{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">


    <div id="report-content" class="container mx-auto p-6">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold">Análisis y Recomendaciones - ver_reporte2.j2</h1>
                <p class="text-sm text-indigo-600">
                    Finca: {{ analysisData.common.finca }} | Lote: {{ analysisData.common.lote }} | Fecha: {{ analysisData.common.fechaAnalisis }}
                </p>
            </div>
            <div class="flex gap-2">
                <button id="btnExportPDF" class="inline-flex items-center gap-2 rounded-md border border-transparent px-3 py-2 text-sm font-medium leading-4 text-white shadow-sm bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="12 2 2 7.86 12 12"></polyline><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                    Exportar
                </button>

            </div>
        </div>
        <div class="inline-flex h-10 items-center justify-center rounded-md bg-zinc-100 p-1 text-muted-foreground mb-4">
            <button class="{{ button_class_report }} tabs-trigger active" data-target="#dashboard">Resumen</button>
            <button class="{{ button_class_report }} tabs-trigger" data-target="#foliar">Análisis Foliar</button>
            <button class="{{ button_class_report }} tabs-trigger" data-target="#soil">Análisis de Suelo</button>
            <button class="{{ button_class_report }} tabs-trigger" data-target="#recommendations">Recomendaciones</button>
            <button class="{{ button_class_report }} tabs-trigger" data-target="#history">Histórico</button>
        </div>
        
        <div id="dashboard" class="tabs-content">
            <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">

                <div class="border p-4 rounded-lg">
                    <div class="pb-2">
                        <h2 class="text-lg font-bold">Estado General</h2>
                        <p class="text-muted-foreground">
                            Basado en análisis foliar y de suelo
                        </p>
                    </div>
                    <div>
                        <div class="flex items-center justify-between">
                            <div class="text-2xl font-bold">{% if limitingNutrient %}Requiere atención{% else %}Óptimo{% endif %}</div>
                            <div>
                                {% if limitingNutrient %}
                                    <span class="inline-block rounded-full px-2.5 py-0.5 text-sm font-semibold text-red-800 bg-red-100">Nutriente limitante detectado</span>
                                {% else %}
                                    <span class="inline-block rounded-full px-2.5 py-0.5 text-sm font-semibold text-green-800 bg-green-100">Equilibrado</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="border p-4 rounded-lg">
                    <div class="pb-2">
                        <h2 class="text-lg font-bold">Ley del Mínimo de Liebig</h2>
                        <p class="text-muted-foreground">
                            El factor más limitante determina el crecimiento
                        </p>
                    </div>
                    <div>
                        {% if limitingNutrient %}
                            <div class="space-y-2">
                                <div class="text-sm text-muted-foreground">Nutriente limitante:</div>
                                <div class="text-xl font-semibold">
                                    {{ nutrientNames[limitingNutrient.name] or limitingNutrient.name }}
                                </div>
                                <div class="w-full bg-gray-200 h-2 mb-4 rounded-full">
                                    <div class="h-2 rounded-full" style="width: {{ limitingNutrient.percentage }}%; background-color: hsl(var(--color-actual))"></div>
                                </div>
                                <div class="text-sm text-muted-foreground">
                                    {{ limitingNutrient.percentage|round }}% del nivel óptimo
                                </div>
                            </div>
                        {% else %}
                            <div class="flex items-center justify-center h-20 text-green-500">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="12 2 2 7.86 12 12"></polyline><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                <span>No se detectaron limitantes críticos</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="border p-4 rounded-lg">
                    <div class="pb-2">
                        <h2 class="text-lg font-bold">Recomendaciones Principales</h2>
                        <p class="text-muted-foreground">
                            Acciones prioritarias
                        </p>
                    </div>
                    <div>
                        {% if recommendations | length > 0 %}
                            <ul class="space-y-2">
                                {% for rec in recommendations[:2] %}
                                    <li class="flex items-start gap-2">
                                        <div class="mt-0.5">
                                            {% if rec.priority == 'alta' %}
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-red-500"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                            {% else %}
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-yellow-500"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                            {% endif %}
                                        </div>
                                        <div class="text-sm">
                                            {{ rec.title }}
                                        </div>
                                    </li>
                                {% endfor %}
                                {% if recommendations | length > 2 %}
                                    <button class="inline-flex items-center gap-2 rounded-md border border-transparent px-3 py-2 text-sm font-medium leading-4 text-white shadow-sm bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" type="button">
                                        Ver todas ({{ recommendations | length }})
                                    </button>
                                {% endif %}
                            </ul>
                        {% else %}
                            <div class="flex items-center justify-center h-20 text-green-500">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="12 2 2 7.86 12 12"></polyline><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                <span>No se requieren acciones inmediatas</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="border p-4 rounded-lg">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-green-500"><path d="M16 17l5-5l-5-5M2 12h6"></path><path d="M18 17v-1a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v1"></path></svg>
                        <h2 class="text-lg font-bold">Análisis Foliar</h2>
                    </div>
                    <p class="text-muted-foreground">
                        Comparación con niveles óptimos
                    </p>
                    <canvas id="foliarChart" class="h-80"></canvas>
                </div>
                <div class="border p-4 rounded-lg">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-amber-500"><path d="M12 1V22a10 10 0 1 1-5.93-9.14"></path><polyline points="12 2 2 7.86 12 12"></polyline><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                        <h2 class="text-lg font-bold">Análisis de Suelo</h2>
                    </div>
                    <p class="text-muted-foreground">
                        Comparación con niveles óptimos
                    </p>
                    <canvas id="soilChart" class="h-80"></canvas>
                </div>
            </div>
            <div class="border p-4 rounded-lg">
                <div class="flex items-center">
                    <h2 class="text-lg font-bold">Ley del Mínimo de Liebig - Visualización</h2>
                    <p class="text-muted-foreground">
                        El crecimiento está limitado por el nutriente que se encuentra en menor cantidad relativa a las necesidades del cultivo
                    </p>
                </div>
                <div class="flex flex-col md:flex-row gap-6 items-center">
                    <div class="w-full md:w-1/2">
                        <div class="relative h-64 w-full border rounded-lg overflow-hidden bg-gradient-to-b from-blue-50 to-green-50">
                            <!-- Barril de Liebig (visualización) -->
                            <div class="absolute inset-x-0 bottom-0 h-12 bg-green-800"></div>
                            <!-- Duelas del barril -->
                            <div class="absolute inset-0 flex justify-around">
                                {% for nutrient in foliarChartData %}
                                    {% if (nutrient.min + nutrient.max) > 0 %}
                                    {% set percentage = (nutrient.actual / ((nutrient.min + nutrient.max) / 2)) * 100 %}
                                    {% else %}
                                    {% set percentage = 0 %}
                                    {% endif %}
                                    {% set isLimiting = limitingNutrient and limitingNutrient.name == nutrient.name %}
                                    <div class="relative h-full w-8 flex flex-col justify-end items-center">
                                        <div
                                            class="w-6 rounded-t-md {{ 'bg-red-500' if isLimiting else 'bg-blue-500' }}"
                                            style="height: 30%;">
                                        </div>
                                        <div class="absolute bottom-14 transform -rotate-45 text-xs font-bold">
                                            {{ nutrient.name }}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            <!-- Nivel de agua (limitado por el nutriente más bajo) -->
                            {% if limitingNutrient %}
                                <div
                                    class="absolute inset-x-0 bg-blue-300 opacity-70"
                                    style="bottom: {{ 3 + (limitingNutrient.percentage * 0.5) }}%; height: 5%;">
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="w-full md:w-1/2 space-y-4">
                        <h3 class="text-lg font-semibold mb-2">Principio de la Ley del Mínimo</h3>
                        <p class="text-muted-foreground">
                            Propuesta por Justus von Liebig en 1840, esta ley establece que el crecimiento de una planta no está determinado por la cantidad total de recursos disponibles, sino por el recurso más escaso (factor limitante).
                        </p>
                        {% if limitingNutrient %}
                            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-red-500"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                <div class="mt-2">
                                    <h3 class="text-red-700 text-lg font-semibold">Factor limitante detectado</h3>
                                    <p class="text-red-600">
                                        El {{ nutrientNames[limitingNutrient.name] or limitingNutrient.name }} está actuando como factor limitante al {{ limitingNutrient.percentage|round }}% del nivel óptimo. Corregir esta deficiencia debería ser prioritario.
                                    </p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div id="foliar" class="tabs-content hidden">
            {% if analysisData.foliar %}
            <div class="mb-4 border p-4 rounded-lg">
                <div class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-green-500"><path d="M16 17l5-5l-5-5M2 12h6"></path><path d="M18 17v-1a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v1"></path></svg>
                    <h2 class="text-lg font-bold">Análisis Foliar Detallado</h2>
                </div>
                <p class="text-muted-foreground">
                    Resultados del análisis foliar realizado el {{ analysisData.common.fechaAnalisis }}
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Macronutrientes (%)</h3>
                        <div class="space-y-4">
                            {% for key, value in analysisData.foliar.items() %}
                                {% if key in ['nitrogeno', 'fosforo', 'potasio', 'calcio', 'magnesio', 'azufre'] and key in optimalLevels.foliar %}
                                    {% set status = get_nutrient_status(value, optimalLevels.foliar[key].min, optimalLevels.foliar[key].max) %}
                                    {% set statusColor = get_status_color(status) %}
                                    {% set percentage = (value / ((optimalLevels.foliar[key].min + optimalLevels.foliar[key].max) / 2)) * 100 %}
                                    <div class="space-y-1">
                                        <div class="flex justify-between items-center">
                                            <div class="flex items-center">
                                                {{ get_status_icon(status)|safe }}
                                                <span class="ml-2">{{ nutrientNames[key] or key }}</span>
                                            </div>
                                            <div class="{{ statusColor }} font-semibold">
                                                {{ value }}%
                                                <span class="text-xs font-normal text-muted-foreground">
                                                    ({{ optimalLevels.foliar[key].min }}-{{ optimalLevels.foliar[key].max }}%)
                                                </span>
                                            </div>
                                        </div>
                                        <div class="w-full bg-gray-200 h-2 mb-4 rounded-full">
                                            <div class="h-2 rounded-full" style="width: {{ percentage }}%; background-color: hsl(var(--color-actual))"></div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Micronutrientes (ppm)</h3>
                        <div class="space-y-4">
                            {% for key, value in analysisData.foliar.items() %}
                                {% if key in ['hierro', 'manganeso', 'zinc', 'cobre', 'boro'] and key in optimalLevels.foliar %}

                                    {% set status = get_nutrient_status(value, optimalLevels.foliar[key].min, optimalLevels.foliar[key].max)  %}
                                    {% set statusColor = get_status_color(status) %}
                                    {% set percentage = (value / ((optimalLevels.foliar[key].min + optimalLevels.foliar[key].max) / 2)) * 100 %}
                                    <div class="space-y-1">
                                        <div class="flex justify-between items-center">
                                            <div class="flex items-center">
                                                {{ get_status_icon(status)|safe }}
                                                <span class="ml-2">{{ nutrientNames[key] or key }}</span>
                                            </div>
                                            <div class="{{ statusColor }} font-semibold">
                                                {{ value }} ppm
                                                <span class="text-xs font-normal text-muted-foreground">
                                                    ({{ optimalLevels.foliar[key].min }}-{{ optimalLevels.foliar[key].max }} ppm)
                                                </span>
                                            </div>
                                        </div>
                                        <div class="w-full bg-gray-200 h-2 mb-4 rounded-full">
                                            <div class="h-2 rounded-full" style="width: {{ percentage }}%; background-color: hsl(var(--color-actual))"></div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="border p-4 rounded-lg">
                <div class="flex items-center">
                    <h2 class="text-lg font-bold">Interpretación del Análisis Foliar</h2>
                    <p class="text-muted-foreground">
                        Evaluación de los resultados según estándares para el cultivo
                    </p>
                </div>
                <div>
                    {% if limitingNutrient and limitingNutrient.type == 'foliar' %}
                        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-red-500"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                            <div class="mt-2">
                                <h3 class="text-red-700 font-semibold">Nutriente Limitante Detectado</h3>
                                <p class="text-red-600">
                                    El {{ nutrientNames[limitingNutrient.name] or limitingNutrient.name }} está actuando como factor limitante según la Ley de Liebig. Su nivel actual ({{ limitingNutrient.value }}%) está por debajo del óptimo.
                                </p>
                            </div>
                        </div>
                    {% endif %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h3 class="text-md font-semibold mb-2">Deficiencias</h3>
                            <ul class="space-y-2">
                                {% for key, value in analysisData.foliar.items() %}
                                    {% if key in optimalLevels.foliar and value < optimalLevels.foliar[key].min %}
                                        <li class="flex items-start gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-red-500 mt-0.5"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                            <div>
                                                <span class="font-medium">{{ nutrientNames[key] or key }}:</span> {{ value }}% (Mínimo recomendado: {{ optimalLevels.foliar[key].min }}%)
                                            </div>
                                        </li>
                                    {% endif %}
                                {% endfor %}
                                    {% if not (analysisData.foliar|selectattr('is_deficiente', test='attr')|list|length > 0) %}
                                        <li class="text-green-600 flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 mr-2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="12 2 2 7.86 12 12"></polyline><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                            No se detectaron deficiencias significativas
                                        </li>
                                    {% endif %}

                            </ul>
                        </div>
                        <div>
                            <h3 class="text-md font-semibold mb-2">Excesos</h3>
                            <ul class="space-y-2">
                                {% for key, value in analysisData.foliar.items() %}
                                    {% if key in optimalLevels.foliar and value > optimalLevels.foliar[key].max %}
                                        <li class="flex items-start gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-yellow-500 mt-0.5"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                            <div>
                                                <span class="font-medium">{{ nutrientNames[key] or key }}:</span> {{ value }}% (Máximo recomendado: {{ optimalLevels.foliar[key].max }}%)
                                            </div>
                                        </li>
                                        {% endif %}
                                    {% endfor %}
                                    {% if not (analysisData.foliar|selectattr('is_excesivo', test='attr')|list|length > 0) %}
                                        <li class="text-green-600 flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 mr-2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="12 2 2 7.86 12 12"></polyline><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                            No se detectaron excesos significativos
                                        </li>
                                    {% endif %}

                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <p class="text-red-500">No hay datos de análisis foliar disponibles.</p>
            {% endif %}
        </div>
        <div id="soil" class="tabs-content hidden">
            {% if analysisData.soil %}

 <div class="mb-4 border p-4 rounded-lg">
        <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-amber-500"><path d="M12 1V22a10 10 0 1 1-5.93-9.14"></path><polyline points="12 2 2 7.86 12 12"></polyline><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
            <h2 class="text-lg font-bold">Análisis de Suelo Detallado</h2>
        </div>
        <p class="text-muted-foreground">
            Resultados del análisis de suelo realizado el {{ analysisData.common.fechaAnalisis }}
        </p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h3 class="text-lg font-semibold mb-4">Propiedades Físico-Químicas</h3>
                <div class="space-y-4">
                        {% for item in [{'key': 'ph', 'label': 'pH', 'unit': ''},
                                    {'key': 'materiaOrganica', 'label': 'Materia Orgánica', 'unit': '%'},
                                    {'key': 'textura', 'label': 'Textura', 'unit': ''},
                                    {'key': 'cic', 'label': 'CIC', 'unit': 'meq/100g'}] %}
                        {% if item.key == 'textura' %}
                            <div class="space-y-1">
                                <div class="flex justify-between items-center">
                                    <span>{{ item.label }}</span>
                                    <span class="font-semibold">{{ analysisData.soil[item.key] if item.key in analysisData.soil else 'N/A' }}</span>
                                </div>
                            </div>
                        {% elif analysisData.soil and optimalLevels.soil and item.key in analysisData.soil and item.key in optimalLevels.soil %}
                            {% set status = get_nutrient_status(analysisData.soil[item.key], optimalLevels.soil[item.key].min, optimalLevels.soil[item.key].max) %}
                            {% set statusColor = get_status_color(status) %}
                            {% set percentage = (analysisData.soil[item.key] / ((optimalLevels.soil[item.key].min + optimalLevels.soil[item.key].max) / 2)) * 100 %}
                            <div class="space-y-1">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        {{ get_status_icon(status)|safe }}
                                        <span class="ml-2">{{ nutrientNames[item.key] or item.key }}</span>
                                    </div>
                                    <div class="{{ statusColor }} font-semibold">
                                        {{ analysisData.soil[item.key] }}
                                        {{ item.unit if item.unit }}
                                        <span class="text-xs font-normal text-muted-foreground">
                                            ({{ optimalLevels.soil[item.key].min }}-{{ optimalLevels.soil[item.key].max }}{{ item.unit if item.unit }})
                                        </span>
                                    </div>
                                </div>
                                <div class="w-full bg-gray-200 h-2 mb-4 rounded-full">
                                    <div class="h-2 rounded-full" style="width: {{ percentage|round(2) }}%; background-color: hsl(var(--color-actual))"></div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            <div>
                <h3 class="text-lg font-semibold mb-4">Nutrientes del Suelo</h3>
                <div class="space-y-4">
                    {% for item in [{'key': 'nitrogeno', 'label': 'Nitrógeno', 'unit': '%'},
                                    {'key': 'fosforo', 'label': 'Fósforo', 'unit': 'ppm'},
                                    {'key': 'potasio', 'label': 'Potasio', 'unit': 'ppm'},
                                    {'key': 'calcio', 'label': 'Calcio', 'unit': 'ppm'},
                                    {'key': 'magnesio', 'label': 'Magnesio', 'unit': 'ppm'},
                                    {'key': 'azufre', 'label': 'Azufre', 'unit': 'ppm'}] %}
                        {% if analysisData.soil and optimalLevels.soil and item.key in analysisData.soil and item.key in optimalLevels.soil %}
                            <div class="space-y-1">
                                {% set status = get_nutrient_status(analysisData.soil[item.key], optimalLevels.soil[item.key].min, optimalLevels.soil[item.key].max) %}
                                {% set statusColor = get_status_color(status) %}
                                {% set percentage = (analysisData.soil[item.key] / ((optimalLevels.soil[item.key].min + optimalLevels.soil[item.key].max) / 2)) * 100 %}
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        {{ get_status_icon(status)|safe }}
                                        <span class="ml-2">{{ nutrientNames[item.key] or item.key }}</span>
                                    </div>
                                    <div class="{{ statusColor }} font-semibold">
                                        {{ analysisData.soil[item.key] }}
                                        {{ item.unit if item.unit }}
                                        <span class="text-xs font-normal text-muted-foreground">
                                            ({{ optimalLevels.soil[item.key].min }}-{{ optimalLevels.soil[item.key].max }}{{ item.unit if item.unit }})
                                        </span>
                                    </div>
                                </div>
                                <div class="w-full bg-gray-200 h-2 mb-4 rounded-full">
                                    <div class="h-2 rounded-full" style="width: {{ percentage|round(2) }}%; background-color: hsl(var(--color-actual))"></div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>




            <div class="mb-4 border p-4 rounded-lg">
                <div class="flex items-center">
                    <h2 class="text-lg font-bold">Interpretación del Análisis de Suelo</h2>
                    <p class="text-muted-foreground">
                        Evaluación de los resultados según estándares para el cultivo
                    </p>
                </div>
                <div>
                    {% if limitingNutrient and limitingNutrient.type == 'soil' %}
                        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-red-500"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                            <div class="mt-2">
                                <h3 class="text-red-700 font-semibold">Nutriente Limitante Detectado</h3>
                                <p class="text-red-600">
                                    El {{ nutrientNames[limitingNutrient.name] or limitingNutrient.name }} en el suelo está actuando como factor limitante según la Ley de Liebig. Su nivel actual está por debajo del óptimo.
                                </p>
                            </div>
                        </div>
                    {% endif %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h3 class="text-md font-semibold mb-2">Deficiencias</h3>
                            <ul class="space-y-2">
                                {% for key, value in analysisData.soil.items() %}
                                    {% if key in optimalLevels.soil and key != 'ph' and key != 'textura' and value < optimalLevels.soil[key].min %}
                                        <li class="flex items-start gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-red-500 mt-0.5"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                            <div>
                                                <p>
                                                    <span class="font-medium">{{ nutrientNames[key] or key }}:</span> {{ value }}%
                                                    (Mínimo recomendado: {{ optimalLevels.soil[key].min }}%)
                                                </p>
                                            </div>
                                        </li>
                                        {% endif %}
                                    {% endfor %}
                                    {% if not (analysisData.soil|selectattr('is_deficiente', test='attr')|list|length > 0) %}
                                        <li class="text-green-600 flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 mr-2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="12 2 2 7.86 12 12"></polyline><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                            No se detectaron deficiencias significativas
                                        </li>
                                    {% endif %}
                            </ul>
                        </div>
                        <div>
                            {% set ph_value = analysisData.soil.get('ph') %}
                            <h3 class="text-md font-semibold mb-2">Problemas de pH</h3>
                            {% if ph_value is not none and ph_value < optimalLevels.soil.ph.min %}
                                <div class="flex items-start gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-red-500 mt-0.5"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                    <div>
                                        <p>
                                            <span class="font-medium">Suelo ácido (pH {{ ph_value }})</span>
                                        </p>
                                        <p class="text-sm text-muted-foreground">
                                            Puede limitar la disponibilidad de nutrientes como fósforo, calcio y magnesio. Considere aplicar cal agrícola para elevar el pH.
                                        </p>
                                    </div>
                                </div>
                            {% elif ph_value is not none and ph_value > optimalLevels.soil.ph.max %}
                                <div class="flex items-start gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-yellow-500 mt-0.5"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                    <div>
                                        <p>
                                            <span class="font-medium">Suelo alcalino (pH {{ ph_value }})</span>
                                        </p>
                                        <p class="text-sm text-muted-foreground">
                                            Puede limitar la disponibilidad de micronutrientes como hierro, manganeso y zinc. Considere aplicar azufre elemental o materia orgánica para reducir el pH.
                                        </p>
                                    </div>
                                </div>
                            {% elif ph_value is not none %}
                                <div class="flex items-center text-green-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 mr-2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="12 2 2 7.86 12 12"></polyline><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                    <span>pH óptimo para la mayoría de cultivos ({{ ph_value }})</span>
                                </div>
                            {% else %}
                                <div class="flex items-center text-muted-foreground">
                                    <span>pH no disponible</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="mb-4  border p-4 rounded-lg">
                <div class="flex items-center">
                    <h2 class="text-lg font-bold">Interpretación del Análisis de Suelo</h2>
                </div>
                <div class="space-y-4">
                    {% if ph_value is not none %}
                        {{ get_status_icon(get_nutrient_status(ph_value, optimalLevels.soil.ph.min, optimalLevels.soil.ph.max))|safe }}
                    {% endif %}
                    <p>
                        La Ley del Mínimo de Liebig, formulada por el químico alemán Justus von Liebig en 1840, establece que el crecimiento de una planta no está determinado por la cantidad total de recursos disponibles, sino por el recurso más escaso (factor limitante).
                    </p>
                    <p>
                        Esta ley se ilustra comúnmente con un barril con duelas de diferentes alturas, donde cada duela representa un nutriente. El nivel de agua en el barril (que representa el crecimiento potencial) está limitado por la duela más corta, independientemente de cuán altas sean las demás.
                    </p>
                    <p>En términos prácticos, esto significa que:</p>
                    <ul class="list-disc pl-6 space-y-2">
                        <li>
                            Aumentar la disponibilidad de nutrientes que ya están en niveles adecuados tendrá poco o ningún efecto en el rendimiento.
                        </li>
                        <li>
                            El mayor impacto se logra identificando y corrigiendo el factor limitante (el nutriente más deficiente).
                        </li>
                        <li>
                            Una vez corregido un factor limitante, otro nutriente puede convertirse en el nuevo factor limitante.
                        </li>
                    </ul>
                    <p>
                        Las recomendaciones proporcionadas se basan en este principio, priorizando la corrección de los factores más limitantes para maximizar el rendimiento del cultivo.
                    </p>
                </div>
            </div>
            {% else %}
            <p class="text-red-500">No hay datos de análisis de suelo disponibles.</p>
            {% endif %}
        </div>
        <div id="recommendations" class="tabs-content hidden">
            <div class="mb-4  border p-4 rounded-lg">
                <div class="flex items-center">
                    <h2 class="text-lg font-bold">Recomendaciones Basadas en la Ley de Liebig</h2>
                    <p class="text-muted-foreground">
                        Acciones prioritarias para optimizar el rendimiento del cultivo
                    </p>
                </div>
                <div>
                    {% if recommendations | length > 0 %}
                        {% for rec in recommendations %}
                            <div class="border rounded-lg p-4 space-y-2 mb-4">
                                <div class="flex items-center gap-2">
                                    <span class="inline-block rounded-full px-2.5 py-0.5 text-sm font-semibold {% if rec.priority == 'alta' %}bg-red-100 text-red-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                        Prioridad {{ rec.priority }}
                                    </span>
                                    <h3 class="text-lg font-semibold">{{ rec.title }}</h3>
                                </div>
                                <p class="text-muted-foreground">
                                    {{ rec.description }}
                                </p>
                                <div class="flex items-center gap-2 pt-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 text-primary"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline><line x1="14" y1="14" x2="22" y2="6"></line></svg>
                                    <span class="font-medium">{{ rec.action }}</span>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="flex items-center justify-center py-8">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-12 w-12 text-green-500 mb-4"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="12 2 2 7.86 12 12"></polyline><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                            <span>No se requieren acciones inmediatas</span>
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="mb-4  border p-4 rounded-lg">
                <div class="flex items-center">
                    <h2 class="text-lg font-bold">Explicación de la Ley de Liebig</h2>
                </div>
                <div class="space-y-4">
                    <p>
                        La Ley del Mínimo de Liebig, formulada por el químico alemán Justus von Liebig en 1840, establece que el crecimiento de una planta no está determinado por la cantidad total de recursos disponibles, sino por el recurso más escaso (factor limitante).
                    </p>
                    <p>
                        Esta ley se ilustra comúnmente con un barril con duelas de diferentes alturas, donde cada duela representa un nutriente. El nivel de agua en el barril (que representa el crecimiento potencial) está limitado por la duela más corta, independientemente de cuán altas sean las demás.
                    </p>
                    <p>En términos prácticos, esto significa que:</p>
                    <ul class="list-disc pl-6 space-y-2">
                        <li>
                            Aumentar la disponibilidad de nutrientes que ya están en niveles adecuados tendrá poco o ningún efecto en el rendimiento.
                        </li>
                        <li>
                            El mayor impacto se logra identificando y corrigiendo el factor limitante (el nutriente más deficiente).
                        </li>
                        <li>
                            Una vez corregido un factor limitante, otro nutriente puede convertirse en el nuevo factor limitante.
                        </li>
                    </ul>
                    <p>
                        Las recomendaciones proporcionadas se basan en este principio, priorizando la corrección de los factores más limitantes para maximizar el rendimiento del cultivo.
                    </p>
                </div>
            </div>
        </div>
        <div id="history" class="tabs-content hidden">
            <div class="mb-4 border p-4 rounded-lg">
                <div class="flex items-center">
                    <h2 class="text-lg font-bold">Histórico de Análisis</h2>
                    <p class="text-muted-foreground">
                        Evolución de los principales parámetros a lo largo del tiempo
                    </p>
                </div>
                <canvas id="historyChart" class="h-80"></canvas>
                <div class="mt-6">
                    <h3 class="text-lg font-semibold mb-4">Tendencias Observadas</h3>
                    <ul class="space-y-2">
                        <li class="flex items-start gap-2">
                            <div class="w-3 h-3 rounded-full" style="background-color: hsl(var(--color-nitrogeno));"></div>
                            <div>
                                <p class="font-medium">Nitrógeno</p>
                                <p class="text-sm text-muted-foreground">
                                    Incremento gradual del 2.3% al 2.5% en los últimos 3 meses, pero aún por debajo del nivel óptimo.
                                </p>
                            </div>
                        </li>
                        <li class="flex items-start gap-2">
                            <div class="w-3 h-3 rounded-full" style="background-color: hsl(var(--color-fosforo));"></div>
                            <div>
                                <p class="font-medium">Fósforo</p>
                                <p class="text-sm text-muted-foreground">
                                    Niveles estables dentro del rango óptimo, con ligero incremento de 0.25% a 0.3%.
                                </p>
                            </div>
                        </li>
                        <li class="flex items-start gap-2">
                            <div class="w-3 h-3 rounded-full" style="background-color: hsl(var(--color-potasio));"></div>
                            <div>
                                <p class="font-medium">Potasio</p>
                                <p class="text-sm text-muted-foreground">
                                    Incremento constante de 1.5% a 1.8%, pero aún por debajo del nivel óptimo mínimo de 2.0%.
                                </p>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>



    </div>
</div>
{% endblock %}
    {% block extra_js %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Configuración de gráficos de análisis foliar
            const foliarChartCtx = document.getElementById('foliarChart').getContext('2d');
            const chartColors = {
                actual: 'rgba(59, 130, 246, 0.7)',    // Blue-500
                min: 'rgba(239, 68, 68, 0.5)',      // Red-500
                max: 'rgba(245, 158, 11, 0.5)',     // Amber-500
            };
            new Chart(foliarChartCtx, {
                type: 'bar',
                data: {
                    labels: {{ foliarChartData|map(attribute='name')|list|tojson }},
                    datasets: [
                        {
                            label: 'Nivel Actual',
                            data: {{ foliarChartData|map(attribute='actual')|list|tojson }},
                            backgroundColor: chartColors.actual,
                        },
                        {
                            label: 'Nivel Mínimo',
                            data: {{ foliarChartData|map(attribute='min')|list|tojson }},
                            backgroundColor: chartColors.min,
                        },
                        {
                            label: 'Nivel Máximo',
                            data: {{ foliarChartData|map(attribute='max')|list|tojson }},
                            backgroundColor: chartColors.max,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Niveles de Nutrientes Folares'
                        }
                    }
                }
            });

            // Configuración de gráficos de análisis de suelo
            const soilChartCtx = document.getElementById('soilChart').getContext('2d');
            new Chart(soilChartCtx, {
                type: 'bar',
                data: {
                    labels: {{ soilChartData|map(attribute='name')|list|tojson }},
                    datasets: [
                        {
                            label: 'Nivel Actual',
                            data: {{ soilChartData|map(attribute='actual')|list|tojson }},
                            backgroundColor: 'hsl(var(--chart-1))',
                        },
                        {
                            label: 'Nivel Mínimo',
                            data: {{ soilChartData|map(attribute='min')|list|tojson }},
                            backgroundColor: 'hsl(var(--chart-3))',
                        },
                        {
                            label: 'Nivel Máximo',
                            data: {{ soilChartData|map(attribute='max')|list|tojson }},
                            backgroundColor: 'hsl(var(--chart-4))',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Niveles de Nutrientes de Suelo'
                        }
                    }
                }
            });

            // Configuración de gráficos histórico
            const historyChartCtx = document.getElementById('historyChart').getContext('2d');
            new Chart(historyChartCtx, {
                type: 'line',
                data: {
                    labels: {{ historicalData|map(attribute='fecha')|list|tojson }},
                    datasets: [
                        {
                            label: 'Nitrógeno',
                            data: {{ historicalData|map(attribute='nitrogeno')|list|tojson }},
                            fill: false,
                            borderColor: 'hsl(var(--color-nitrogeno))',
                            tension: 0.1
                        },
                        {
                            label: 'Fósforo',
                            data: {{ historicalData|map(attribute='fosforo')|list|tojson }},
                            fill: false,
                            borderColor: 'hsl(var(--color-fosforo))',
                            tension: 0.1
                        },
                        {
                            label: 'Potasio',
                            data: {{ historicalData|map(attribute='potasio')|list|tojson }},
                            fill: false,
                            borderColor: 'hsl(var(--color-potasio))',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Historial de Análisis'
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Fecha'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Nivel (%)'
                            }
                        }
                    }
                }
            });

            // Manejo de tabs
            const tabs = document.querySelectorAll('.tabs-trigger');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    const targetContent = document.querySelector(this.getAttribute('data-target'));
                    document.querySelectorAll('.tabs-content').forEach(content => content.classList.add('hidden'));
                    targetContent.classList.remove('hidden');
                });
            });

            const exportBtn = document.getElementById('btnExportPDF');
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'pt', 'a4');
                    const element = document.getElementById('report-content');
                    html2canvas(element).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const imgProps = doc.getImageProperties(imgData);
                        const pdfWidth = doc.internal.pageSize.getWidth();
                        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                        doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                        doc.save('reporte.pdf');
                    });
                });
            }
        });
    </script>

    {% endblock %}
    